<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Too Turned Triviaâ„¢</title>
    <meta name="description" content="Online multiplayer trivia with 6 unique game modes">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 rotate=%22-15%22>ðŸŽ¯</text></svg>">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --black: #000000;
            --white: #FFFFFF;
            --yellow: #FFDE21;
            --yellow-dark: #E6C500;
            --gray-900: #0F0F0F;
            --gray-800: #1A1A1A;
            --gray-700: #2D2D2D;
            --gray-600: #404040;
            --gray-500: #666666;
            --gray-400: #9E9E9E;
            --purple: #6C5CE7;
            --red: #FF7675;
            --orange: #FDCB6E;
            --green: #00B894;
            --cyan: #00CEC9;
            --pink: #FD79A8;
            
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            --radius-lg: 18px;
            --radius-md: 12px;
            
            --shadow-card: 0 8px 20px rgba(0, 0, 0, 0.12);
            --shadow-card-hover: 0 12px 30px rgba(0, 0, 0, 0.25);
        }

        /* Light mode variables - DARKER GREYS */
        :root.light-mode {
            --black: #FFFFFF;
            --white: #000000;
            --gray-900: #F0F0F0;
            --gray-800: #E0E0E0;
            --gray-700: #D0D0D0;
            --gray-600: #C0C0C0;
            --gray-500: #909090;
            --gray-400: #606060;
            --shadow-card: 0 8px 20px rgba(0, 0, 0, 0.08);
            --shadow-card-hover: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--black);
            color: var(--white);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* ===== LOADING SCREEN ===== */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--black);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .loading-logo {
            font-size: 80px;
            font-weight: 900;
            color: var(--yellow);
            animation: pulse 2s infinite;
            transform: rotate(-15deg);
            margin-bottom: var(--space-xl);
        }

        .loading-progress {
            width: min(300px, 90vw);
            height: 6px;
            background: var(--gray-800);
            border-radius: 9999px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--yellow), var(--orange));
            transition: width 0.3s ease;
        }

        .loading-text {
            margin-top: var(--space-md);
            color: var(--gray-400);
            font-size: 14px;
            font-weight: 500;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: rotate(-15deg) scale(1); }
            50% { opacity: 0.7; transform: rotate(-15deg) scale(1.05); }
        }

        /* ===== PLAYER HUD ===== */
        .player-hud {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(10px);
            padding: var(--space-sm) var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 222, 33, 0.1);
            height: 60px;
            transition: background-color 0.3s;
        }

        .light-mode .player-hud {
            background: rgba(240, 240, 240, 0.95);
            border-bottom: 1px solid rgba(255, 222, 33, 0.2);
        }

        .hud-left {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .hud-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .hud-icon {
            width: 32px;
            height: 32px;
            background: var(--gray-800);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--yellow);
        }

        .hud-value {
            font-weight: 700;
            font-size: 16px;
        }

        .hud-label {
            font-size: 12px;
            color: var(--gray-400);
            margin-top: -2px;
        }

        .hud-right {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .profile-display {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .profile-pic-hud {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--purple), var(--cyan));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            overflow: hidden;
        }

        .profile-pic-hud img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ===== SCREENS ===== */
        .screen {
            display: none;
            min-height: 100vh;
            padding: 60px 0 70px; /* Top padding for HUD, bottom for nav */
            overflow-y: auto;
        }

        .screen.active {
            display: block;
        }

        .page-content {
            padding: var(--space-xl) var(--space-md);
            max-width: 1200px;
            margin: 0 auto;
            min-height: calc(100vh - 130px); /* Account for HUD and nav */
        }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 100;
            border-top: 1px solid rgba(255, 222, 33, 0.1);
            height: 70px;
            transition: background-color 0.3s;
        }

        .light-mode .bottom-nav {
            background: rgba(240, 240, 240, 0.95);
            border-top: 1px solid rgba(255, 222, 33, 0.2);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--gray-400);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            flex: 1;
            max-width: 100px;
        }

        .nav-item.active {
            color: var(--yellow);
            background: rgba(255, 222, 33, 0.1);
        }

        .nav-icon {
            font-size: 20px;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 48px;
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            gap: var(--space-sm);
        }

        .btn-primary {
            background: var(--yellow);
            color: var(--black);
        }

        .btn-primary:hover {
            background: var(--yellow-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 222, 33, 0.3);
        }

        .btn-outline {
            background: transparent;
            color: var(--yellow);
            border: 2px solid var(--yellow);
        }

        .btn-outline:hover {
            background: rgba(255, 222, 33, 0.1);
        }

        .btn-full {
            width: 100%;
        }

        .btn-lg {
            min-height: 56px;
            font-size: 18px;
            font-weight: 700;
        }

        .btn-sm {
            padding: 6px 12px;
            min-height: 36px;
            font-size: 14px;
        }

        /* ===== CARD STYLES ===== */
        .card {
            background: var(--gray-800);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-card);
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .light-mode .card {
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-lg);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: var(--space-md);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }

        .card-description {
            color: var(--gray-400);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: var(--space-md);
        }

        /* ===== HOME SCREEN ===== */
        .hero-section {
            text-align: center;
            padding: var(--space-xl) 0;
            margin-bottom: var(--space-xl);
            position: relative;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255, 222, 33, 0.1) 0%, transparent 70%);
            z-index: -1;
        }

        .hero-title {
            font-size: clamp(36px, 6vw, 48px);
            font-weight: 900;
            margin-bottom: var(--space-md);
            background: linear-gradient(135deg, var(--yellow) 0%, var(--orange) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .hero-subtitle {
            color: var(--gray-400);
            max-width: 600px;
            margin: 0 auto var(--space-xl);
            font-size: clamp(16px, 2.5vw, 20px);
        }

        .hero-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ===== GAME MODES SCREEN ===== */
        .modes-header {
            text-align: center;
            margin-bottom: var(--space-xl);
        }

        .section-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: var(--space-sm);
            background: linear-gradient(135deg, var(--yellow) 0%, var(--orange) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .section-subtitle {
            color: var(--gray-400);
            max-width: 600px;
            margin: 0 auto;
        }

        /* ===== PLAYER SETUP ===== */
        .setup-stepper {
            display: flex;
            justify-content: center;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
            position: relative;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gray-800);
            color: var(--gray-400);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: var(--yellow);
            color: var(--black);
            border-color: var(--yellow);
            box-shadow: 0 0 0 4px rgba(255, 222, 33, 0.2);
        }

        .step-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .step.active .step-label {
            color: var(--yellow);
        }

        .setup-content {
            background: var(--gray-800);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
        }

        .setup-section {
            display: none;
        }

        .setup-section.active {
            display: block;
        }

        .players-list {
            margin-bottom: var(--space-lg);
            max-height: 300px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md);
            background: var(--gray-700);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            transition: all 0.2s;
        }

        .player-item:hover {
            background: var(--gray-600);
        }

        .player-name {
            font-weight: 600;
        }

        /* ===== GAME SCREEN ===== */
        .game-header {
            background: var(--gray-800);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border: 1px solid rgba(255, 222, 33, 0.1);
        }

        .game-stats {
            display: flex;
            justify-content: space-around;
            gap: var(--space-lg);
            margin-bottom: var(--space-md);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--yellow);
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-mode-badge {
            background: var(--gray-700);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .timer-display {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .question-card {
            background: var(--gray-800);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-card);
        }

        .question-header {
            padding: var(--space-lg);
            background: linear-gradient(135deg, var(--gray-700) 0%, var(--gray-800) 100%);
            border-bottom: 1px solid var(--gray-700);
        }

        .question-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .question-category {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            color: var(--gray-400);
            font-size: 14px;
        }

        .question-text {
            padding: var(--space-lg);
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            line-height: 1.4;
        }

        .answers-grid {
            padding: var(--space-lg);
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-md);
        }

        @media (min-width: 640px) {
            .answers-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .answer-option {
            padding: var(--space-lg);
            background: var(--gray-700);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: var(--space-md);
            -webkit-user-select: none;
            user-select: none;
        }

        .answer-option:hover {
            background: var(--gray-600);
            transform: translateY(-2px);
        }

        .answer-option.selected {
            background: rgba(0, 184, 148, 0.2);
            border: 2px solid var(--green);
        }

        .answer-option.incorrect {
            background: rgba(255, 118, 117, 0.2);
            border: 2px solid var(--red);
        }

        .answer-letter {
            width: 36px;
            height: 36px;
            background: var(--gray-600);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .answer-option.selected .answer-letter {
            background: var(--green);
            color: white;
        }

        .answer-option.incorrect .answer-letter {
            background: var(--red);
            color: white;
        }

        .game-controls {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
        }

        /* ===== CATEGORIES SCREEN ===== */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--space-lg);
        }

        .category-card {
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .category-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-md);
        }

        /* ===== PROFILE SCREEN ===== */
        .profile-header {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--purple), var(--cyan));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s;
            overflow: hidden;
            position: relative;
        }

        .profile-pic:hover {
            transform: scale(1.05);
        }

        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: var(--space-sm);
            cursor: pointer;
        }

        /* ===== STATS SCREEN ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            text-align: center;
            padding: var(--space-lg);
        }

        .stat-value-lg {
            font-size: 36px;
            font-weight: 800;
            color: var(--yellow);
            margin-bottom: var(--space-sm);
        }

        .leaderboard {
            background: var(--gray-800);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md);
            border-bottom: 1px solid var(--gray-700);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            width: 36px;
            height: 36px;
            background: var(--gray-700);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        /* ===== ONLINE SCREEN ===== */
        .online-actions {
            display: flex;
            gap: var(--space-lg);
            justify-content: center;
            margin-bottom: var(--space-xl);
        }

        .lobby-container {
            background: var(--gray-800);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
        }

        .room-list {
            margin-top: var(--space-lg);
            max-height: 400px;
            overflow-y: auto;
        }

        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            background: var(--gray-700);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
        }

        /* ===== WAITING ROOM ===== */
        .waiting-room {
            text-align: center;
        }

        .room-code {
            font-size: 48px;
            font-weight: 900;
            letter-spacing: 8px;
            color: var(--yellow);
            margin: var(--space-xl) 0;
            padding: var(--space-md);
            background: var(--gray-800);
            border-radius: var(--radius-md);
            border: 2px dashed var(--yellow);
        }

        /* ===== SETTINGS SCREEN ===== */
        .settings-section {
            margin-bottom: var(--space-xl);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            background: var(--gray-800);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            cursor: pointer;
        }

        .settings-item:hover {
            background: var(--gray-700);
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-700);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--yellow);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: var(--space-md);
        }

        .light-mode .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--gray-800);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: var(--space-xl);
            text-align: center;
            border-bottom: 1px solid var(--gray-700);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: var(--space-lg);
            right: var(--space-lg);
            background: none;
            border: none;
            color: var(--gray-400);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: var(--space-sm);
        }

        .modal-subtitle {
            color: var(--gray-400);
            font-size: 14px;
        }

        .modal-body {
            padding: var(--space-xl);
        }

        .modal-footer {
            padding: var(--space-xl);
            border-top: 1px solid var(--gray-700);
            display: flex;
            gap: var(--space-md);
            justify-content: center;
        }

        /* ===== FORM ELEMENTS ===== */
        .form-input {
            width: 100%;
            padding: var(--space-md);
            background: var(--gray-700);
            border: 2px solid var(--gray-600);
            border-radius: var(--radius-md);
            color: var(--white);
            font-family: inherit;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--yellow);
        }

        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 600;
        }

        .select-dropdown {
            width: 100%;
            padding: var(--space-md);
            background: var(--gray-700);
            border: 2px solid var(--gray-600);
            border-radius: var(--radius-md);
            color: var(--white);
            font-family: inherit;
            font-size: 16px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23FFDE21' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
        }

        .select-dropdown:focus {
            outline: none;
            border-color: var(--yellow);
        }

        /* ===== NUMBER INPUT STYLING ===== */
        .number-input-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .number-input-btn {
            width: 40px;
            height: 40px;
            background: var(--gray-700);
            border: 2px solid var(--gray-600);
            border-radius: var(--radius-md);
            color: var(--white);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .number-input-btn:hover {
            background: var(--gray-600);
            border-color: var(--yellow);
        }

        .number-input {
            flex: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        /* ===== THEME SELECTION GRID ===== */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--space-sm);
        }

        @media (max-width: 480px) {
            .theme-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .theme-option {
            padding: var(--space-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .theme-option:hover {
            transform: translateY(-2px);
        }

        .theme-option.selected {
            border-color: var(--white);
            box-shadow: 0 0 0 2px var(--yellow);
        }

        .theme-color {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto var(--space-sm);
            border: 2px solid var(--gray-600);
        }

        .theme-name {
            font-size: 12px;
            font-weight: 600;
        }

        /* ===== UTILITY CLASSES ===== */
        .text-center { text-align: center; }
        .text-yellow { color: var(--yellow); }
        .text-purple { color: var(--purple); }
        .text-red { color: var(--red); }
        .text-green { color: var(--green); }
        .text-orange { color: var(--orange); }
        .mt-sm { margin-top: var(--space-sm); }
        .mt-md { margin-top: var(--space-md); }
        .mt-lg { margin-top: var(--space-lg); }
        .mt-xl { margin-top: var(--space-xl); }
        .mb-sm { margin-bottom: var(--space-sm); }
        .mb-md { margin-bottom: var(--space-md); }
        .mb-lg { margin-bottom: var(--space-lg); }
        .mb-xl { margin-bottom: var(--space-xl); }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-sm { gap: var(--space-sm); }
        .gap-md { gap: var(--space-md); }
        .gap-lg { gap: var(--space-lg); }
        .w-full { width: 100%; }
        .relative { position: relative; }
        .flex-1 { flex: 1; }
        .opacity-50 { opacity: 0.5; }

        /* ===== FEEDBACK ANIMATIONS ===== */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .feedback-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 20px;
            animation: fadeInOut 1.5s ease;
            pointer-events: none;
        }

        .feedback-correct {
            background: var(--green);
            color: white;
        }

        .feedback-incorrect {
            background: var(--red);
            color: white;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--gray-800);
            border-left: 4px solid var(--yellow);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-card);
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* ===== BUZZER MODE STYLES ===== */
        .buzzer-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
            margin-top: var(--space-xl);
        }

        .buzzer-button {
            height: 200px;
            font-size: 48px;
            font-weight: 900;
            border-radius: var(--radius-lg);
            border: none;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            touch-action: manipulation;
        }

        .buzzer-button:active {
            transform: scale(0.95);
        }

        .buzzer-ready {
            background: var(--green);
            color: white;
        }

        .buzzer-buzzed {
            background: var(--yellow);
            color: var(--black);
        }

        .buzzer-disabled {
            background: var(--gray-700);
            color: var(--gray-400);
            cursor: not-allowed;
        }

        .buzzer-status {
            text-align: center;
            padding: var(--space-lg);
            background: var(--gray-800);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
        }

        .player-buzzed {
            font-size: 24px;
            font-weight: 700;
            color: var(--yellow);
            margin-top: var(--space-sm);
        }

        /* ===== CURRENT PLAYER TURN INDICATOR ===== */
        .current-player-indicator {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: var(--gray-800);
            padding: var(--space-sm) var(--space-md);
            text-align: center;
            font-weight: 600;
            z-index: 99;
            border-bottom: 1px solid var(--gray-700);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        /* ===== HINT STYLES ===== */
        .hint-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--gray-800);
            border: 2px solid var(--yellow);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            z-index: 1001;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: hintFadeIn 0.3s ease;
        }

        @keyframes hintFadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* ===== PROFILE PICTURE UPLOAD ===== */
        .profile-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--yellow);
            color: var(--black);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }

        .upload-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
        }

        /* ===== TOUCH SWIPE SUPPORT ===== */
        .swipe-area {
            position: relative;
            overflow: hidden;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 639px) {
            .hero-actions {
                flex-direction: column;
            }
            
            .hero-actions .btn {
                width: 100%;
            }
            
            .game-controls {
                flex-direction: column;
            }
            
            .game-controls .btn {
                width: 100%;
            }
            
            .card-grid, .categories-grid, .stats-grid {
                grid-template-columns: 1fr;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .online-actions {
                flex-direction: column;
            }

            .modal-footer {
                flex-direction: column;
            }

            .modal-footer .btn {
                width: 100%;
            }

            .room-code {
                font-size: 32px;
                letter-spacing: 4px;
            }

            .buzzer-button {
                height: 150px;
                font-size: 36px;
            }

            .hint-display {
                padding: var(--space-lg);
                max-width: 90%;
            }
        }

        @media (min-width: 640px) and (max-width: 1024px) {
            .card-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-800);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-600);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-logo">T</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgress"></div>
        </div>
        <div class="loading-text" id="loadingText">Initializing...</div>
    </div>

    <!-- Player HUD -->
    <div class="player-hud">
        <div class="hud-left">
            <div class="profile-display">
                <div class="profile-pic-hud" id="profilePicHud">
                    <img id="profilePicHudImg" src="" alt="" style="display: none;">
                    <span id="profilePicHudEmoji">ðŸ˜Ž</span>
                </div>
                <div class="hud-item">
                    <div>
                        <div class="hud-value" id="playerName">Player</div>
                        <div class="hud-label">Profile</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="hud-right">
            <div class="hud-item">
                <div class="hud-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div>
                    <div class="hud-value" id="playerScoreHud">0</div>
                    <div class="hud-label">Score</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Player Turn Indicator -->
    <div class="current-player-indicator hidden" id="currentPlayerIndicator"></div>

    <!-- Screens -->
    <main>
        <!-- Home Screen -->
        <div class="screen active" id="homeScreen">
            <div class="page-content">
                <section class="hero-section">
                    <h1 class="hero-title">Too Turned Triviaâ„¢</h1>
                    <p class="hero-subtitle">Challenge your mind with 6 unique game modes. Play solo or with friends!</p>
                    <div class="hero-actions">
                        <button class="btn btn-primary btn-lg" data-screen="modes">
                            <i class="fas fa-play-circle"></i> Play Now
                        </button>
                        <button class="btn btn-outline btn-lg" data-screen="online">
                            <i class="fas fa-wifi"></i> Online Play
                        </button>
                    </div>
                </section>

                <div class="card-grid">
                    <div class="card" data-screen="modes">
                        <div class="card-icon" style="background: rgba(108, 92, 231, 0.2); color: var(--purple);">
                            <i class="fas fa-crown"></i>
                        </div>
                        <h3 class="card-title">6 Game Modes</h3>
                        <p class="card-description">Classic, Countdown, Ladder, Battle, Buzzer, and Solo challenges with unique rules</p>
                    </div>
                    
                    <div class="card" data-screen="categories">
                        <div class="card-icon" style="background: rgba(255, 118, 117, 0.2); color: var(--red);">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <h3 class="card-title">Categories</h3>
                        <p class="card-description">Science, History, Entertainment, Sports, Geography, and more</p>
                    </div>
                    
                    <div class="card" data-screen="stats">
                        <div class="card-icon" style="background: rgba(253, 203, 110, 0.2); color: var(--orange);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3 class="card-title">Stats & Rankings</h3>
                        <p class="card-description">Track your progress and compete on global leaderboards</p>
                    </div>
                    
                    <div class="card" data-screen="profile">
                        <div class="card-icon" style="background: rgba(0, 184, 148, 0.2); color: var(--green);">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <h3 class="card-title">My Profile</h3>
                        <p class="card-description">Customize your profile and manage settings</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Modes Screen -->
        <div class="screen" id="modesScreen">
            <div class="page-content">
                <div class="modes-header">
                    <h2 class="section-title">Choose Your Mode</h2>
                    <p class="section-subtitle">Each mode has unique rules and challenges. Select one to begin!</p>
                </div>
                
                <div class="card-grid" id="modesGrid">
                    <!-- Modes will be dynamically loaded -->
                </div>
            </div>
        </div>

        <!-- Categories Screen -->
        <div class="screen" id="categoriesScreen">
            <div class="page-content">
                <div class="modes-header">
                    <h2 class="section-title">Categories</h2>
                    <p class="section-subtitle">Explore different trivia categories</p>
                </div>
                
                <div class="categories-grid" id="categoriesGrid">
                    <!-- Categories will be dynamically loaded -->
                </div>
            </div>
        </div>

        <!-- Stats Screen -->
        <div class="screen" id="statsScreen">
            <div class="page-content">
                <div class="modes-header">
                    <h2 class="section-title">Stats & Rankings</h2>
                    <p class="section-subtitle">Track your progress and achievements</p>
                </div>

                <div class="stats-grid mb-xl">
                    <div class="stat-card card">
                        <div class="stat-value-lg" id="totalGamesStat">0</div>
                        <div class="stat-label">Games Played</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-value-lg" id="accuracyStat">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-value-lg" id="winStreakStat">0</div>
                        <div class="stat-label">Win Streak</div>
                    </div>
                    <div class="stat-card card">
                        <div class="stat-value-lg" id="totalPointsStat">0</div>
                        <div class="stat-label">Total Points</div>
                    </div>
                </div>

                <div class="card mb-xl">
                    <h3 class="card-title mb-lg">Achievements</h3>
                    <div id="achievementsList">
                        <!-- Achievements will be loaded here -->
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title mb-lg">Global Leaderboard</h3>
                    <div class="leaderboard" id="leaderboard">
                        <!-- Leaderboard will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div class="screen" id="profileScreen">
            <div class="page-content">
                <div class="profile-header">
                    <div class="profile-pic" id="profilePic" onclick="openModal('avatarModal')">
                        <div class="profile-upload">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <h1 class="profile-name" id="profileName" onclick="openModal('nameModal')">Player</h1>
                        <p class="text-gray-400">Trivia Master</p>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="card-title mb-lg">Account Settings</h3>
                    <div class="card">
                        <div class="settings-item" onclick="openModal('nameModal')">
                            <span><i class="fas fa-user text-yellow mr-md"></i> Change Username</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                        <div class="settings-item" onclick="openModal('avatarModal')">
                            <span><i class="fas fa-image text-yellow mr-md"></i> Change Profile Picture</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="card-title mb-lg">Appearance</h3>
                    <div class="card">
                        <div class="settings-item">
                            <span><i class="fas fa-moon text-yellow mr-md"></i> Dark Mode</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="darkModeToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item" onclick="openModal('themeModal')">
                            <span><i class="fas fa-palette text-yellow mr-md"></i> Theme Color</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="card-title mb-lg">Game Settings</h3>
                    <div class="card">
                        <div class="settings-item" onclick="openModal('soundModal')">
                            <span><i class="fas fa-volume-up text-yellow mr-md"></i> Sound Effects</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                        <div class="settings-item" onclick="openModal('notificationModal')">
                            <span><i class="fas fa-bell text-yellow mr-md"></i> Notifications</span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Local Play Setup -->
        <div class="screen" id="playScreen">
            <div class="page-content">
                <div class="modes-header">
                    <h2 class="section-title" id="setupModeTitle">Local Play</h2>
                    <p class="section-subtitle" id="setupModeDescription">Play offline with friends and family</p>
                </div>

                <div class="setup-stepper">
                    <div class="step active" data-step="1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Players</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Settings</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Start</div>
                    </div>
                </div>

                <div class="setup-content">
                    <!-- Step 1: Players -->
                    <div class="setup-section active" data-step="1">
                        <h3 class="text-center mb-lg">Add Players</h3>
                        <p class="text-center text-gray-400 mb-lg">Add at least 1 player to start the game</p>
                        
                        <div class="players-list" id="playersList">
                            <!-- Players will be added here -->
                        </div>
                        
                        <div class="flex gap-sm mt-lg">
                            <input 
                                type="text" 
                                id="playerNameInput"
                                class="form-input w-full"
                                placeholder="Enter player name"
                                maxlength="20"
                            />
                            <button id="addPlayerBtn" class="btn btn-primary">
                                Add
                            </button>
                        </div>
                        
                        <button class="btn btn-primary btn-full mt-lg" id="nextStepBtn">
                            Continue to Settings
                        </button>
                    </div>

                    <!-- Step 2: Game Settings -->
                    <div class="setup-section" data-step="2">
                        <h3 class="text-center mb-lg">Game Settings</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Number of Questions</label>
                            <div class="number-input-group">
                                <button class="number-input-btn" id="questionDecrease">-</button>
                                <input type="number" class="form-input number-input" id="questionCount" value="10" min="5" max="50">
                                <button class="number-input-btn" id="questionIncrease">+</button>
                            </div>
                            <div class="text-sm text-gray-400 mt-sm">Choose between 5 and 50 questions</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="select-dropdown" id="categorySelect">
                                <!-- Categories will be populated dynamically -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Difficulty</label>
                            <select class="select-dropdown" id="difficultySelect">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-sm mt-lg">
                            <button class="btn btn-outline flex-1" id="prevStepBtn">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <button class="btn btn-primary flex-1" id="nextStepBtn2">
                                Continue <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Start Game -->
                    <div class="setup-section" data-step="3">
                        <h3 class="text-center mb-lg">Ready to Play!</h3>
                        
                        <div class="card mb-lg">
                            <div class="text-center mb-md">
                                <div class="text-yellow text-xl font-bold" id="selectedModeName">Classic Mode</div>
                                <div class="text-sm text-gray-400 mt-sm" id="selectedModeDescription">Traditional question/answer format</div>
                            </div>
                            
                            <div class="players-list" id="finalPlayersList">
                                <!-- Final players list -->
                            </div>

                            <div class="mt-md text-center text-gray-400">
                                <div><i class="fas fa-question-circle"></i> <span id="settingsQuestionCount">10</span> Questions</div>
                                <div><i class="fas fa-tag"></i> <span id="settingsCategory">General Knowledge</span></div>
                                <div><i class="fas fa-chart-line"></i> <span id="settingsDifficulty">Medium</span> Difficulty</div>
                            </div>
                        </div>
                        
                        <div class="flex gap-sm">
                            <button class="btn btn-outline flex-1" id="prevStepBtn2">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <button class="btn btn-primary flex-1" id="startGameBtn">
                                <i class="fas fa-play"></i> Start Game
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Online Screen -->
        <div class="screen" id="onlineScreen">
            <div class="page-content">
                <div class="modes-header">
                    <h2 class="section-title">Online Play</h2>
                    <p class="section-subtitle">Play with friends or random players from around the world</p>
                </div>

                <div class="online-actions">
                    <button class="btn btn-primary btn-lg" id="createRoomBtn">
                        <i class="fas fa-plus-circle"></i> Create Room
                    </button>
                    <button class="btn btn-outline btn-lg" id="joinRoomBtn">
                        <i class="fas fa-sign-in-alt"></i> Join Room
                    </button>
                </div>

                <div class="lobby-container card">
                    <h3 class="card-title mb-lg">Available Rooms</h3>
                    <div class="room-list" id="roomList">
                        <!-- Rooms will be dynamically loaded -->
                    </div>
                    <button class="btn btn-outline btn-full mt-lg" id="refreshRoomsBtn">
                        <i class="fas fa-sync-alt"></i> Refresh Rooms
                    </button>
                </div>
            </div>
        </div>

        <!-- Waiting Room Screen -->
        <div class="screen" id="waitingScreen">
            <div class="page-content">
                <div class="waiting-room">
                    <h2 class="section-title">Waiting Room</h2>
                    <p class="section-subtitle mb-lg">Share the code below with other players to join</p>
                    
                    <div class="room-code" id="roomCodeDisplay">ABC123</div>
                    
                    <div class="card mb-lg">
                        <h3 class="card-title mb-md">Connected Players</h3>
                        <div class="players-list" id="onlinePlayersList">
                            <!-- Online players will be listed here -->
                        </div>
                    </div>

                    <div class="game-settings mb-lg">
                        <h3 class="card-title mb-md">Room Settings</h3>
                        <div class="text-center text-gray-400">
                            <div><i class="fas fa-gamepad"></i> Mode: <span id="roomMode">Classic</span></div>
                            <div><i class="fas fa-question-circle"></i> Questions: <span id="roomQuestions">10</span></div>
                            <div><i class="fas fa-tag"></i> Category: <span id="roomCategory">General</span></div>
                        </div>
                    </div>

                    <div class="flex gap-sm">
                        <button class="btn btn-outline flex-1" id="leaveRoomBtn">
                            <i class="fas fa-sign-out-alt"></i> Leave
                        </button>
                        <button class="btn btn-primary flex-1" id="startOnlineGameBtn" disabled>
                            <i class="fas fa-play"></i> Start Game
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="gameScreen">
            <div class="page-content">
                <div class="game-header">
                    <div class="game-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="playerScore">0</div>
                            <div class="stat-label">Score</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="currentQuestionNum">1/10</div>
                            <div class="stat-label">Question</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="playerLives">3</div>
                            <div class="stat-label">Lives</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="timeBonus">0</div>
                            <div class="stat-label">Bonus</div>
                        </div>
                    </div>
                    
                    <div class="game-info">
                        <div class="game-mode-badge" id="currentGameMode">
                            <i class="fas fa-gamepad"></i> <span id="modeName">Classic</span>
                        </div>
                        <div class="timer-display">
                            <i class="fas fa-clock text-yellow"></i>
                            <span class="font-bold" id="gameTimer">30s</span>
                        </div>
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-header">
                        <div class="question-progress">
                            <span class="text-yellow font-semibold">Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span></span>
                            <span class="text-sm text-gray-400" id="difficultyLabel">Medium</span>
                        </div>
                        <div class="question-category">
                            <i class="fas fa-tag"></i>
                            <span id="questionCategory">General Knowledge</span>
                        </div>
                    </div>
                    
                    <div class="question-text" id="questionText">
                        Loading question...
                    </div>
                    
                    <div class="answers-grid" id="answersContainer">
                        <!-- Answers will be populated here -->
                    </div>
                </div>

                <!-- Buzzer Mode Container (hidden by default) -->
                <div id="buzzerContainer" class="hidden">
                    <div class="buzzer-status">
                        <h3>Buzzer Status</h3>
                        <p id="buzzerInstruction">Wait for the question to be read, then buzz in!</p>
                        <div class="player-buzzed" id="playerBuzzed"></div>
                    </div>
                    <div class="buzzer-container">
                        <button class="buzzer-button buzzer-ready" id="buzzerButton">
                            <i class="fas fa-bolt"></i>
                            <span>BUZZ IN!</span>
                        </button>
                    </div>
                </div>

                <div class="game-controls" id="gameControls">
                    <button class="btn btn-outline" id="hintBtn">
                        <i class="fas fa-lightbulb"></i> Hint (2 left)
                    </button>
                    <button class="btn btn-primary" id="nextQuestionBtn">
                        Next Question <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item active" data-screen="home">
            <i class="nav-icon fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" data-screen="modes">
            <i class="nav-icon fas fa-gamepad"></i>
            <span>Modes</span>
        </button>
        <button class="nav-item" data-screen="categories">
            <i class="nav-icon fas fa-layer-group"></i>
            <span>Categories</span>
        </button>
        <button class="nav-item" data-screen="stats">
            <i class="nav-icon fas fa-chart-line"></i>
            <span>Stats</span>
        </button>
        <button class="nav-item" data-screen="profile">
            <i class="nav-icon fas fa-user"></i>
            <span>Profile</span>
        </button>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="gameCompleteModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal('gameCompleteModal')">&times;</button>
                <h2 class="modal-title">Game Complete! ðŸ†</h2>
                <p class="modal-subtitle">Great game! Here are your results</p>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="text-yellow text-5xl font-bold mb-sm" id="finalScore">0</div>
                    <div class="text-lg mb-lg">Final Score</div>
                    
                    <div class="card mb-lg">
                        <div class="flex justify-around mb-md">
                            <div class="text-center">
                                <div class="text-xl font-bold" id="correctAnswersModal">0</div>
                                <div class="text-sm text-gray-400">Correct</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold" id="timePlayed">0s</div>
                                <div class="text-sm text-gray-400">Time</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold" id="bonusEarned">0</div>
                                <div class="text-sm text-gray-400">Bonus</div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <div class="text-yellow font-semibold mb-sm">Performance Summary</div>
                            <div class="text-sm text-gray-400" id="performanceSummary">
                                You answered 0 out of 0 questions correctly.
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mb-lg">
                        <div class="text-yellow font-semibold mb-sm">Winner</div>
                        <div class="text-2xl font-bold" id="winnerName">Player 1</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="backToMenuBtn">
                    Main Menu
                </button>
                <button class="btn btn-primary" id="playAgainBtn">
                    Play Again
                </button>
            </div>
        </div>
    </div>

    <!-- Create Room Modal -->
    <div class="modal-overlay" id="createRoomModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal('createRoomModal')">&times;</button>
                <h2 class="modal-title">Create Room</h2>
                <p class="modal-subtitle">Set up your online game room</p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Room Name</label>
                    <input type="text" class="form-input" id="roomName" placeholder="Enter room name" maxlength="30">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Game Mode</label>
                    <select class="select-dropdown" id="onlineModeSelect">
                        <!-- Modes will be populated -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Number of Questions</label>
                    <div class="number-input-group">
                        <button class="number-input-btn" id="onlineQuestionDecrease">-</button>
                        <input type="number" class="form-input number-input" id="onlineQuestionCount" value="10" min="5" max="50">
                        <button class="number-input-btn" id="onlineQuestionIncrease">+</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="select-dropdown" id="onlineCategorySelect">
                        <!-- Categories will be populated -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Max Players</label>
                    <select class="select-dropdown" id="maxPlayers">
                        <option value="2">2 Players</option>
                        <option value="4" selected>4 Players</option>
                        <option value="6">6 Players</option>
                        <option value="8">8 Players</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createRoomModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" id="createRoomConfirmBtn">
                    Create Room
                </button>
            </div>
        </div>
    </div>

    <!-- Join Room Modal -->
    <div class="modal-overlay" id="joinRoomModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal('joinRoomModal')">&times;</button>
                <h2 class="modal-title">Join Room</h2>
                <p class="modal-subtitle">Enter a room code to join</p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Room Code</label>
                    <input type="text" class="form-input" id="joinRoomCode" placeholder="Enter 6-digit code" maxlength="6" pattern="[A-Z0-9]{6}">
                </div>
                <p class="text-sm text-gray-400 mt-sm">Ask the room host for the 6-digit code</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('joinRoomModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" id="joinRoomConfirmBtn">
                    Join Room
                </button>
            </div>
        </div>
    </div>

    <!-- Mode Details Modal -->
    <div class="modal-overlay" id="modeDetailsModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal('modeDetailsModal')">&times;</button>
                <h2 class="modal-title" id="modeDetailsTitle">Classic Mode</h2>
                <p class="modal-subtitle" id="modeDetailsSubtitle">Traditional trivia gameplay</p>
            </div>
            <div class="modal-body">
                <div class="card mb-lg">
                    <h3 class="card-title mb-md">Rules</h3>
                    <div id="modeRules">
                        <!-- Rules will be populated -->
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title mb-md">How to Play</h3>
                    <div id="modeInstructions">
                        <!-- Instructions will be populated -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="playThisModeBtn">
                    <i class="fas fa-play"></i> Play This Mode
                </button>
            </div>
        </div>
    </div>

    <!-- Name Change Modal -->
    <div class="modal-overlay" id="nameModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal('nameModal')">&times;</button>
                <h2 class="modal-title">Change Username</h2>
                <p class="modal-subtitle">Enter your new username</p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">New Username</label>
                    <input type="text" class="form-input" id="newUsername" placeholder="Enter username" maxlength="20" value="Player">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('nameModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" id="saveUsernameBtn">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Picture Modal -->
    <div class="modal-overlay" id="avatarModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal('avatarModal')">&times;</button>
                <h2 class="modal-title">Choose Profile Picture</h2>
                <p class="modal-subtitle">Select from emojis or upload your own</p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Upload Photo</label>
                    <input type="file" class="form-input" id="avatarUpload" accept="image/*" style="padding: 10px;">
                </div>
                <div class="text-center mb-lg">
                    <img id="avatarPreview" class="upload-preview hidden" alt="Avatar preview">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Or choose an emoji:</label>
                    <div class="grid grid-cols-4 gap-4" id="avatarGrid">
                        <!-- Emojis will be populated -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('avatarModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" id="saveAvatarBtn">
                    Save Picture
                </button>
            </div>
        </div>
    </div>

    <!-- Theme Color Modal -->
    <div class="modal-overlay" id="themeModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal('themeModal')">&times;</button>
                <h2 class="modal-title">Theme Color</h2>
                <p class="modal-subtitle">Choose your preferred accent color</p>
            </div>
            <div class="modal-body">
                <div class="theme-grid" id="themeColors">
                    <!-- Theme colors will be populated -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('themeModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" id="saveThemeBtn">
                    Save Theme
                </button>
            </div>
        </div>
    </div>

    <!-- Sound Settings Modal -->
    <div class="modal-overlay" id="soundModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal('soundModal')">&times;</button>
                <h2 class="modal-title">Sound Settings</h2>
                <p class="modal-subtitle">Adjust game audio</p>
            </div>
            <div class="modal-body">
                <div class="settings-item">
                    <span>Sound Effects</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundEffectsToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span>Background Music</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="musicToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span>Notification Sounds</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notificationSoundToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('soundModal')">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div class="modal-overlay" id="notificationModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal('notificationModal')">&times;</button>
                <h2 class="modal-title">Notification Settings</h2>
                <p class="modal-subtitle">Manage your notifications</p>
            </div>
            <div class="modal-body">
                <div class="settings-item">
                    <span>Achievement Notifications</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="achievementNotificationToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span>Game Invitations</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="gameInvitationToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span>Friend Activity</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="friendActivityToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('notificationModal')">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Pause Modal -->
    <div class="modal-overlay" id="pauseModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Game Paused</h2>
                <p class="modal-subtitle">Take a break</p>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-pause-circle text-yellow text-6xl mb-lg"></i>
                    <p class="text-lg">Game progress will be saved</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('pauseModal')">
                    Resume
                </button>
                <button class="btn btn-primary" id="quitGameBtn">
                    Quit Game
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== SUPABASE CONFIGURATION =====
        // Replace these with your actual Supabase credentials
        const SUPABASE_CONFIG = {
            URL: 'https://your-project.supabase.co',
            ANON_KEY: 'your-anon-key'
        };

        // Initialize Supabase client (will be set up when Supabase is configured)
        let supabaseClient = null;

        // ===== REAL-TIME WEBSOCKET COMMUNICATION =====
        class RealTimeGameService {
            constructor() {
                this.roomChannel = null;
                this.gameChannel = null;
                this.roomCode = null;
                this.listeners = {};
            }
            
            // 1. Real-Time Communication using Supabase
            async connectToRoom(roomCode, playerName, isHost = false) {
                this.roomCode = roomCode;
                
                // 5. Security: Validate room exists
                const { data: room, error } = await supabaseClient
                    .from('game_rooms')
                    .select('*')
                    .eq('room_code', roomCode)
                    .single();
                    
                if (error && !isHost) {
                    throw new Error('Room not found');
                }
                
                if (isHost) {
                    // Create room if hosting
                    const { data: newRoom, error: createError } = await supabaseClient
                        .from('game_rooms')
                        .insert([
                            {
                                room_code: roomCode,
                                host_id: playerName,
                                max_players: 8,
                                game_state: 'waiting',
                                created_at: new Date().toISOString()
                            }
                        ])
                        .select()
                        .single();
                        
                    if (createError) throw createError;
                }
                
                // Join player to room
                const { error: joinError } = await supabaseClient
                    .from('room_players')
                    .insert({
                        room_code: roomCode,
                        player_name: playerName,
                        is_host: isHost,
                        joined_at: new Date().toISOString()
                    });
                    
                if (joinError) throw joinError;
                
                // Subscribe to room updates
                this.setupRoomChannel(roomCode);
                this.setupGameChannel(roomCode);
                
                return true;
            }
            
            setupRoomChannel(roomCode) {
                this.roomChannel = supabaseClient
                    .channel(`room:${roomCode}`)
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'room_players',
                            filter: `room_code=eq.${roomCode}`
                        },
                        (payload) => this.handleRoomUpdate(payload)
                    )
                    .subscribe();
            }
            
            setupGameChannel(roomCode) {
                this.gameChannel = supabaseClient
                    .channel(`game:${roomCode}`)
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'game_states',
                            filter: `room_code=eq.${roomCode}`
                        },
                        (payload) => this.handleGameUpdate(payload)
                    )
                    .subscribe();
            }
            
            // 2. Room Code Validation System
            async validateRoomCode(roomCode) {
                // Check if room exists and is joinable
                const { data, error } = await supabaseClient
                    .from('game_rooms')
                    .select('*, room_players(count)')
                    .eq('room_code', roomCode)
                    .eq('game_state', 'waiting')
                    .single();
                    
                if (error) return { valid: false, error: 'Room not found' };
                
                const playerCount = data.room_players[0]?.count || 0;
                if (playerCount >= data.max_players) {
                    return { valid: false, error: 'Room is full' };
                }
                
                return { 
                    valid: true, 
                    data: { 
                        roomName: data.room_name,
                        mode: data.game_mode,
                        players: playerCount,
                        maxPlayers: data.max_players
                    }
                };
            }
            
            // 3. Game State Synchronization
            async updateGameState(stateUpdate) {
                const { error } = await supabaseClient
                    .from('game_states')
                    .upsert({
                        room_code: this.roomCode,
                        current_question: stateUpdate.currentQuestion,
                        question_index: stateUpdate.questionIndex,
                        scores: stateUpdate.scores,
                        time_remaining: stateUpdate.timeRemaining,
                        last_updated: new Date().toISOString()
                    });
                    
                if (error) console.error('State sync error:', error);
            }
            
            async getGameState() {
                const { data, error } = await supabaseClient
                    .from('game_states')
                    .select('*')
                    .eq('room_code', this.roomCode)
                    .order('last_updated', { ascending: false })
                    .limit(1)
                    .single();
                    
                return { data, error };
            }
            
            // 4. Client-Side Interface Handlers
            handleRoomUpdate(payload) {
                switch(payload.eventType) {
                    case 'INSERT':
                        this.trigger('player_joined', payload.new);
                        break;
                    case 'DELETE':
                        this.trigger('player_left', payload.old);
                        break;
                }
            }
            
            handleGameUpdate(payload) {
                switch(payload.eventType) {
                    case 'INSERT':
                    case 'UPDATE':
                        this.trigger('game_state_updated', payload.new);
                        break;
                }
            }
            
            // Event system
            on(event, callback) {
                if (!this.listeners[event]) this.listeners[event] = [];
                this.listeners[event].push(callback);
            }
            
            trigger(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(cb => cb(data));
                }
            }
            
            // Cleanup
            disconnect() {
                if (this.roomChannel) {
                    supabaseClient.removeChannel(this.roomChannel);
                }
                if (this.gameChannel) {
                    supabaseClient.removeChannel(this.gameChannel);
                }
            }
        }

        // ===== GAME STATE =====
        const gameState = {
            // User Profile
            playerName: 'Player',
            playerAvatar: 'ðŸ˜Ž',
            playerProfilePic: null,
            
            // Player Stats
            totalGames: 0,
            totalCorrectAnswers: 0,
            totalQuestions: 0,
            highestStreak: 0,
            winStreak: 0,
            totalScore: 0,
            
            // Navigation
            currentScreen: 'home',
            screenHistory: ['home'],
            previousGameState: null,
            
            // Players
            players: [],
            playerScores: {},
            playerTurn: 0,
            currentPlayerIndex: 0,
            
            // Game Modes with unique rules
            gameModes: [
                {
                    id: 'classic',
                    name: 'Classic',
                    icon: 'crown',
                    color: '#6C5CE7',
                    description: 'Traditional question/answer format with progressive difficulty',
                    rules: [
                        'Each player takes turns answering questions',
                        '30 seconds per question',
                        '3 lives per player',
                        '100 points per correct answer',
                        'Wrong answer loses a life',
                        'Difficulty increases every 3 questions',
                        'Player with most points after all questions wins'
                    ],
                    instructions: [
                        'Players take turns in order',
                        'Current player answers the question',
                        'Correct answer earns points',
                        'Wrong answer loses a life',
                        'Game continues until all questions answered',
                        'Highest score wins'
                    ],
                    minPlayers: 1,
                    maxPlayers: 8,
                    timePerQuestion: 30,
                    lives: 3
                },
                {
                    id: 'countdown',
                    name: 'Countdown',
                    icon: 'stopwatch',
                    color: '#FF7675',
                    description: 'Speed bonus for quick answers! Time limits per question',
                    rules: [
                        'Each player gets the same question simultaneously',
                        '15 seconds per question',
                        '3 lives per player',
                        '100 base points + time bonus',
                        'Bonus: Quick answers earn extra points',
                        'Timer counts down, faster answers = more points',
                        'Wrong answer loses a life'
                    ],
                    instructions: [
                        'All players answer the same question',
                        'Answer as quickly as possible',
                        'Bonus points for quick answers',
                        'Wrong answers cost a life',
                        'Speed matters!',
                        'Highest score wins'
                    ],
                    minPlayers: 1,
                    maxPlayers: 6,
                    timePerQuestion: 15,
                    lives: 3
                },
                {
                    id: 'ladder',
                    name: 'Ladder',
                    icon: 'chart-line',
                    color: '#FDCB6E',
                    description: 'Advance through levels by getting answers correct',
                    rules: [
                        'Players take turns climbing the ladder',
                        '25 seconds per question',
                        '1 life per player',
                        'Scoring: 100 Ã— current level',
                        'Correct answer moves up one level',
                        'Wrong answer drops back one level',
                        'Perfect streak bonus',
                        'Highest level reached wins'
                    ],
                    instructions: [
                        'Start at level 1',
                        'Players take turns answering',
                        'Correct answer moves up one level',
                        'Wrong answer drops back one level',
                        'Level determines points per question',
                        'Reach the highest level to win'
                    ],
                    minPlayers: 1,
                    maxPlayers: 4,
                    timePerQuestion: 25,
                    lives: 1
                },
                {
                    id: 'battle',
                    name: 'Battle',
                    icon: 'skull-crossbones',
                    color: '#FD79A8',
                    description: 'Elimination-style gameplay! Wrong answers knock players out',
                    rules: [
                        'Players take turns answering',
                        '20 seconds per question',
                        '1 life per player',
                        'Elimination after wrong answer',
                        'Last player standing wins',
                        'Survival bonus points',
                        'Correct answer stays in game',
                        'Wrong answer = eliminated'
                    ],
                    instructions: [
                        'Each player has 1 life',
                        'Players take turns answering',
                        'Correct answer = stay in game',
                        'Wrong answer = eliminated',
                        'Survive to win',
                        'Last player standing wins all'
                    ],
                    minPlayers: 2,
                    maxPlayers: 8,
                    timePerQuestion: 20,
                    lives: 1
                },
                {
                    id: 'buzzer',
                    name: 'Buzzer',
                    icon: 'bolt',
                    color: '#00B894',
                    description: 'First to buzz in answers! Fast-paced competitive play',
                    rules: [
                        'Question is displayed to all players',
                        'First to buzz in gets to answer',
                        'Unlimited time for question',
                        'Correct answer = points + control',
                        'Wrong answer = lose turn',
                        'Buzz in within 5 seconds of question',
                        'Fastest finger wins!'
                    ],
                    instructions: [
                        'Question appears for all players',
                        'First to buzz in gets to answer',
                        'Correct answer earns points',
                        'Wrong answer gives others a chance',
                        'Fastest finger wins!',
                        'Player with most points wins'
                    ],
                    minPlayers: 2,
                    maxPlayers: 8,
                    timePerQuestion: 0,
                    lives: 1
                },
                {
                    id: 'solo',
                    name: 'Solo Challenge',
                    icon: 'user-graduate',
                    color: '#00CEC9',
                    description: 'Individual play with deadlines. Perfect for self-challenge!',
                    rules: [
                        'Play against yourself',
                        '30 seconds per question',
                        '3 lives',
                        'Score + accuracy bonus',
                        'Perfect round bonus',
                        'Beat your high score!',
                        'Track your progress'
                    ],
                    instructions: [
                        'Answer questions within time limit',
                        'Aim for high score',
                        'Perfect rounds earn bonus',
                        'Track your progress',
                        'Beat your previous scores'
                    ],
                    minPlayers: 1,
                    maxPlayers: 1,
                    timePerQuestion: 30,
                    lives: 3
                }
            ],
            
            // Categories
            categories: [
                {
                    id: 'general',
                    name: 'General Knowledge',
                    icon: 'brain',
                    color: '#6C5CE7',
                    description: 'A mix of everything from science to pop culture'
                },
                {
                    id: 'science',
                    name: 'Science',
                    icon: 'flask',
                    color: '#FF7675',
                    description: 'Biology, chemistry, physics, and astronomy'
                },
                {
                    id: 'history',
                    name: 'History',
                    icon: 'landmark',
                    color: '#FDCB6E',
                    description: 'World history, famous events, and historical figures'
                },
                {
                    id: 'entertainment',
                    name: 'Entertainment',
                    icon: 'film',
                    color: '#FD79A8',
                    description: 'Movies, TV shows, music, and celebrities'
                },
                {
                    id: 'sports',
                    name: 'Sports',
                    icon: 'football-ball',
                    color: '#00B894',
                    description: 'All things sports - teams, players, and events'
                },
                {
                    id: 'geography',
                    name: 'Geography',
                    icon: 'globe',
                    color: '#00CEC9',
                    description: 'Countries, capitals, landmarks, and maps'
                },
                {
                    id: 'arts',
                    name: 'Arts & Literature',
                    icon: 'palette',
                    color: '#9B59B6',
                    description: 'Books, authors, paintings, and artists'
                },
                {
                    id: 'technology',
                    name: 'Technology',
                    icon: 'laptop-code',
                    color: '#3498DB',
                    description: 'Computers, internet, and tech innovations'
                }
            ],
            
            // Current Game State
            isGameActive: false,
            isOnlineGame: false,
            currentGameMode: null,
            currentQuestionIndex: 0,
            totalQuestions: 10,
            score: 0,
            lives: 3,
            timeBonus: 0,
            timer: 30,
            timerInterval: null,
            gameStartTime: null,
            correctAnswers: 0,
            selectedCategory: 'general',
            selectedDifficulty: 'medium',
            currentStreak: 0,
            maxStreak: 0,
            currentQuestion: null,
            currentAnswers: [],
            selectedAnswer: null,
            hintCount: 2,
            
            // Buzzer Mode State
            isBuzzerActive: false,
            hasBuzzed: false,
            buzzerTimeout: null,
            
            // Online State
            roomCode: null,
            roomName: null,
            isHost: false,
            onlinePlayers: [],
            onlineRooms: [],
            realTimeService: null,
            
            // Achievements
            achievements: [
                { id: 'first_game', name: 'First Timer', description: 'Complete your first game', unlocked: false },
                { id: 'perfect_game', name: 'Perfectionist', description: 'Get all questions correct in a game', unlocked: false },
                { id: 'streak_10', name: 'Hot Streak', description: 'Answer 10 questions in a row correctly', unlocked: false },
                { id: 'speed_demon', name: 'Speed Demon', description: 'Answer a question in under 3 seconds', unlocked: false },
                { id: 'mode_master', name: 'Mode Master', description: 'Play all game modes', unlocked: false },
                { id: 'category_expert', name: 'Category Expert', description: 'Play all categories', unlocked: false },
                { id: 'trivia_champion', name: 'Trivia Champion', description: 'Win 10 games', unlocked: false },
                { id: 'social_butterfly', name: 'Social Butterfly', description: 'Play with 8 different players', unlocked: false },
                { id: 'night_owl', name: 'Night Owl', description: 'Play 5 games after midnight', unlocked: false },
                { id: 'quick_thinker', name: 'Quick Thinker', description: 'Answer 5 questions correctly with less than 5 seconds remaining', unlocked: false },
                { id: 'ladder_climber', name: 'Ladder Climber', description: 'Reach level 10 in Ladder mode', unlocked: false },
                { id: 'battle_royale', name: 'Battle Royale', description: 'Win a Battle mode with 8 players', unlocked: false },
                { id: 'buzzer_king', name: 'Buzzer King', description: 'Buzz in first 5 times in a single game', unlocked: false },
                { id: 'countdown_pro', name: 'Countdown Pro', description: 'Score 1000+ points in Countdown mode', unlocked: false },
                { id: 'solo_legend', name: 'Solo Legend', description: 'Get a perfect score in Solo mode', unlocked: false }
            ],
            
            // Settings
            settings: {
                darkMode: true,
                soundEffects: true,
                music: true,
                notifications: true,
                achievementNotifications: true,
                themeColor: '#FFDE21'
            }
        };

        // ===== API CONFIGURATION =====
        const API_CONFIG = {
            BASE_URL: 'https://the-trivia-api.com/v2',
            CATEGORIES: {
                'general': 'general_knowledge',
                'science': 'science',
                'history': 'history',
                'entertainment': 'film_and_tv',
                'sports': 'sport_and_leisure',
                'geography': 'geography',
                'arts': 'arts_and_literature',
                'technology': 'science'
            }
        };

        // ===== DOM ELEMENTS =====
        const elements = {
            // Loading
            loadingScreen: document.getElementById('loadingScreen'),
            loadingProgress: document.getElementById('loadingProgress'),
            loadingText: document.getElementById('loadingText'),
            
            // Player HUD
            playerName: document.getElementById('playerName'),
            playerScoreHud: document.getElementById('playerScoreHud'),
            profilePicHud: document.getElementById('profilePicHud'),
            profilePicHudImg: document.getElementById('profilePicHudImg'),
            profilePicHudEmoji: document.getElementById('profilePicHudEmoji'),
            
            // Bottom Navigation
            navItems: document.querySelectorAll('.nav-item'),
            
            // Screens
            screens: {
                home: document.getElementById('homeScreen'),
                modes: document.getElementById('modesScreen'),
                categories: document.getElementById('categoriesScreen'),
                stats: document.getElementById('statsScreen'),
                profile: document.getElementById('profileScreen'),
                play: document.getElementById('playScreen'),
                online: document.getElementById('onlineScreen'),
                waiting: document.getElementById('waitingScreen'),
                game: document.getElementById('gameScreen')
            },
            
            // Current Player Indicator
            currentPlayerIndicator: document.getElementById('currentPlayerIndicator'),
            
            // Setup Screen
            playersList: document.getElementById('playersList'),
            finalPlayersList: document.getElementById('finalPlayersList'),
            playerNameInput: document.getElementById('playerNameInput'),
            addPlayerBtn: document.getElementById('addPlayerBtn'),
            modesGrid: document.getElementById('modesGrid'),
            selectedModeName: document.getElementById('selectedModeName'),
            selectedModeDescription: document.getElementById('selectedModeDescription'),
            
            // Step Navigation
            nextStepBtn: document.getElementById('nextStepBtn'),
            nextStepBtn2: document.getElementById('nextStepBtn2'),
            prevStepBtn: document.getElementById('prevStepBtn'),
            prevStepBtn2: document.getElementById('prevStepBtn2'),
            startGameBtn: document.getElementById('startGameBtn'),
            
            // Game Settings
            questionCount: document.getElementById('questionCount'),
            questionDecrease: document.getElementById('questionDecrease'),
            questionIncrease: document.getElementById('questionIncrease'),
            categorySelect: document.getElementById('categorySelect'),
            difficultySelect: document.getElementById('difficultySelect'),
            settingsQuestionCount: document.getElementById('settingsQuestionCount'),
            settingsCategory: document.getElementById('settingsCategory'),
            settingsDifficulty: document.getElementById('settingsDifficulty'),
            setupModeTitle: document.getElementById('setupModeTitle'),
            setupModeDescription: document.getElementById('setupModeDescription'),
            
            // Game Screen
            playerScore: document.getElementById('playerScore'),
            currentQuestionNum: document.getElementById('currentQuestionNum'),
            playerLives: document.getElementById('playerLives'),
            timeBonus: document.getElementById('timeBonus'),
            modeName: document.getElementById('modeName'),
            currentGameMode: document.getElementById('currentGameMode'),
            gameTimer: document.getElementById('gameTimer'),
            currentQuestion: document.getElementById('currentQuestion'),
            totalQuestions: document.getElementById('totalQuestions'),
            difficultyLabel: document.getElementById('difficultyLabel'),
            questionCategory: document.getElementById('questionCategory'),
            questionText: document.getElementById('questionText'),
            answersContainer: document.getElementById('answersContainer'),
            hintBtn: document.getElementById('hintBtn'),
            nextQuestionBtn: document.getElementById('nextQuestionBtn'),
            gameControls: document.getElementById('gameControls'),
            
            // Buzzer Mode
            buzzerContainer: document.getElementById('buzzerContainer'),
            buzzerButton: document.getElementById('buzzerButton'),
            buzzerInstruction: document.getElementById('buzzerInstruction'),
            playerBuzzed: document.getElementById('playerBuzzed'),
            
            // Online Screen
            createRoomBtn: document.getElementById('createRoomBtn'),
            joinRoomBtn: document.getElementById('joinRoomBtn'),
            refreshRoomsBtn: document.getElementById('refreshRoomsBtn'),
            roomList: document.getElementById('roomList'),
            
            // Waiting Room
            roomCodeDisplay: document.getElementById('roomCodeDisplay'),
            onlinePlayersList: document.getElementById('onlinePlayersList'),
            roomMode: document.getElementById('roomMode'),
            roomQuestions: document.getElementById('roomQuestions'),
            roomCategory: document.getElementById('roomCategory'),
            leaveRoomBtn: document.getElementById('leaveRoomBtn'),
            startOnlineGameBtn: document.getElementById('startOnlineGameBtn'),
            
            // Stats Screen
            totalGamesStat: document.getElementById('totalGamesStat'),
            accuracyStat: document.getElementById('accuracyStat'),
            winStreakStat: document.getElementById('winStreakStat'),
            totalPointsStat: document.getElementById('totalPointsStat'),
            achievementsList: document.getElementById('achievementsList'),
            leaderboard: document.getElementById('leaderboard'),
            
            // Profile Screen
            profilePic: document.getElementById('profilePic'),
            profileName: document.getElementById('profileName'),
            
            // Categories Screen
            categoriesGrid: document.getElementById('categoriesGrid'),
            
            // Modal
            gameCompleteModal: document.getElementById('gameCompleteModal'),
            finalScore: document.getElementById('finalScore'),
            correctAnswersModal: document.getElementById('correctAnswersModal'),
            timePlayed: document.getElementById('timePlayed'),
            bonusEarned: document.getElementById('bonusEarned'),
            winnerName: document.getElementById('winnerName'),
            performanceSummary: document.getElementById('performanceSummary'),
            backToMenuBtn: document.getElementById('backToMenuBtn'),
            playAgainBtn: document.getElementById('playAgainBtn'),
            
            // Create Room Modal
            createRoomModal: document.getElementById('createRoomModal'),
            roomName: document.getElementById('roomName'),
            onlineModeSelect: document.getElementById('onlineModeSelect'),
            onlineQuestionCount: document.getElementById('onlineQuestionCount'),
            onlineQuestionDecrease: document.getElementById('onlineQuestionDecrease'),
            onlineQuestionIncrease: document.getElementById('onlineQuestionIncrease'),
            onlineCategorySelect: document.getElementById('onlineCategorySelect'),
            maxPlayers: document.getElementById('maxPlayers'),
            createRoomConfirmBtn: document.getElementById('createRoomConfirmBtn'),
            
            // Join Room Modal
            joinRoomModal: document.getElementById('joinRoomModal'),
            joinRoomCode: document.getElementById('joinRoomCode'),
            joinRoomConfirmBtn: document.getElementById('joinRoomConfirmBtn'),
            
            // Mode Details Modal
            modeDetailsModal: document.getElementById('modeDetailsModal'),
            modeDetailsTitle: document.getElementById('modeDetailsTitle'),
            modeDetailsSubtitle: document.getElementById('modeDetailsSubtitle'),
            modeRules: document.getElementById('modeRules'),
            modeInstructions: document.getElementById('modeInstructions'),
            playThisModeBtn: document.getElementById('playThisModeBtn'),
            
            // Settings Modals
            nameModal: document.getElementById('nameModal'),
            newUsername: document.getElementById('newUsername'),
            saveUsernameBtn: document.getElementById('saveUsernameBtn'),
            
            avatarModal: document.getElementById('avatarModal'),
            avatarGrid: document.getElementById('avatarGrid'),
            avatarUpload: document.getElementById('avatarUpload'),
            avatarPreview: document.getElementById('avatarPreview'),
            saveAvatarBtn: document.getElementById('saveAvatarBtn'),
            
            themeModal: document.getElementById('themeModal'),
            themeColors: document.getElementById('themeColors'),
            saveThemeBtn: document.getElementById('saveThemeBtn'),
            
            soundModal: document.getElementById('soundModal'),
            soundEffectsToggle: document.getElementById('soundEffectsToggle'),
            musicToggle: document.getElementById('musicToggle'),
            notificationSoundToggle: document.getElementById('notificationSoundToggle'),
            
            notificationModal: document.getElementById('notificationModal'),
            achievementNotificationToggle: document.getElementById('achievementNotificationToggle'),
            gameInvitationToggle: document.getElementById('gameInvitationToggle'),
            friendActivityToggle: document.getElementById('friendActivityToggle'),
            
            // Pause Modal
            pauseModal: document.getElementById('pauseModal'),
            quitGameBtn: document.getElementById('quitGameBtn'),
            
            // Settings Toggles
            darkModeToggle: document.getElementById('darkModeToggle')
        };

        // ===== TOUCH/HANDLER UTILITIES =====
        class TouchHandler {
            constructor() {
                this.startX = 0;
                this.startY = 0;
                this.threshold = 50;
                this.currentScreen = null;
            }
            
            init() {
                document.addEventListener('touchstart', (e) => this.handleTouchStart(e));
                document.addEventListener('touchend', (e) => this.handleTouchEnd(e));
            }
            
            handleTouchStart(e) {
                this.startX = e.touches[0].clientX;
                this.startY = e.touches[0].clientY;
                this.currentScreen = gameState.currentScreen;
            }
            
            handleTouchEnd(e) {
                if (!this.startX || !this.startY) return;
                
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                
                const diffX = this.startX - endX;
                const diffY = this.startY - endY;
                
                // Only consider horizontal swipes
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > this.threshold) {
                    // Left swipe = go forward/next
                    if (diffX > 0) {
                        this.handleSwipe('left');
                    } 
                    // Right swipe = go back/previous
                    else {
                        this.handleSwipe('right');
                    }
                }
                
                this.startX = 0;
                this.startY = 0;
            }
            
            handleSwipe(direction) {
                const screenOrder = ['home', 'modes', 'categories', 'stats', 'profile'];
                const currentIndex = screenOrder.indexOf(this.currentScreen);
                
                if (direction === 'left' && currentIndex < screenOrder.length - 1) {
                    // Swipe left - go to next screen
                    updateNavigation(screenOrder[currentIndex + 1]);
                } else if (direction === 'right' && currentIndex > 0) {
                    // Swipe right - go to previous screen
                    updateNavigation(screenOrder[currentIndex - 1]);
                }
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupEventListeners();
            simulateLoading();
            
            // Initialize touch handler for mobile swiping
            const touchHandler = new TouchHandler();
            touchHandler.init();
            
            // Save state before unload
            window.addEventListener('beforeunload', saveGameState);
        });

        async function initializeApp() {
            // Load saved data from localStorage
            loadSavedData();
            
            // Initialize Supabase client if credentials are provided
            try {
                if (SUPABASE_CONFIG.URL && SUPABASE_CONFIG.URL !== 'https://your-project.supabase.co' &&
                    SUPABASE_CONFIG.ANON_KEY && SUPABASE_CONFIG.ANON_KEY !== 'your-anon-key') {
                    
                    supabaseClient = supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
                    gameState.realTimeService = new RealTimeGameService();
                    console.log('Supabase client initialized');
                }
            } catch (error) {
                console.warn('Supabase not configured or failed to initialize:', error);
            }
            
            // Update UI
            updateHUD();
            populateGameData();
            populateCategories();
            populateCategoriesScreen();
            setupStepNavigation();
            populateStats();
            populateAchievements();
            populateLeaderboard();
            
            // Initialize online mode selectors
            populateOnlineSelectors();
            
            // Initialize settings
            initializeSettings();
            
            // Add current player for demo
            addPlayer(gameState.playerName);
            
            // Apply theme color
            applyThemeColor(gameState.settings.themeColor);
            
            // Check URL hash for screen navigation
            checkUrlHash();
        }

        function checkUrlHash() {
            const hash = window.location.hash.substring(1);
            if (hash && elements.screens[hash]) {
                updateNavigation(hash);
            }
        }

        function loadSavedData() {
            // Try to load previous game state
            const savedState = localStorage.getItem('triviaGameState');
            if (savedState) {
                try {
                    const parsed = JSON.parse(savedState);
                    gameState.playerName = parsed.playerName || 'Player';
                    gameState.playerAvatar = parsed.playerAvatar || 'ðŸ˜Ž';
                    gameState.playerProfilePic = parsed.playerProfilePic || null;
                    gameState.totalGames = parsed.totalGames || 0;
                    gameState.totalCorrectAnswers = parsed.totalCorrectAnswers || 0;
                    gameState.totalQuestions = parsed.totalQuestions || 0;
                    gameState.highestStreak = parsed.highestStreak || 0;
                    gameState.winStreak = parsed.winStreak || 0;
                    gameState.totalScore = parsed.totalScore || 0;
                    
                    // Load achievements
                    if (parsed.achievements) {
                        gameState.achievements = parsed.achievements;
                    }
                    
                    // Load settings
                    if (parsed.settings) {
                        gameState.settings = parsed.settings;
                    }
                    
                    // Load previous game state if exists
                    if (parsed.previousGameState && confirm('Restore previous game?')) {
                        gameState.previousGameState = parsed.previousGameState;
                    }
                    
                } catch (e) {
                    console.error('Error loading saved state:', e);
                }
            }
        }

        function saveGameState() {
            const stateToSave = {
                playerName: gameState.playerName,
                playerAvatar: gameState.playerAvatar,
                playerProfilePic: gameState.playerProfilePic,
                totalGames: gameState.totalGames,
                totalCorrectAnswers: gameState.totalCorrectAnswers,
                totalQuestions: gameState.totalQuestions,
                highestStreak: gameState.highestStreak,
                winStreak: gameState.winStreak,
                totalScore: gameState.totalScore,
                achievements: gameState.achievements,
                settings: gameState.settings,
                previousGameState: gameState.isGameActive ? {
                    currentScreen: gameState.currentScreen,
                    isGameActive: gameState.isGameActive,
                    currentGameMode: gameState.currentGameMode,
                    currentQuestionIndex: gameState.currentQuestionIndex,
                    score: gameState.score,
                    lives: gameState.lives,
                    players: gameState.players,
                    playerScores: gameState.playerScores
                } : null
            };
            
            localStorage.setItem('triviaGameState', JSON.stringify(stateToSave));
        }

        function restorePreviousGame() {
            if (!gameState.previousGameState) return;
            
            const state = gameState.previousGameState;
            gameState.currentScreen = state.currentScreen;
            gameState.isGameActive = state.isGameActive;
            gameState.currentGameMode = state.currentGameMode;
            gameState.currentQuestionIndex = state.currentQuestionIndex;
            gameState.score = state.score;
            gameState.lives = state.lives;
            gameState.players = state.players || [];
            gameState.playerScores = state.playerScores || {};
            
            // Clear the saved state
            gameState.previousGameState = null;
            localStorage.removeItem('triviaGameState');
            
            // Update navigation
            updateNavigation(gameState.currentScreen);
            
            // If game was active, reload the question
            if (gameState.isGameActive) {
                loadQuestion();
            }
        }

        function initializeSettings() {
            // Set toggle states
            elements.darkModeToggle.checked = gameState.settings.darkMode;
            elements.soundEffectsToggle.checked = gameState.settings.soundEffects;
            elements.musicToggle.checked = gameState.settings.music;
            elements.notificationSoundToggle.checked = gameState.settings.notifications;
            elements.achievementNotificationToggle.checked = gameState.settings.achievementNotifications;
            
            // Apply dark mode
            applyDarkMode(gameState.settings.darkMode);
        }

        function applyDarkMode(isDark) {
            if (isDark) {
                document.documentElement.classList.remove('light-mode');
                document.body.classList.remove('light-mode');
            } else {
                document.documentElement.classList.add('light-mode');
                document.body.classList.add('light-mode');
            }
        }

        function applyThemeColor(color) {
            // Remove yellow shadow from light mode
            const root = document.documentElement;
            root.style.setProperty('--yellow', color);
            root.style.setProperty('--yellow-dark', darkenColor(color, 20));
            
            // Update any existing yellow elements
            document.querySelectorAll('.text-yellow, .nav-item.active').forEach(el => {
                el.style.color = color;
            });
        }

        function simulateLoading() {
            let progress = 0;
            const messages = [
                "Loading game assets...",
                "Initializing game engine...",
                "Preparing questions database...",
                "Setting up multiplayer...",
                "Almost ready..."
            ];
            
            const interval = setInterval(() => {
                progress += 20;
                elements.loadingProgress.style.width = `${progress}%`;
                
                // Update loading text
                if (progress < 25) elements.loadingText.textContent = messages[0];
                else if (progress < 50) elements.loadingText.textContent = messages[1];
                else if (progress < 75) elements.loadingText.textContent = messages[2];
                else if (progress < 90) elements.loadingText.textContent = messages[3];
                else elements.loadingText.textContent = messages[4];
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        elements.loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            elements.loadingScreen.style.display = 'none';
                            // Check if we should restore previous game
                            if (localStorage.getItem('triviaGameState')) {
                                setTimeout(() => {
                                    if (confirm('Would you like to continue your previous game?')) {
                                        restorePreviousGame();
                                    }
                                }, 500);
                            }
                        }, 500);
                    }, 500);
                }
            }, 200);
        }

        function updateHUD() {
            elements.playerName.textContent = gameState.playerName;
            elements.playerScoreHud.textContent = gameState.totalScore.toLocaleString();
            
            // Update profile picture in HUD
            if (gameState.playerProfilePic) {
                elements.profilePicHudImg.src = gameState.playerProfilePic;
                elements.profilePicHudImg.style.display = 'block';
                elements.profilePicHudEmoji.style.display = 'none';
            } else {
                elements.profilePicHudEmoji.textContent = gameState.playerAvatar;
                elements.profilePicHudImg.style.display = 'none';
                elements.profilePicHudEmoji.style.display = 'block';
            }
        }

        function updateProfileDisplay() {
            elements.profileName.textContent = gameState.playerName;
            
            // Update profile picture display
            if (gameState.playerProfilePic) {
                elements.profilePic.innerHTML = `
                    <img src="${gameState.playerProfilePic}" alt="${gameState.playerName}" style="width: 100%; height: 100%; object-fit: cover;">
                    <div class="profile-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            } else {
                elements.profilePic.innerHTML = `
                    ${gameState.playerAvatar}
                    <div class="profile-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            }
        }

        function populateGameData() {
            // Populate game modes grid
            if (elements.modesGrid) {
                elements.modesGrid.innerHTML = gameState.gameModes.map(mode => `
                    <div class="card mode-card" data-mode="${mode.id}">
                        <div class="card-icon" style="background: rgba(${hexToRgb(mode.color)}, 0.2); color: ${mode.color};">
                            <i class="fas fa-${mode.icon}"></i>
                        </div>
                        <h3 class="card-title">${mode.name}</h3>
                        <p class="card-description">${mode.description}</p>
                        <div class="flex justify-between items-center mt-md">
                            <span class="text-sm text-gray-400">${mode.minPlayers}-${mode.maxPlayers} Players</span>
                            <div class="flex gap-sm">
                                <button class="btn btn-outline btn-sm view-mode-btn" data-mode="${mode.id}">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button class="btn btn-primary btn-sm play-mode-btn" data-mode="${mode.id}">
                                    Play
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function populateCategories() {
            // Populate categories for setup screen
            if (elements.categorySelect) {
                elements.categorySelect.innerHTML = gameState.categories.map(category => `
                    <option value="${category.id}">${category.name}</option>
                `).join('');
            }
        }

        function populateCategoriesScreen() {
            // Populate categories screen
            if (elements.categoriesGrid) {
                elements.categoriesGrid.innerHTML = gameState.categories.map(category => `
                    <div class="card category-card">
                        <div class="card-icon" style="background: rgba(${hexToRgb(category.color)}, 0.2); color: ${category.color};">
                            <i class="fas fa-${category.icon}"></i>
                        </div>
                        <h3 class="card-title">${category.name}</h3>
                        <p class="card-description">${category.description}</p>
                        <div class="category-progress">
                            <span class="text-sm text-gray-400">Played: 0 times</span>
                            <button class="btn btn-primary btn-sm play-category-btn" data-category="${category.id}">
                                Play This Category
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function populateStats() {
            // Calculate stats
            const accuracy = gameState.totalQuestions > 0 ? 
                Math.round((gameState.totalCorrectAnswers / gameState.totalQuestions) * 100) : 0;
            
            // Update stats screen
            elements.totalGamesStat.textContent = gameState.totalGames;
            elements.accuracyStat.textContent = `${accuracy}%`;
            elements.winStreakStat.textContent = gameState.winStreak;
            elements.totalPointsStat.textContent = gameState.totalScore.toLocaleString();
        }

        function populateAchievements() {
            if (elements.achievementsList) {
                elements.achievementsList.innerHTML = gameState.achievements.map(achievement => `
                    <div class="player-item ${achievement.unlocked ? '' : 'opacity-50'}">
                        <div class="flex items-center gap-md">
                            <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center">
                                <i class="fas ${achievement.unlocked ? 'fa-trophy text-yellow' : 'fa-lock text-gray-400'}"></i>
                            </div>
                            <div>
                                <div class="player-name">${achievement.name}</div>
                                <div class="text-xs text-gray-400">${achievement.description}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function populateLeaderboard() {
            // Sample leaderboard data
            const leaderboardData = [
                { name: 'Trivia Master', score: 12500, games: 42 },
                { name: 'Quiz Whiz', score: 9800, games: 35 },
                { name: 'Brainiac', score: 8750, games: 28 },
                { name: 'Knowledge King', score: 7200, games: 25 },
                { name: 'Fact Finder', score: 6500, games: 22 },
                { name: gameState.playerName, score: gameState.totalScore, games: gameState.totalGames }
            ].sort((a, b) => b.score - a.score);
            
            if (elements.leaderboard) {
                elements.leaderboard.innerHTML = leaderboardData.map((player, index) => `
                    <div class="leaderboard-item">
                        <div class="flex items-center gap-md">
                            <div class="leaderboard-rank ${index < 3 ? 'bg-yellow text-black' : 'bg-gray-700'}">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="player-name ${player.name === gameState.playerName ? 'text-yellow' : ''}">
                                    ${player.name} ${player.name === gameState.playerName ? '(You)' : ''}
                                </div>
                                <div class="text-xs text-gray-400">${player.games} games played</div>
                            </div>
                        </div>
                        <div class="text-lg font-bold">${player.score.toLocaleString()}</div>
                    </div>
                `).join('');
            }
        }

        function populateOnlineSelectors() {
            // Populate online mode selector
            if (elements.onlineModeSelect) {
                elements.onlineModeSelect.innerHTML = gameState.gameModes.map(mode => `
                    <option value="${mode.id}">${mode.name}</option>
                `).join('');
            }
            
            // Populate online category selector
            if (elements.onlineCategorySelect) {
                elements.onlineCategorySelect.innerHTML = gameState.categories.map(category => `
                    <option value="${category.id}">${category.name}</option>
                `).join('');
            }
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        function darkenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, (num >> 16) - amt);
            const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
            const B = Math.max(0, (num & 0x0000FF) - amt);
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        // ===== NAVIGATION =====
        function updateNavigation(screenId) {
            // Save current state before navigation
            if (gameState.isGameActive) {
                saveGameState();
            }
            
            // Update screen history
            if (screenId !== gameState.currentScreen) {
                gameState.screenHistory.push(screenId);
                gameState.currentScreen = screenId;
            }
            
            // Update bottom navigation
            elements.navItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.screen === screenId) {
                    item.classList.add('active');
                }
            });
            
            // Update URL hash
            window.location.hash = screenId;
            
            // Hide all screens
            Object.values(elements.screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show current screen
            if (elements.screens[screenId]) {
                elements.screens[screenId].classList.add('active');
            }
            
            // Update specific screens
            if (screenId === 'stats') {
                populateStats();
                populateAchievements();
                populateLeaderboard();
            } else if (screenId === 'profile') {
                updateProfileDisplay();
            } else if (screenId === 'categories') {
                populateCategoriesScreen();
            }
            
            // Reset game state if leaving game screen
            if (screenId !== 'game' && gameState.isGameActive) {
                resetGameState();
            }
        }

        function resetGameState() {
            if (gameState.isGameActive) {
                clearInterval(gameState.timerInterval);
                clearTimeout(gameState.buzzerTimeout);
                gameState.isGameActive = false;
                gameState.isBuzzerActive = false;
                gameState.hasBuzzed = false;
                elements.currentPlayerIndicator.classList.add('hidden');
            }
        }

        function goBack() {
            if (gameState.screenHistory.length > 1) {
                gameState.screenHistory.pop(); // Remove current
                const previousScreen = gameState.screenHistory.pop(); // Get previous
                if (previousScreen) {
                    updateNavigation(previousScreen);
                }
            }
        }

        // ===== PLAYER MANAGEMENT =====
        function addPlayer(name) {
            if (!name.trim()) return;
            
            const playerName = name.trim().substring(0, 20);
            
            if (!gameState.players.includes(playerName)) {
                gameState.players.push(playerName);
                gameState.playerScores[playerName] = 0;
                updatePlayersList();
            }
            
            elements.playerNameInput.value = '';
            elements.playerNameInput.focus();
        }

        function removePlayer(name) {
            gameState.players = gameState.players.filter(p => p !== name);
            delete gameState.playerScores[name];
            updatePlayersList();
        }

        function updatePlayersList() {
            const list = elements.playersList;
            
            if (gameState.players.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-8">No players added yet</div>';
                return;
            }
            
            list.innerHTML = gameState.players.map((player, index) => `
                <div class="player-item">
                    <div class="flex items-center gap-md">
                        <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center font-bold">
                            ${index + 1}
                        </div>
                        <div class="player-name">${player}</div>
                    </div>
                    <button class="text-gray-400 hover:text-red-400 remove-player-btn" data-player="${player}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function updateOnlinePlayersList() {
            const list = elements.onlinePlayersList;
            
            if (gameState.onlinePlayers.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-8">No players connected</div>';
                return;
            }
            
            list.innerHTML = gameState.onlinePlayers.map(player => `
                <div class="player-item">
                    <div class="flex items-center gap-md">
                        <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div class="player-name">${player.name}</div>
                            <div class="text-xs text-gray-400">${player.isHost ? 'Host' : 'Player'}</div>
                        </div>
                    </div>
                    ${player.isHost ? '<span class="text-yellow"><i class="fas fa-crown"></i></span>' : ''}
                </div>
            `).join('');
            
            // Enable start button for host if enough players
            if (gameState.isHost) {
                const mode = gameState.gameModes.find(m => m.id === gameState.currentGameMode);
                elements.startOnlineGameBtn.disabled = gameState.onlinePlayers.length < mode.minPlayers;
            }
        }

        // ===== GAME SETUP =====
        function setupStepNavigation() {
            const steps = document.querySelectorAll('.step');
            const sections = document.querySelectorAll('.setup-section');
            
            // Show step 1 by default
            steps.forEach(step => step.classList.remove('active'));
            sections.forEach(section => section.classList.remove('active'));
            
            steps[0].classList.add('active');
            sections[0].classList.add('active');
        }

        function navigateToStep(stepNumber) {
            const steps = document.querySelectorAll('.step');
            const sections = document.querySelectorAll('.setup-section');
            
            // Update steps
            steps.forEach((step, index) => {
                step.classList.remove('active');
                if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            // Update sections
            sections.forEach((section, index) => {
                section.classList.remove('active');
                if (index + 1 === stepNumber) {
                    section.classList.add('active');
                }
            });
            
            // Update final players list and settings
            if (stepNumber === 3) {
                updateFinalPlayersList();
                updateSelectedMode();
                updateSettingsDisplay();
            }
        }

        function updateFinalPlayersList() {
            const list = elements.finalPlayersList;
            list.innerHTML = gameState.players.map((player, index) => `
                <div class="player-item">
                    <div class="flex items-center gap-md">
                        <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center font-bold">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="player-name">${player}</div>
                            <div class="text-xs text-gray-400">Ready to play</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateSelectedMode() {
            const mode = gameState.gameModes.find(m => m.id === gameState.currentGameMode);
            if (mode) {
                elements.selectedModeName.textContent = mode.name;
                elements.selectedModeDescription.textContent = mode.description;
                
                // Update setup screen title
                elements.setupModeTitle.textContent = `${mode.name} Setup`;
                elements.setupModeDescription.textContent = mode.description;
            }
        }

        function updateSettingsDisplay() {
            elements.settingsQuestionCount.textContent = elements.questionCount.value;
            elements.settingsCategory.textContent = elements.categorySelect.options[elements.categorySelect.selectedIndex].text;
            elements.settingsDifficulty.textContent = elements.difficultySelect.options[elements.difficultySelect.selectedIndex].text;
        }

        // ===== QUESTION MANAGEMENT =====
        async function fetchQuestions(category, difficulty, limit) {
            try {
                const apiCategory = API_CONFIG.CATEGORIES[category] || 'general_knowledge';
                
                // Build URL with parameters
                const url = new URL(API_CONFIG.BASE_URL + '/questions');
                url.searchParams.append('limit', limit);
                url.searchParams.append('categories', apiCategory);
                url.searchParams.append('difficulties', difficulty);
                
                console.log('Fetching questions from:', url.toString());
                
                const response = await fetch(url.toString());
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Transform API data to our format
                return data.map(q => ({
                    question: q.question.text,
                    answers: [
                        { text: q.correctAnswer, correct: true },
                        ...q.incorrectAnswers.map(ans => ({ text: ans, correct: false }))
                    ].sort(() => Math.random() - 0.5),
                    category: category,
                    difficulty: q.difficulty || difficulty
                }));
                
            } catch (error) {
                console.error('Error fetching questions:', error);
                
                // Fallback to local questions if API fails
                return getLocalQuestions(category, limit);
            }
        }

        function getLocalQuestions(category, limit) {
            // Local fallback questions
            const localQuestions = {
                general: [
                    {
                        question: "What is the capital of France?",
                        answers: [
                            { text: "London", correct: false },
                            { text: "Paris", correct: true },
                            { text: "Berlin", correct: false },
                            { text: "Madrid", correct: false }
                        ],
                        difficulty: "easy"
                    },
                    {
                        question: "How many continents are there?",
                        answers: [
                            { text: "5", correct: false },
                            { text: "6", correct: false },
                            { text: "7", correct: true },
                            { text: "8", correct: false }
                        ],
                        difficulty: "easy"
                    },
                    {
                        question: "What is the largest planet in our solar system?",
                        answers: [
                            { text: "Earth", correct: false },
                            { text: "Jupiter", correct: true },
                            { text: "Saturn", correct: false },
                            { text: "Mars", correct: false }
                        ],
                        difficulty: "easy"
                    },
                    {
                        question: "Who wrote 'Romeo and Juliet'?",
                        answers: [
                            { text: "Charles Dickens", correct: false },
                            { text: "William Shakespeare", correct: true },
                            { text: "Jane Austen", correct: false },
                            { text: "Mark Twain", correct: false }
                        ],
                        difficulty: "medium"
                    },
                    {
                        question: "What is the chemical symbol for gold?",
                        answers: [
                            { text: "Go", correct: false },
                            { text: "Gd", correct: false },
                            { text: "Au", correct: true },
                            { text: "Ag", correct: false }
                        ],
                        difficulty: "medium"
                    }
                ],
                science: [
                    {
                        question: "What is the chemical symbol for water?",
                        answers: [
                            { text: "H2O", correct: true },
                            { text: "CO2", correct: false },
                            { text: "O2", correct: false },
                            { text: "NaCl", correct: false }
                        ],
                        difficulty: "easy"
                    },
                    {
                        question: "What planet is known as the Red Planet?",
                        answers: [
                            { text: "Venus", correct: false },
                            { text: "Mars", correct: true },
                            { text: "Jupiter", correct: false },
                            { text: "Saturn", correct: false }
                        ],
                        difficulty: "easy"
                    }
                ]
            };
            
            const questions = localQuestions[category] || localQuestions.general;
            return questions.slice(0, limit);
        }

        // ===== GAME MODE FUNCTIONS =====
        async function startGame() {
            if (!gameState.currentGameMode) {
                alert('Please select a game mode');
                return;
            }
            
            const mode = gameState.gameModes.find(m => m.id === gameState.currentGameMode);
            
            if (gameState.players.length < mode.minPlayers) {
                alert(`Need at least ${mode.minPlayers} players to start ${mode.name}`);
                return;
            }
            
            // Reset game state based on mode
            gameState.isGameActive = true;
            gameState.currentQuestionIndex = 0;
            gameState.playerTurn = 0;
            gameState.currentPlayerIndex = 0;
            gameState.hintCount = 2;
            
            // Initialize player scores
            gameState.players.forEach(player => {
                gameState.playerScores[player] = 0;
            });
            
            gameState.score = 0;
            gameState.lives = mode.lives;
            gameState.timeBonus = 0;
            gameState.timer = mode.timePerQuestion;
            gameState.correctAnswers = 0;
            gameState.currentStreak = 0;
            gameState.maxStreak = 0;
            gameState.gameStartTime = Date.now();
            
            // Get game settings
            gameState.totalQuestions = parseInt(elements.questionCount.value);
            gameState.selectedCategory = elements.categorySelect.value;
            gameState.selectedDifficulty = elements.difficultySelect.value;
            
            // Reset buzzer state
            gameState.isBuzzerActive = false;
            gameState.hasBuzzed = false;
            
            // Update UI
            elements.modeName.textContent = mode.name;
            elements.currentGameMode.innerHTML = `<i class="fas fa-${mode.icon}"></i> <span>${mode.name}</span>`;
            elements.playerScore.textContent = '0';
            elements.playerScoreHud.textContent = '0';
            elements.playerLives.textContent = gameState.lives;
            elements.timeBonus.textContent = '0';
            elements.currentQuestionNum.textContent = `1/${gameState.totalQuestions}`;
            elements.totalQuestions.textContent = gameState.totalQuestions;
            
            // Show/hide buzzer container based on mode
            if (gameState.currentGameMode === 'buzzer') {
                elements.buzzerContainer.classList.remove('hidden');
                elements.gameControls.classList.add('hidden');
                elements.nextQuestionBtn.disabled = false; // Enable next question button for buzzer mode
            } else {
                elements.buzzerContainer.classList.add('hidden');
                elements.gameControls.classList.remove('hidden');
                elements.nextQuestionBtn.disabled = true; // Disabled until answer is selected
            }
            
            // Update hint button
            elements.hintBtn.innerHTML = `<i class="fas fa-lightbulb"></i> Hint (${gameState.hintCount} left)`;
            elements.hintBtn.disabled = gameState.hintCount === 0;
            
            // Hide current player indicator initially
            elements.currentPlayerIndicator.classList.add('hidden');
            
            // Navigate to game screen
            updateNavigation('game');
            
            // Fetch and load first question
            await loadQuestion();
            
            // Show current player for turn-based modes
            if (gameState.currentGameMode !== 'countdown' && gameState.currentGameMode !== 'buzzer') {
                updateCurrentPlayerIndicator();
            }
        }

        function updateCurrentPlayerIndicator() {
            if (gameState.players.length > 0 && gameState.currentGameMode !== 'solo') {
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                elements.currentPlayerIndicator.textContent = `Current Player: ${currentPlayer}`;
                elements.currentPlayerIndicator.classList.remove('hidden');
            }
        }

        async function loadQuestion() {
            if (gameState.currentQuestionIndex >= gameState.totalQuestions) {
                endGame();
                return;
            }
            
            // Show loading state
            elements.questionText.textContent = 'Loading question...';
            elements.answersContainer.innerHTML = '<div class="text-center py-8">Loading...</div>';
            
            try {
                // Fetch questions for the current category
                const questions = await fetchQuestions(
                    gameState.selectedCategory,
                    gameState.selectedDifficulty,
                    gameState.totalQuestions
                );
                
                if (!questions || questions.length === 0) {
                    throw new Error('No questions available');
                }
                
                const question = questions[gameState.currentQuestionIndex];
                gameState.currentQuestion = question;
                
                // Update UI
                elements.currentQuestion.textContent = gameState.currentQuestionIndex + 1;
                elements.currentQuestionNum.textContent = `${gameState.currentQuestionIndex + 1}/${gameState.totalQuestions}`;
                
                const category = gameState.categories.find(c => c.id === gameState.selectedCategory);
                elements.questionCategory.textContent = category ? category.name : 'General Knowledge';
                
                elements.difficultyLabel.textContent = question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1);
                elements.questionText.textContent = question.question;
                
                // Clear and populate answers
                elements.answersContainer.innerHTML = '';
                const letters = ['A', 'B', 'C', 'D'];
                
                // Make sure we have exactly 4 answers
                const answers = [...question.answers];
                while (answers.length < 4) {
                    answers.push({ text: `Answer ${answers.length + 1}`, correct: false });
                }
                
                // Shuffle answers
                const shuffledAnswers = answers.sort(() => Math.random() - 0.5);
                
                shuffledAnswers.forEach((answer, index) => {
                    const answerElement = document.createElement('div');
                    answerElement.className = 'answer-option';
                    answerElement.innerHTML = `
                        <div class="answer-letter">${letters[index]}</div>
                        <div class="flex-1">${answer.text}</div>
                    `;
                    answerElement.onclick = () => selectAnswer(answer.correct, answerElement, question.difficulty);
                    elements.answersContainer.appendChild(answerElement);
                });
                
                // Reset controls
                if (gameState.currentGameMode !== 'buzzer') {
                    elements.nextQuestionBtn.disabled = true;
                }
                elements.hintBtn.disabled = gameState.hintCount === 0;
                elements.hintBtn.innerHTML = `<i class="fas fa-lightbulb"></i> Hint (${gameState.hintCount} left)`;
                
                // Reset buzzer if in buzzer mode
                if (gameState.currentGameMode === 'buzzer') {
                    resetBuzzerState();
                }
                
                // Start timer with mode-specific settings
                if (gameState.currentGameMode !== 'buzzer' && gameState.timer > 0) {
                    startQuestionTimer();
                }
                
            } catch (error) {
                console.error('Error loading question:', error);
                showFeedback('Error loading question. Please try again.', 'incorrect');
                
                // Try again after delay
                setTimeout(() => loadQuestion(), 2000);
            }
        }

        function resetBuzzerState() {
            clearTimeout(gameState.buzzerTimeout);
            gameState.isBuzzerActive = true;
            gameState.hasBuzzed = false;
            
            elements.buzzerButton.className = 'buzzer-button buzzer-ready';
            elements.buzzerButton.disabled = false;
            elements.buzzerInstruction.textContent = 'Wait for the question to be read, then buzz in!';
            elements.playerBuzzed.textContent = '';
            elements.answersContainer.style.opacity = '0.5';
            
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.style.pointerEvents = 'none';
            });
            
            // Auto-enable answers after 3 seconds for buzzer mode
            gameState.buzzerTimeout = setTimeout(() => {
                if (gameState.isBuzzerActive && !gameState.hasBuzzed) {
                    elements.buzzerInstruction.textContent = 'You can now buzz in!';
                    elements.buzzerButton.disabled = false;
                }
            }, 3000);
        }

        function selectAnswer(isCorrect, element, difficulty) {
            if (!gameState.isGameActive) return;
            
            // For buzzer mode, check if player has buzzed in
            if (gameState.currentGameMode === 'buzzer' && !gameState.hasBuzzed) {
                showFeedback('You must buzz in first!', 'incorrect');
                return;
            }
            
            // Disable all answers
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.style.pointerEvents = 'none';
            });
            
            // Calculate base score based on difficulty
            let baseScore = 100;
            if (difficulty === 'medium') baseScore = 150;
            if (difficulty === 'hard') baseScore = 200;
            
            // Apply mode-specific scoring
            let pointsEarned = baseScore;
            const mode = gameState.gameModes.find(m => m.id === gameState.currentGameMode);
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            switch (gameState.currentGameMode) {
                case 'classic':
                    // Progressive difficulty bonus
                    const difficultyBonus = Math.floor(gameState.currentQuestionIndex / 3) * 25;
                    pointsEarned += difficultyBonus;
                    break;
                    
                case 'countdown':
                    // Time bonus: up to 50 extra points for quick answers
                    const timeRemaining = parseInt(elements.gameTimer.textContent);
                    const timeBonus = Math.max(0, Math.floor((gameState.timer - timeRemaining) / 3) * 5);
                    pointsEarned += timeBonus;
                    gameState.timeBonus += timeBonus;
                    elements.timeBonus.textContent = gameState.timeBonus;
                    break;
                    
                case 'ladder':
                    // Level-based scoring (current level = streak + 1)
                    pointsEarned *= (gameState.currentStreak + 1);
                    break;
                    
                case 'battle':
                    // Elimination bonus
                    pointsEarned += gameState.players.length * 20;
                    break;
                    
                case 'buzzer':
                    // Buzzer mode points
                    pointsEarned += 50; // Bonus for buzzing in first
                    // Reset buzzer state for next question
                    gameState.hasBuzzed = false;
                    break;
                    
                case 'solo':
                    // Accuracy bonus
                    const accuracyBonus = Math.floor((gameState.correctAnswers / (gameState.currentQuestionIndex + 1)) * 50);
                    pointsEarned += accuracyBonus;
                    break;
            }
            
            // Update streak
            if (isCorrect) {
                gameState.currentStreak++;
                gameState.maxStreak = Math.max(gameState.maxStreak, gameState.currentStreak);
            } else {
                gameState.currentStreak = 0;
            }
            
            // Mark correct/incorrect
            if (isCorrect) {
                element.classList.add('selected');
                gameState.score += pointsEarned;
                gameState.playerScores[currentPlayer] += pointsEarned;
                gameState.correctAnswers++;
                
                // Update score display
                elements.playerScore.textContent = gameState.score;
                elements.playerScoreHud.textContent = gameState.score;
                
                // Show correct feedback
                showFeedback(`+${pointsEarned} points!`, 'correct');
            } else {
                element.classList.add('incorrect');
                gameState.lives--;
                elements.playerLives.textContent = gameState.lives;
                
                // Mark correct answer
                const correctAnswer = gameState.currentQuestion.answers.find(a => a.correct);
                if (correctAnswer) {
                    document.querySelectorAll('.answer-option').forEach(opt => {
                        const answerText = opt.querySelector('.flex-1').textContent;
                        if (answerText === correctAnswer.text) {
                            opt.classList.add('selected');
                        }
                    });
                }
                
                // Show incorrect feedback
                showFeedback(`-1 life`, 'incorrect');
            }
            
            // Stop timer
            clearInterval(gameState.timerInterval);
            clearTimeout(gameState.buzzerTimeout);
            
            // Enable next button for all modes
            elements.nextQuestionBtn.disabled = false;
            
            // Check if game over
            if (gameState.lives <= 0) {
                setTimeout(() => endGame(), 1500);
            }
        }

        function showFeedback(message, type) {
            const feedback = document.createElement('div');
            feedback.className = `feedback-message feedback-${type}`;
            feedback.textContent = message;
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 1500);
        }

        function showHint() {
            if (gameState.hintCount <= 0 || !gameState.currentQuestion) return;
            
            gameState.hintCount--;
            elements.hintBtn.innerHTML = `<i class="fas fa-lightbulb"></i> Hint (${gameState.hintCount} left)`;
            elements.hintBtn.disabled = gameState.hintCount === 0;
            
            // Create hint display
            const hintDiv = document.createElement('div');
            hintDiv.className = 'hint-display';
            
            // Get the correct answer
            const correctAnswer = gameState.currentQuestion.answers.find(a => a.correct);
            
            if (correctAnswer) {
                const answerLength = correctAnswer.text.length;
                const hint = 'The correct answer has ' + answerLength + ' characters';
                hintDiv.textContent = hint;
                
                document.body.appendChild(hintDiv);
                
                // Remove hint after 5 seconds
                setTimeout(() => {
                    hintDiv.style.opacity = '0';
                    hintDiv.style.transform = 'translate(-50%, -50%) scale(0.9)';
                    setTimeout(() => {
                        if (hintDiv.parentNode) {
                            hintDiv.parentNode.removeChild(hintDiv);
                        }
                    }, 300);
                }, 5000);
            }
        }

        function showNotification(message, type = 'info') {
            if (!gameState.settings.notifications) return;
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="flex items-center gap-sm">
                    <i class="fas ${type === 'achievement' ? 'fa-trophy text-yellow' : 'fa-info-circle text-yellow'}"></i>
                    <div>
                        <div class="font-semibold">${type === 'achievement' ? 'Achievement Unlocked!' : 'Notification'}</div>
                        <div class="text-sm text-gray-400">${message}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        function startQuestionTimer() {
            clearInterval(gameState.timerInterval);
            
            let timeLeft = gameState.timer;
            updateTimerDisplay(timeLeft);
            
            gameState.timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(gameState.timerInterval);
                    timeUp();
                }
            }, 1000);
        }

        function updateTimerDisplay(timeLeft) {
            elements.gameTimer.textContent = `${timeLeft}s`;
            
            // Visual feedback for low time
            if (timeLeft <= 10) {
                elements.gameTimer.style.color = 'var(--red)';
            } else if (timeLeft <= 20) {
                elements.gameTimer.style.color = 'var(--orange)';
            } else {
                elements.gameTimer.style.color = 'var(--yellow)';
            }
        }

        function timeUp() {
            // Disable all answers
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.style.pointerEvents = 'none';
            });
            
            // Mark correct answer
            const correctAnswer = gameState.currentQuestion.answers.find(a => a.correct);
            if (correctAnswer) {
                document.querySelectorAll('.answer-option').forEach(opt => {
                    const answerText = opt.querySelector('.flex-1').textContent;
                    if (answerText === correctAnswer.text) {
                        opt.classList.add('selected');
                    }
                });
            }
            
            // Mode-specific time up penalties
            switch (gameState.currentGameMode) {
                case 'countdown':
                    // No lives lost, just no points
                    break;
                case 'ladder':
                    // Lose a level on time up
                    if (gameState.currentStreak > 0) {
                        gameState.currentStreak = Math.max(0, gameState.currentStreak - 1);
                    }
                    break;
                default:
                    // Lose a life for most modes
                    if (gameState.currentGameMode !== 'buzzer') {
                        gameState.lives--;
                        elements.playerLives.textContent = gameState.lives;
                    }
                    break;
            }
            
            // Enable next button
            elements.nextQuestionBtn.disabled = false;
            
            // Check if game over
            if (gameState.lives <= 0) {
                setTimeout(() => endGame(), 1500);
            }
        }

        function nextQuestion() {
            gameState.currentQuestionIndex++;
            
            // Move to next player for turn-based modes
            if (gameState.currentGameMode !== 'countdown' && gameState.currentGameMode !== 'buzzer') {
                gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
                updateCurrentPlayerIndicator();
            }
            
            if (gameState.currentQuestionIndex >= gameState.totalQuestions) {
                endGame();
                return;
            }
            
            // Load next question
            loadQuestion();
        }

        function endGame() {
            gameState.isGameActive = false;
            clearInterval(gameState.timerInterval);
            clearTimeout(gameState.buzzerTimeout);
            
            // Calculate final stats
            const timePlayed = Math.floor((Date.now() - gameState.gameStartTime) / 1000);
            const accuracy = gameState.totalQuestions > 0 ? 
                Math.round((gameState.correctAnswers / gameState.totalQuestions) * 100) : 0;
            
            // Determine winner
            let winner = gameState.playerName;
            let highestScore = gameState.score;
            
            if (gameState.players.length > 0) {
                // Find player with highest score
                for (const [player, score] of Object.entries(gameState.playerScores)) {
                    if (score > highestScore) {
                        highestScore = score;
                        winner = player;
                    }
                }
            }
            
            // Update player stats
            gameState.totalGames++;
            gameState.totalCorrectAnswers += gameState.correctAnswers;
            gameState.totalQuestions += gameState.totalQuestions;
            gameState.totalScore += gameState.score;
            
            if (gameState.maxStreak > gameState.highestStreak) {
                gameState.highestStreak = gameState.maxStreak;
            }
            
            // Update win streak
            if (winner === gameState.playerName || (gameState.players.length === 0 && gameState.score > 0)) {
                gameState.winStreak++;
            } else {
                gameState.winStreak = 0;
            }
            
            // Check achievements
            checkAchievements();
            
            // Save updated data
            saveGameState();
            
            // Update modal
            elements.finalScore.textContent = gameState.score.toLocaleString();
            elements.correctAnswersModal.textContent = `${gameState.correctAnswers}/${gameState.totalQuestions}`;
            elements.timePlayed.textContent = `${timePlayed}s`;
            elements.bonusEarned.textContent = gameState.timeBonus;
            elements.winnerName.textContent = winner;
            elements.performanceSummary.textContent = 
                `Accuracy: ${accuracy}% | Longest Streak: ${gameState.maxStreak}`;
            
            // Update HUD
            updateHUD();
            
            // Show modal
            openModal('gameCompleteModal');
        }

        // ===== BUZZER MODE FUNCTIONS =====
        function buzzIn() {
            if (gameState.currentGameMode !== 'buzzer' || !gameState.isBuzzerActive) return;
            
            // Disable buzzer for this player
            gameState.hasBuzzed = true;
            gameState.isBuzzerActive = false;
            
            elements.buzzerButton.className = 'buzzer-button buzzer-buzzed';
            elements.buzzerButton.disabled = true;
            elements.buzzerInstruction.textContent = 'You buzzed in! Answer now:';
            elements.playerBuzzed.textContent = gameState.playerName;
            
            // Enable answer selection
            elements.answersContainer.style.opacity = '1';
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.style.pointerEvents = 'auto';
            });
        }

        // ===== ACHIEVEMENTS =====
        function checkAchievements() {
            // First game
            if (gameState.totalGames === 1) {
                unlockAchievement('first_game');
            }
            
            // Perfect game
            if (gameState.correctAnswers === gameState.totalQuestions && gameState.totalQuestions >= 5) {
                unlockAchievement('perfect_game');
            }
            
            // Streak of 10
            if (gameState.maxStreak >= 10) {
                unlockAchievement('streak_10');
            }
            
            // Speed demon (answered in under 3 seconds)
            // This would require tracking answer times - for now, simulate
            if (Math.random() > 0.7) {
                unlockAchievement('speed_demon');
            }
            
            // Mode master (check if played all modes)
            // This would require tracking played modes
            
            // Trivia champion (10 wins)
            if (gameState.winStreak >= 10) {
                unlockAchievement('trivia_champion');
            }
        }

        function unlockAchievement(achievementId) {
            const achievement = gameState.achievements.find(a => a.id === achievementId);
            if (achievement && !achievement.unlocked) {
                achievement.unlocked = true;
                if (gameState.settings.achievementNotifications) {
                    showNotification(`You unlocked: ${achievement.name}!`, 'achievement');
                }
                saveGameState();
                populateAchievements();
            }
        }

        // ===== MODAL FUNCTIONS =====
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Special handling for specific modals
                if (modalId === 'nameModal') {
                    elements.newUsername.value = gameState.playerName;
                } else if (modalId === 'avatarModal') {
                    populateAvatarGrid();
                } else if (modalId === 'themeModal') {
                    populateThemeColors();
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function populateAvatarGrid() {
            const emojis = ['ðŸ˜Ž', 'ðŸ¤“', 'ðŸ˜Š', 'ðŸ˜„', 'ðŸ˜œ', 'ðŸ¤©', 'ðŸ§', 'ðŸ¤ ', 'ðŸ˜‡', 'ðŸ¥³', 'ðŸ¤–', 'ðŸ‘¾'];
            elements.avatarGrid.innerHTML = emojis.map(emoji => `
                <div class="profile-pic avatar-option text-3xl flex items-center justify-center" 
                     data-avatar="${emoji}" 
                     onclick="selectAvatar('${emoji}')"
                     style="width: 60px; height: 60px; margin: 0 auto; cursor: pointer;">
                    ${emoji}
                </div>
            `).join('');
            
            // Set up file upload
            elements.avatarUpload.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        elements.avatarPreview.src = event.target.result;
                        elements.avatarPreview.classList.remove('hidden');
                        // Store the uploaded image
                        gameState.playerProfilePic = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function populateThemeColors() {
            const colors = [
                { name: 'Yellow', value: '#FFDE21' },
                { name: 'Purple', value: '#6C5CE7' },
                { name: 'Red', value: '#FF7675' },
                { name: 'Green', value: '#00B894' },
                { name: 'Blue', value: '#3498DB' },
                { name: 'Pink', value: '#FD79A8' },
                { name: 'Orange', value: '#FDCB6E' },
                { name: 'Cyan', value: '#00CEC9' }
            ];
            
            elements.themeColors.innerHTML = colors.map(color => `
                <div class="theme-option" data-color="${color.value}" onclick="selectThemeColor('${color.value}')">
                    <div class="theme-color" style="background: ${color.value};"></div>
                    <div class="theme-name">${color.name}</div>
                </div>
            `).join('');
        }

        function selectAvatar(avatar) {
            gameState.playerAvatar = avatar;
            gameState.playerProfilePic = null; // Clear uploaded photo
            
            // Remove selection from all avatars
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.style.border = 'none';
            });
            
            // Add selection to chosen avatar
            event.target.style.border = '3px solid var(--yellow)';
            
            // Hide preview
            elements.avatarPreview.classList.add('hidden');
        }

        function selectThemeColor(color) {
            // Remove selection from all colors
            document.querySelectorAll('.theme-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to chosen color
            event.target.closest('.theme-option').classList.add('selected');
            
            // Save theme color
            gameState.settings.themeColor = color;
            applyThemeColor(color);
        }

        // ===== ONLINE MULTIPLAYER =====
        async function createRealRoom() {
            const roomName = elements.roomName.value.trim() || `${gameState.playerName}'s Room`;
            const modeId = elements.onlineModeSelect.value;
            const questions = elements.onlineQuestionCount.value;
            const categoryId = elements.onlineCategorySelect.value;
            const maxPlayers = elements.maxPlayers.value;
            
            // Generate secure room code
            gameState.roomCode = generateSecureRoomCode();
            
            try {
                // Connect to room as host
                await gameState.realTimeService.connectToRoom(
                    gameState.roomCode, 
                    gameState.playerName, 
                    true
                );
                
                // Set up event listeners
                gameState.realTimeService.on('player_joined', (player) => {
                    gameState.onlinePlayers.push({
                        name: player.player_name,
                        isHost: player.is_host
                    });
                    updateOnlinePlayersList();
                    showNotification(`${player.player_name} joined!`);
                });
                
                gameState.realTimeService.on('player_left', (player) => {
                    gameState.onlinePlayers = gameState.onlinePlayers.filter(
                        p => p.name !== player.player_name
                    );
                    updateOnlinePlayersList();
                    showNotification(`${player.player_name} left`);
                });
                
                gameState.realTimeService.on('game_state_updated', (state) => {
                    syncGameState(state);
                });
                
                // Update room in database
                await supabaseClient
                    .from('game_rooms')
                    .update({
                        room_name: roomName,
                        game_mode: modeId,
                        max_players: parseInt(maxPlayers)
                    })
                    .eq('room_code', gameState.roomCode);
                
                // Set game settings
                gameState.currentGameMode = modeId;
                gameState.totalQuestions = parseInt(questions);
                gameState.selectedCategory = categoryId;
                gameState.isHost = true;
                gameState.isOnlineGame = true;
                
                // Update UI
                elements.roomCodeDisplay.textContent = gameState.roomCode;
                updateNavigation('waiting');
                closeModal('createRoomModal');
                showNotification('Room created! Share the code.');
                
            } catch (error) {
                console.error('Room creation failed:', error);
                showNotification('Failed to create room', 'error');
            }
        }

        async function joinRealRoom() {
            const roomCode = elements.joinRoomCode.value.trim().toUpperCase();
            
            // Validate room code
            if (!roomCode || roomCode.length !== 6) {
                showNotification('Please enter a valid 6-digit code', 'error');
                return;
            }
            
            try {
                // Connect to room as player
                await gameState.realTimeService.connectToRoom(
                    roomCode,
                    gameState.playerName,
                    false
                );
                
                gameState.roomCode = roomCode;
                gameState.isHost = false;
                gameState.isOnlineGame = true;
                
                // Get existing players
                const { data: players } = await supabaseClient
                    .from('room_players')
                    .select('player_name, is_host')
                    .eq('room_code', roomCode);
                    
                gameState.onlinePlayers = players.map(p => ({
                    name: p.player_name,
                    isHost: p.is_host
                }));
                
                // Get room settings
                const { data: room } = await supabaseClient
                    .from('game_rooms')
                    .select('*')
                    .eq('room_code', roomCode)
                    .single();
                    
                gameState.currentGameMode = room.game_mode;
                gameState.totalQuestions = 10; // Default or from room settings
                
                // Update UI
                elements.roomCodeDisplay.textContent = roomCode;
                updateOnlinePlayersList();
                updateNavigation('waiting');
                closeModal('joinRoomModal');
                showNotification('Joined room successfully!');
                
            } catch (error) {
                console.error('Join failed:', error);
                showNotification('Failed to join room', 'error');
            }
        }

        function syncGameState(state) {
            if (!gameState.isOnlineGame) return;
            
            // Only update if we're not the host making changes
            if (gameState.isHost) return;
            
            // Update local game state
            gameState.currentQuestion = state.current_question;
            gameState.currentQuestionIndex = state.question_index;
            gameState.playerScores = state.scores || {};
            
            // Update UI
            if (state.current_question) {
                displayQuestion(state.current_question);
            }
            
            updateScoresDisplay();
        }

        async function startOnlineGame() {
            if (!gameState.isHost) return;
            
            // Fetch questions
            const questions = await fetchQuestions(
                gameState.selectedCategory,
                'medium',
                gameState.totalQuestions
            );
            
            // Update game state in database
            await gameState.realTimeService.updateGameState({
                currentQuestion: questions[0],
                questionIndex: 0,
                scores: {},
                timeRemaining: 30
            });
            
            // Broadcast game start
            await supabaseClient
                .from('game_rooms')
                .update({ game_state: 'playing' })
                .eq('room_code', gameState.roomCode);
            
            // Start local game
            startGame();
        }

        function generateSecureRoomCode() {
            // Mix letters and numbers, excluding confusing characters
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function cleanupOnlineGame() {
            if (gameState.realTimeService) {
                gameState.realTimeService.disconnect();
            }
            
            // Remove player from room
            if (gameState.roomCode && supabaseClient) {
                supabaseClient
                    .from('room_players')
                    .delete()
                    .eq('room_code', gameState.roomCode)
                    .eq('player_name', gameState.playerName);
            }
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Bottom navigation
            elements.navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const screen = this.dataset.screen;
                    updateNavigation(screen);
                });
            });
            
            // Quick navigation buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('[data-screen]') && !e.target.closest('.nav-item')) {
                    const element = e.target.closest('[data-screen]');
                    const screen = element.dataset.screen;
                    updateNavigation(screen);
                }
            });
            
            // Mode selection buttons
            document.addEventListener('click', function(e) {
                // Play mode button
                if (e.target.closest('.play-mode-btn')) {
                    const btn = e.target.closest('.play-mode-btn');
                    gameState.currentGameMode = btn.dataset.mode;
                    
                    // Clear players for fresh game
                    gameState.players = [gameState.playerName];
                    gameState.playerScores = {};
                    updatePlayersList();
                    
                    updateNavigation('play');
                    navigateToStep(1);
                }
                
                // View mode details button
                if (e.target.closest('.view-mode-btn')) {
                    const btn = e.target.closest('.view-mode-btn');
                    const modeId = btn.dataset.mode;
                    const mode = gameState.gameModes.find(m => m.id === modeId);
                    
                    if (mode) {
                        elements.modeDetailsTitle.textContent = mode.name;
                        elements.modeDetailsSubtitle.textContent = mode.description;
                        
                        // Populate rules
                        elements.modeRules.innerHTML = mode.rules.map(rule => `
                            <div class="flex items-start gap-sm mb-sm">
                                <i class="fas fa-check text-green mt-1"></i>
                                <span>${rule}</span>
                            </div>
                        `).join('');
                        
                        // Populate instructions
                        elements.modeInstructions.innerHTML = mode.instructions.map(instruction => `
                            <div class="flex items-start gap-sm mb-sm">
                                <i class="fas fa-play text-yellow mt-1"></i>
                                <span>${instruction}</span>
                            </div>
                        `).join('');
                        
                        // Update play button
                        elements.playThisModeBtn.onclick = () => {
                            gameState.currentGameMode = modeId;
                            closeModal('modeDetailsModal');
                            updateNavigation('play');
                            navigateToStep(1);
                        };
                        
                        openModal('modeDetailsModal');
                    }
                }
                
                // Play category button
                if (e.target.closest('.play-category-btn')) {
                    const btn = e.target.closest('.play-category-btn');
                    const categoryId = btn.dataset.category;
                    
                    // Set default mode to Classic
                    gameState.currentGameMode = 'classic';
                    
                    // Set the category in the setup
                    const category = gameState.categories.find(c => c.id === categoryId);
                    if (category) {
                        // Clear players for fresh game
                        gameState.players = [gameState.playerName];
                        gameState.playerScores = {};
                        updatePlayersList();
                        
                        updateNavigation('play');
                        navigateToStep(1);
                        
                        // Set the category in the dropdown
                        setTimeout(() => {
                            elements.categorySelect.value = categoryId;
                        }, 100);
                    }
                }
            });
            
            // Player management
            elements.addPlayerBtn.addEventListener('click', () => {
                addPlayer(elements.playerNameInput.value);
            });
            
            elements.playerNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addPlayer(elements.playerNameInput.value);
                }
            });
            
            // Remove player buttons (delegated)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.remove-player-btn')) {
                    const btn = e.target.closest('.remove-player-btn');
                    const playerName = btn.dataset.player;
                    removePlayer(playerName);
                }
            });
            
            // Setup step navigation
            elements.nextStepBtn.addEventListener('click', () => {
                if (gameState.players.length >= 1) {
                    navigateToStep(2);
                } else {
                    alert('Add at least 1 player to continue');
                }
            });
            
            elements.prevStepBtn.addEventListener('click', () => {
                navigateToStep(1);
            });
            
            elements.nextStepBtn2.addEventListener('click', () => {
                navigateToStep(3);
            });
            
            elements.prevStepBtn2.addEventListener('click', () => {
                navigateToStep(2);
            });
            
            elements.startGameBtn.addEventListener('click', startGame);
            
            // Question count controls
            elements.questionDecrease.addEventListener('click', () => {
                const current = parseInt(elements.questionCount.value);
                if (current > 5) {
                    elements.questionCount.value = current - 1;
                }
            });
            
            elements.questionIncrease.addEventListener('click', () => {
                const current = parseInt(elements.questionCount.value);
                if (current < 50) {
                    elements.questionCount.value = current + 1;
                }
            });
            
            elements.questionCount.addEventListener('change', () => {
                let value = parseInt(elements.questionCount.value);
                if (value < 5) value = 5;
                if (value > 50) value = 50;
                elements.questionCount.value = value;
            });
            
            // Online question count controls
            elements.onlineQuestionDecrease.addEventListener('click', () => {
                const current = parseInt(elements.onlineQuestionCount.value);
                if (current > 5) {
                    elements.onlineQuestionCount.value = current - 1;
                }
            });
            
            elements.onlineQuestionIncrease.addEventListener('click', () => {
                const current = parseInt(elements.onlineQuestionCount.value);
                if (current < 50) {
                    elements.onlineQuestionCount.value = current + 1;
                }
            });
            
            elements.onlineQuestionCount.addEventListener('change', () => {
                let value = parseInt(elements.onlineQuestionCount.value);
                if (value < 5) value = 5;
                if (value > 50) value = 50;
                elements.onlineQuestionCount.value = value;
            });
            
            // Game controls
            elements.nextQuestionBtn.addEventListener('click', nextQuestion);
            
            elements.hintBtn.addEventListener('click', showHint);
            
            // Buzzer button
            elements.buzzerButton.addEventListener('click', buzzIn);
            
            // Game complete modal
            elements.backToMenuBtn.addEventListener('click', () => {
                closeModal('gameCompleteModal');
                updateNavigation('home');
                resetGameState();
            });
            
            elements.playAgainBtn.addEventListener('click', () => {
                closeModal('gameCompleteModal');
                
                if (gameState.isOnlineGame) {
                    // For online games, go back to waiting room
                    updateNavigation('waiting');
                } else {
                    // For local games, restart setup
                    updateNavigation('play');
                    navigateToStep(1);
                }
                resetGameState();
            });
            
            // Online play buttons
            elements.createRoomBtn.addEventListener('click', () => {
                openModal('createRoomModal');
            });
            
            elements.joinRoomBtn.addEventListener('click', () => {
                openModal('joinRoomModal');
            });
            
            // Create room confirmation
            elements.createRoomConfirmBtn.addEventListener('click', () => {
                if (supabaseClient && gameState.realTimeService) {
                    createRealRoom();
                } else {
                    showNotification('Supabase not configured. Using simulated multiplayer.', 'error');
                    // Fallback to simulated room creation
                    const roomCode = generateSecureRoomCode();
                    gameState.roomCode = roomCode;
                    gameState.isHost = true;
                    gameState.isOnlineGame = true;
                    elements.roomCodeDisplay.textContent = roomCode;
                    updateNavigation('waiting');
                    closeModal('createRoomModal');
                    showNotification('Room created! Share the code.');
                }
            });
            
            // Join room confirmation
            elements.joinRoomConfirmBtn.addEventListener('click', () => {
                if (supabaseClient && gameState.realTimeService) {
                    joinRealRoom();
                } else {
                    showNotification('Supabase not configured. Using simulated multiplayer.', 'error');
                    // Fallback to simulated room joining
                    const roomCode = elements.joinRoomCode.value.trim().toUpperCase();
                    if (roomCode.length === 6) {
                        gameState.roomCode = roomCode;
                        gameState.isHost = false;
                        gameState.isOnlineGame = true;
                        gameState.onlinePlayers = [
                            { name: 'Host Player', isHost: true },
                            { name: gameState.playerName, isHost: false }
                        ];
                        elements.roomCodeDisplay.textContent = roomCode;
                        updateOnlinePlayersList();
                        updateNavigation('waiting');
                        closeModal('joinRoomModal');
                        showNotification('Joined room successfully!');
                    } else {
                        showNotification('Please enter a valid 6-digit code', 'error');
                    }
                }
            });
            
            // Waiting room buttons
            elements.leaveRoomBtn.addEventListener('click', () => {
                if (confirm('Leave this room?')) {
                    cleanupOnlineGame();
                    gameState.isOnlineGame = false;
                    gameState.roomCode = null;
                    gameState.onlinePlayers = [];
                    updateNavigation('online');
                    resetGameState();
                }
            });
            
            elements.startOnlineGameBtn.addEventListener('click', () => {
                if (gameState.isHost) {
                    startOnlineGame();
                }
            });
            
            // Room code input formatting
            elements.joinRoomCode.addEventListener('input', function(e) {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            });
            
            // Save username
            elements.saveUsernameBtn.addEventListener('click', () => {
                const newName = elements.newUsername.value.trim();
                if (newName && newName.length > 0) {
                    gameState.playerName = newName.substring(0, 20);
                    updateHUD();
                    updateProfileDisplay();
                    saveGameState();
                    closeModal('nameModal');
                    showNotification('Username updated successfully!');
                }
            });
            
            // Save avatar
            elements.saveAvatarBtn.addEventListener('click', () => {
                updateProfileDisplay();
                updateHUD();
                saveGameState();
                closeModal('avatarModal');
                showNotification('Profile picture updated successfully!');
            });
            
            // Save theme
            elements.saveThemeBtn.addEventListener('click', () => {
                saveGameState();
                closeModal('themeModal');
                showNotification('Theme color saved!');
            });
            
            // Settings toggles
            elements.darkModeToggle.addEventListener('change', function() {
                gameState.settings.darkMode = this.checked;
                applyDarkMode(this.checked);
                saveGameState();
            });
            
            elements.soundEffectsToggle.addEventListener('change', function() {
                gameState.settings.soundEffects = this.checked;
                saveGameState();
            });
            
            elements.musicToggle.addEventListener('change', function() {
                gameState.settings.music = this.checked;
                saveGameState();
            });
            
            elements.notificationSoundToggle.addEventListener('change', function() {
                gameState.settings.notifications = this.checked;
                saveGameState();
            });
            
            elements.achievementNotificationToggle.addEventListener('change', function() {
                gameState.settings.achievementNotifications = this.checked;
                saveGameState();
            });
            
            // Close modals on backdrop click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
            
            // Escape key to close modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                        closeModal(modal.id);
                    });
                }
            });
            
            // Pause game on window blur
            window.addEventListener('blur', () => {
                if (gameState.isGameActive && gameState.currentGameMode !== 'buzzer') {
                    openModal('pauseModal');
                }
            });
            
            // Quit game button
            elements.quitGameBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to quit? Your progress will be lost.')) {
                    closeModal('pauseModal');
                    updateNavigation('home');
                    resetGameState();
                }
            });
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', cleanupOnlineGame);
        }

        // Make functions globally accessible
        window.removePlayer = removePlayer;
        window.addPlayer = addPlayer;
        window.updateNavigation = updateNavigation;
        window.closeModal = closeModal;
        window.openModal = openModal;
        window.selectAvatar = selectAvatar;
        window.selectThemeColor = selectThemeColor;
    </script>
</body>
</html>
