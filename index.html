<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Too Turned Trivia‚Ñ¢</title>
<meta name="description" content="Online multiplayer trivia with 6 unique game modes">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}

:root{
  --black:#000000;--white:#FFFFFF;--yellow:#FFDE21;--yellow-dark:#E6C500;
  --gray-900:#0F0F0F;--gray-800:#1A1A1A;--gray-700:#2D2D2D;--gray-600:#404040;
  --gray-500:#666666;--gray-400:#9E9E9E;
  --purple:#6C5CE7;--red:#FF7675;--orange:#FDCB6E;--green:#00B894;
  --cyan:#00CEC9;--pink:#FD79A8;
  --space-sm:8px;--space-md:16px;--space-lg:24px;--space-xl:32px;
  --radius-lg:18px;--radius-md:12px;
  --shadow-card:0 8px 20px rgba(0,0,0,0.12);
  --shadow-card-hover:0 12px 30px rgba(0,0,0,0.25);
}

:root.light-mode{
  --black:#FFFFFF;--white:#000000;
  --gray-900:#F0F0F0;--gray-800:#E0E0E0;--gray-700:#D0D0D0;
  --gray-600:#C0C0C0;--gray-500:#909090;--gray-400:#606060;
  --shadow-card:0 8px 20px rgba(0,0,0,0.08);
  --shadow-card-hover:0 12px 30px rgba(0,0,0,0.15);
}

body{font-family:'Inter',sans-serif;background:var(--black);color:var(--white);min-height:100vh;overflow-x:hidden;transition:background-color .3s,color .3s}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#loadingScreen{position:fixed;inset:0;background:var(--black);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .5s}
.loading-logo{font-size:80px;font-weight:900;color:var(--yellow);animation:pulse 2s infinite;margin-bottom:var(--space-xl)}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.05)}}
.loading-progress{width:min(300px,90vw);height:6px;background:var(--gray-800);border-radius:9999px;overflow:hidden}
.loading-progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--yellow),var(--orange));transition:width .3s ease}
.loading-text{margin-top:var(--space-md);color:var(--gray-400);font-size:14px;font-weight:500}

/* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
.player-hud{position:fixed;top:0;left:0;right:0;background:rgba(15,15,15,.95);backdrop-filter:blur(10px);padding:var(--space-sm) var(--space-md);display:flex;justify-content:space-between;align-items:center;z-index:100;border-bottom:1px solid rgba(255,222,33,.1);height:60px;transition:background-color .3s}
.light-mode .player-hud{background:rgba(240,240,240,.95);border-bottom:1px solid rgba(255,222,33,.2)}
.hud-left{display:flex;align-items:center;gap:var(--space-lg)}
.hud-item{display:flex;align-items:center;gap:6px}
.hud-icon{width:32px;height:32px;background:var(--gray-800);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--yellow)}
.hud-value{font-weight:700;font-size:16px}
.hud-label{font-size:12px;color:var(--gray-400);margin-top:-2px}
.hud-right{display:flex;align-items:center;gap:var(--space-sm)}
.profile-display{display:flex;align-items:center;gap:var(--space-sm)}
.profile-pic-hud{width:36px;height:36px;border-radius:50%;background:var(--gray-700);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;overflow:hidden;border:2px solid var(--gray-600);cursor:pointer;flex-shrink:0}
.profile-pic-hud img{width:100%;height:100%;object-fit:cover}
.hud-silhouette{font-size:18px;color:var(--gray-500)}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(15,15,15,.95);backdrop-filter:blur(20px);display:flex;justify-content:space-around;padding:12px 0;z-index:100;border-top:1px solid rgba(255,222,33,.1);height:70px;transition:background-color .3s}
.light-mode .bottom-nav{background:rgba(240,240,240,.95);border-top:1px solid rgba(255,222,33,.2)}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;background:none;border:none;color:var(--gray-400);font-family:inherit;font-size:12px;cursor:pointer;transition:all .2s;padding:8px 16px;border-radius:var(--radius-md);flex:1;max-width:100px}
.nav-item.active{color:var(--yellow);background:rgba(255,222,33,.1)}
.nav-icon{font-size:20px}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{display:none;min-height:100vh;padding:60px 0 70px;overflow-y:auto}
.screen.active{display:block}
.page-content{padding:var(--space-xl) var(--space-md);max-width:1200px;margin:0 auto;min-height:calc(100vh - 130px)}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;justify-content:center;min-height:48px;padding:var(--space-sm) var(--space-lg);border:none;border-radius:var(--radius-md);font-family:inherit;font-weight:600;cursor:pointer;transition:all .2s;text-decoration:none;gap:var(--space-sm)}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.btn-primary{background:var(--yellow);color:#000}
.btn-primary:not(:disabled):hover{background:var(--yellow-dark);transform:translateY(-2px);box-shadow:0 8px 20px rgba(255,222,33,.3)}
.btn-outline{background:transparent;color:var(--yellow);border:2px solid var(--yellow)}
.btn-outline:not(:disabled):hover{background:rgba(255,222,33,.1)}
.btn-ghost{background:rgba(255,255,255,.06);color:var(--white);border:none}
.btn-ghost:not(:disabled):hover{background:rgba(255,255,255,.1)}
.btn-danger{background:rgba(255,118,117,.15);color:var(--red);border:1.5px solid rgba(255,118,117,.3)}
.btn-full{width:100%}
.btn-lg{min-height:56px;font-size:18px;font-weight:700}
.btn-sm{padding:6px 12px;min-height:36px;font-size:14px}
.flex-1{flex:1}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--gray-800);border-radius:var(--radius-lg);padding:var(--space-lg);box-shadow:var(--shadow-card);transition:all .3s;border:1px solid rgba(255,255,255,.05)}
.light-mode .card{border:1px solid rgba(0,0,0,.05)}
.card:hover{transform:translateY(-4px);box-shadow:var(--shadow-card-hover)}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--space-lg)}
.card-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;margin-bottom:var(--space-md)}
.card-title{font-size:18px;font-weight:700;margin-bottom:var(--space-sm)}
.card-description{color:var(--gray-400);font-size:14px;line-height:1.5;margin-bottom:var(--space-md)}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
.hero-section{text-align:center;padding:var(--space-xl) 0;margin-bottom:var(--space-xl);position:relative}
.hero-section::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:200px;height:200px;background:radial-gradient(circle,rgba(255,222,33,.1) 0%,transparent 70%);z-index:-1}
.hero-title{font-size:clamp(36px,6vw,48px);font-weight:900;margin-bottom:var(--space-md);background:linear-gradient(135deg,var(--yellow) 0%,var(--orange) 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
.hero-subtitle{color:var(--gray-400);max-width:600px;margin:0 auto var(--space-xl);font-size:clamp(16px,2.5vw,20px)}
.hero-actions{display:flex;gap:var(--space-md);justify-content:center;flex-wrap:wrap}

/* ‚îÄ‚îÄ SECTION HEADERS ‚îÄ‚îÄ */
.modes-header{text-align:center;margin-bottom:var(--space-xl)}
.section-title{font-size:32px;font-weight:800;margin-bottom:var(--space-sm);background:linear-gradient(135deg,var(--yellow) 0%,var(--orange) 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
.section-subtitle{color:var(--gray-400);max-width:600px;margin:0 auto}

/* ‚îÄ‚îÄ SETUP STEPPER ‚îÄ‚îÄ */
.setup-stepper{display:flex;justify-content:center;gap:var(--space-md);margin-bottom:var(--space-xl)}
.step{display:flex;flex-direction:column;align-items:center;gap:var(--space-sm)}
.step-circle{width:36px;height:36px;border-radius:50%;background:var(--gray-800);color:var(--gray-400);display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid transparent;transition:all .3s}
.step.active .step-circle{background:var(--yellow);color:#000;border-color:var(--yellow);box-shadow:0 0 0 4px rgba(255,222,33,.2)}
.step.completed .step-circle{background:var(--green);color:#fff;border-color:var(--green)}
.step-label{font-size:12px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px}
.step.active .step-label{color:var(--yellow)}
.step.completed .step-label{color:var(--green)}
.setup-content{background:var(--gray-800);border-radius:var(--radius-lg);padding:var(--space-xl);margin-bottom:var(--space-xl)}
.setup-section{display:none}
.setup-section.active{display:block}

/* ‚îÄ‚îÄ PLAYERS LIST ‚îÄ‚îÄ */
.players-list{margin-bottom:var(--space-lg);max-height:300px;overflow-y:auto}
.player-item{display:flex;align-items:center;justify-content:space-between;padding:var(--space-md);background:var(--gray-700);border-radius:var(--radius-md);margin-bottom:var(--space-sm);transition:all .2s}
.player-item:hover{background:var(--gray-600)}
.player-name{font-weight:600}
.player-empty{text-align:center;color:var(--gray-400);padding:32px 16px;font-size:14px}

/* ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ */
.game-header{background:var(--gray-800);border-radius:var(--radius-lg);padding:var(--space-lg);margin-bottom:var(--space-lg);border:1px solid rgba(255,222,33,.1)}
.game-stats{display:flex;justify-content:space-around;gap:var(--space-lg);margin-bottom:var(--space-md)}
.stat-item{text-align:center}
.stat-value{font-size:24px;font-weight:800;color:var(--yellow);margin-bottom:2px}
.stat-label{font-size:12px;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px}
.game-info{display:flex;justify-content:space-between;align-items:center}
.game-mode-badge{background:var(--gray-700);padding:6px 12px;border-radius:12px;font-size:14px;font-weight:600}
.timer-display{display:flex;align-items:center;gap:var(--space-sm)}

.question-card{background:var(--gray-800);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:var(--space-lg);box-shadow:var(--shadow-card)}
.question-header{padding:var(--space-lg);background:linear-gradient(135deg,var(--gray-700) 0%,var(--gray-800) 100%);border-bottom:1px solid var(--gray-700)}
.question-progress{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-sm)}
.question-category{display:flex;align-items:center;gap:var(--space-sm);color:var(--gray-400);font-size:14px}
.question-text{padding:var(--space-lg);font-size:20px;font-weight:600;text-align:center;line-height:1.4}
.answers-grid{padding:var(--space-lg);display:grid;grid-template-columns:1fr;gap:var(--space-md)}
@media(min-width:640px){.answers-grid{grid-template-columns:repeat(2,1fr)}}

.answer-option{padding:var(--space-lg);background:var(--gray-700);border-radius:var(--radius-md);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:var(--space-md);-webkit-user-select:none;user-select:none;border:2px solid transparent}
.answer-option:hover:not(.answered){background:var(--gray-600);transform:translateY(-2px)}
.answer-option.answered{pointer-events:none;cursor:default}
.answer-option.correct{background:rgba(0,184,148,.2);border-color:var(--green)}
.answer-option.incorrect{background:rgba(255,118,117,.2);border-color:var(--red)}
.answer-option.reveal-correct{background:rgba(0,184,148,.15);border-color:var(--green);animation:pulseGreen .5s ease}
@keyframes pulseGreen{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
.answer-letter{width:36px;height:36px;background:var(--gray-600);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;flex-shrink:0;transition:background .2s}
.answer-option.correct .answer-letter{background:var(--green);color:#fff}
.answer-option.incorrect .answer-letter{background:var(--red);color:#fff}
.answer-option.reveal-correct .answer-letter{background:var(--green);color:#fff}
.game-controls{display:flex;gap:var(--space-md);justify-content:center}

/* ‚îÄ‚îÄ CATEGORIES ‚îÄ‚îÄ */
.categories-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:var(--space-lg)}
.category-progress{display:flex;justify-content:space-between;align-items:center;margin-top:var(--space-md)}

/* ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ */
.profile-header{display:flex;align-items:center;gap:var(--space-lg);margin-bottom:var(--space-xl)}
.profile-pic{width:100px;height:100px;border-radius:50%;background:var(--gray-700);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .3s;overflow:hidden;position:relative;border:3px solid var(--gray-600)}
.profile-pic:hover{transform:scale(1.05)}
.profile-pic img{width:100%;height:100%;object-fit:cover}
.profile-info{flex:1}
.profile-name{font-size:28px;font-weight:800;margin-bottom:var(--space-sm);cursor:pointer}
.profile-name:hover{color:var(--yellow)}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--space-lg);margin-bottom:var(--space-xl)}
.stat-card{text-align:center;padding:var(--space-lg)}
.stat-value-lg{font-size:36px;font-weight:800;color:var(--yellow);margin-bottom:var(--space-sm)}
.leaderboard{background:var(--gray-800);border-radius:var(--radius-lg);padding:var(--space-lg)}
.leaderboard-item{display:flex;align-items:center;justify-content:space-between;padding:var(--space-md);border-bottom:1px solid var(--gray-700)}
.leaderboard-item:last-child{border-bottom:none}
.leaderboard-rank{width:36px;height:36px;background:var(--gray-700);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0}

/* ‚îÄ‚îÄ ONLINE ‚îÄ‚îÄ */
.online-actions{display:flex;gap:var(--space-lg);justify-content:center;margin-bottom:var(--space-xl)}
.lobby-container{background:var(--gray-800);border-radius:var(--radius-lg);padding:var(--space-lg)}
.room-list{margin-top:var(--space-lg);max-height:400px;overflow-y:auto}
.room-item{display:flex;justify-content:space-between;align-items:center;padding:var(--space-md);background:var(--gray-700);border-radius:var(--radius-md);margin-bottom:var(--space-sm)}

/* ‚îÄ‚îÄ WAITING ROOM ‚îÄ‚îÄ */
.waiting-room{text-align:center}
.room-code{font-size:48px;font-weight:900;letter-spacing:8px;color:var(--yellow);margin:var(--space-xl) 0;padding:var(--space-md);background:var(--gray-800);border-radius:var(--radius-md);border:2px dashed var(--yellow);cursor:pointer;transition:background .2s;user-select:all}
.room-code:hover{background:rgba(255,222,33,.05)}
.room-code-hint{font-size:12px;color:var(--gray-400);margin-top:-12px;margin-bottom:var(--space-lg)}

/* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
.settings-section{margin-bottom:var(--space-xl)}
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:var(--space-md);background:var(--gray-800);border-radius:var(--radius-md);margin-bottom:var(--space-sm);cursor:pointer;transition:background .2s}
.settings-item:hover{background:var(--gray-700)}
.toggle-switch{position:relative;width:60px;height:30px;flex-shrink:0}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--gray-700);transition:.4s;border-radius:34px}
.toggle-slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background-color:#fff;transition:.4s;border-radius:50%}
input:checked+.toggle-slider{background-color:var(--yellow)}
input:checked+.toggle-slider:before{transform:translateX(30px)}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.form-input{width:100%;padding:var(--space-md);background:var(--gray-700);border:2px solid var(--gray-600);border-radius:var(--radius-md);color:var(--white);font-family:inherit;font-size:16px}
.form-input:focus{outline:none;border-color:var(--yellow)}
.form-group{margin-bottom:var(--space-lg)}
.form-label{display:block;margin-bottom:var(--space-sm);font-weight:600}
.form-hint{font-size:12px;color:var(--gray-400);margin-top:4px}
.select-dropdown{width:100%;padding:var(--space-md);background:var(--gray-700);border:2px solid var(--gray-600);border-radius:var(--radius-md);color:var(--white);font-family:inherit;font-size:16px;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23FFDE21' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center;background-size:16px}
.select-dropdown:focus{outline:none;border-color:var(--yellow)}
.number-input-group{display:flex;align-items:center;gap:var(--space-sm)}
.number-input-btn{width:40px;height:40px;background:var(--gray-700);border:2px solid var(--gray-600);border-radius:var(--radius-md);color:var(--white);font-size:20px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.number-input-btn:hover{background:var(--gray-600);border-color:var(--yellow)}
.number-input{flex:1;text-align:center;font-size:20px;font-weight:bold}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:200;padding:var(--space-md)}
.light-mode .modal-overlay{background:rgba(0,0,0,.6)}
.modal-overlay.active{display:flex;animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--gray-800);border-radius:var(--radius-lg);width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:slideUp .25s ease}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-header{padding:var(--space-xl);text-align:center;border-bottom:1px solid var(--gray-700);position:relative}
.modal-close{position:absolute;top:var(--space-lg);right:var(--space-lg);background:none;border:none;color:var(--gray-400);font-size:24px;cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s,color .2s}
.modal-close:hover{background:var(--gray-700);color:var(--white)}
.modal-title{font-size:24px;font-weight:800;margin-bottom:var(--space-sm)}
.modal-subtitle{color:var(--gray-400);font-size:14px}
.modal-body{padding:var(--space-xl)}
.modal-footer{padding:var(--space-xl);border-top:1px solid var(--gray-700);display:flex;gap:var(--space-md);justify-content:center}

/* ‚îÄ‚îÄ CURRENT PLAYER INDICATOR ‚îÄ‚îÄ */
.current-player-indicator{position:fixed;top:60px;left:0;right:0;background:linear-gradient(135deg,var(--gray-800),var(--gray-700));padding:10px var(--space-md);text-align:center;font-weight:600;font-size:14px;z-index:99;border-bottom:1px solid rgba(255,222,33,.15);animation:slideDown .3s ease}
@keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}

/* ‚îÄ‚îÄ BUZZER ‚îÄ‚îÄ */
.buzzer-container{display:flex;flex-direction:column;gap:var(--space-lg);margin-top:var(--space-xl)}
.buzzer-button{height:200px;font-size:48px;font-weight:900;border-radius:var(--radius-lg);border:none;cursor:pointer;transition:all .1s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:var(--space-sm);touch-action:manipulation}
.buzzer-button:active{transform:scale(.95)}
.buzzer-ready{background:var(--green);color:#fff}
.buzzer-buzzed{background:var(--yellow);color:#000}
.buzzer-disabled{background:var(--gray-700);color:var(--gray-400);cursor:not-allowed}
.buzzer-status{text-align:center;padding:var(--space-lg);background:var(--gray-800);border-radius:var(--radius-lg);margin-bottom:var(--space-lg)}
.player-buzzed{font-size:24px;font-weight:700;color:var(--yellow);margin-top:var(--space-sm);min-height:36px}

/* ‚îÄ‚îÄ FEEDBACK ‚îÄ‚îÄ */
.feedback-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1001;padding:16px 32px;border-radius:12px;font-weight:700;font-size:20px;animation:feedbackAnim 1.5s ease forwards;pointer-events:none;white-space:nowrap}
.feedback-correct{background:var(--green);color:#fff}
.feedback-incorrect{background:var(--red);color:#fff}
@keyframes feedbackAnim{0%{opacity:0;transform:translate(-50%,-50%) scale(.8)}15%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}30%{transform:translate(-50%,-50%) scale(1)}75%{opacity:1}100%{opacity:0;transform:translate(-50%,-60%)}}

/* ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ */
.notification{position:fixed;top:80px;right:20px;background:var(--gray-800);border-left:4px solid var(--yellow);padding:var(--space-md);border-radius:var(--radius-md);box-shadow:var(--shadow-card);z-index:1000;animation:slideInRight .3s ease;max-width:350px}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideOutRight{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}

/* ‚îÄ‚îÄ PROFILE UPLOAD ‚îÄ‚îÄ */
.profile-upload{position:absolute;bottom:0;right:0;background:var(--yellow);color:#000;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px}

/* ‚îÄ‚îÄ THEME GRID ‚îÄ‚îÄ */
.theme-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:var(--space-sm)}
@media(max-width:480px){.theme-grid{grid-template-columns:repeat(2,1fr)}}
.theme-option{padding:var(--space-md);border-radius:var(--radius-md);cursor:pointer;text-align:center;transition:all .2s;border:2px solid transparent}
.theme-option:hover{transform:translateY(-2px)}
.theme-option.selected{border-color:var(--yellow);box-shadow:0 0 0 2px rgba(255,222,33,.3)}
.theme-color{width:40px;height:40px;border-radius:50%;margin:0 auto var(--space-sm);border:2px solid var(--gray-600)}
.theme-name{font-size:12px;font-weight:600}

/* ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ */
.text-center{text-align:center}.text-yellow{color:var(--yellow)}.text-green{color:var(--green)}.text-red{color:var(--red)}.text-gray-400{color:var(--gray-400)}
.mt-sm{margin-top:var(--space-sm)}.mt-md{margin-top:var(--space-md)}.mt-lg{margin-top:var(--space-lg)}.mt-xl{margin-top:var(--space-xl)}
.mb-sm{margin-bottom:var(--space-sm)}.mb-md{margin-bottom:var(--space-md)}.mb-lg{margin-bottom:var(--space-lg)}.mb-xl{margin-bottom:var(--space-xl)}
.hidden{display:none!important}.flex{display:flex}.flex-col{flex-direction:column}.items-center{align-items:center}
.justify-center{justify-content:center}.justify-between{justify-content:space-between}
.gap-sm{gap:var(--space-sm)}.gap-md{gap:var(--space-md)}.gap-lg{gap:var(--space-lg)}
.w-full{width:100%}.opacity-50{opacity:.5}.font-bold{font-weight:700}.font-semibold{font-weight:600}
.text-sm{font-size:14px}.text-xs{font-size:12px}.text-lg{font-size:18px}.text-xl{font-size:20px}
.mr-md{margin-right:var(--space-md)}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
.badge-green{background:rgba(0,184,148,.2);color:var(--green)}
.badge-yellow{background:rgba(255,222,33,.2);color:var(--yellow)}
.divider{height:1px;background:var(--gray-700);margin:var(--space-md) 0}

@media(max-width:639px){
  .hero-actions,.game-controls,.modal-footer,.online-actions{flex-direction:column}
  .hero-actions .btn,.game-controls .btn,.modal-footer .btn,.online-actions .btn{width:100%}
  .card-grid,.categories-grid,.stats-grid{grid-template-columns:1fr}
  .profile-header{flex-direction:column;text-align:center}
  .room-code{font-size:32px;letter-spacing:4px}
  .buzzer-button{height:150px;font-size:36px}
}
@media(min-width:640px) and (max-width:1024px){.card-grid{grid-template-columns:repeat(2,1fr)}}
::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:var(--gray-800)}::-webkit-scrollbar-thumb{background:var(--gray-600);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:var(--gray-500)}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingScreen">
  <div class="loading-logo">T</div>
  <div class="loading-progress"><div class="loading-progress-bar" id="loadingProgress"></div></div>
  <div class="loading-text" id="loadingText">Initializing...</div>
</div>

<!-- HUD -->
<div class="player-hud">
  <div class="hud-left">
    <div class="profile-display">
      <div class="profile-pic-hud" id="profilePicHud" onclick="updateNavigation('profile')">
        <i class="fas fa-user hud-silhouette"></i>
      </div>
      <div class="hud-item">
        <div>
          <div class="hud-value" id="playerName">Player</div>
          <div class="hud-label">Profile</div>
        </div>
      </div>
    </div>
  </div>
  <div class="hud-right">
    <div class="hud-item">
      <div class="hud-icon"><i class="fas fa-trophy"></i></div>
      <div>
        <div class="hud-value" id="playerScoreHud">0</div>
        <div class="hud-label">Total Score</div>
      </div>
    </div>
  </div>
</div>

<div class="current-player-indicator hidden" id="currentPlayerIndicator"></div>

<main>
  <!-- HOME -->
  <div class="screen active" id="homeScreen">
    <div class="page-content">
      <section class="hero-section">
        <h1 class="hero-title">Too Turned Trivia‚Ñ¢</h1>
        <p class="hero-subtitle">Challenge your mind with 6 unique game modes. Play solo or with friends!</p>
        <div class="hero-actions">
          <button class="btn btn-primary btn-lg" onclick="updateNavigation('modes')"><i class="fas fa-play-circle"></i> Play Now</button>
          <button class="btn btn-outline btn-lg" onclick="updateNavigation('online')"><i class="fas fa-wifi"></i> Online Play</button>
        </div>
      </section>
      <div class="card-grid">
        <div class="card" onclick="updateNavigation('modes')" style="cursor:pointer">
          <div class="card-icon" style="background:rgba(108,92,231,.2);color:var(--purple)"><i class="fas fa-crown"></i></div>
          <h3 class="card-title">6 Game Modes</h3>
          <p class="card-description">Classic, Countdown, Ladder, Battle, Buzzer, and Solo challenges</p>
        </div>
        <div class="card" onclick="updateNavigation('categories')" style="cursor:pointer">
          <div class="card-icon" style="background:rgba(255,118,117,.2);color:var(--red)"><i class="fas fa-layer-group"></i></div>
          <h3 class="card-title">Categories</h3>
          <p class="card-description">Science, History, Entertainment, Sports, Geography, and more</p>
        </div>
        <div class="card" onclick="updateNavigation('stats')" style="cursor:pointer">
          <div class="card-icon" style="background:rgba(253,203,110,.2);color:var(--orange)"><i class="fas fa-chart-line"></i></div>
          <h3 class="card-title">Stats & Rankings</h3>
          <p class="card-description">Track your progress and compete on global leaderboards</p>
        </div>
        <div class="card" onclick="updateNavigation('profile')" style="cursor:pointer">
          <div class="card-icon" style="background:rgba(0,184,148,.2);color:var(--green)"><i class="fas fa-user-circle"></i></div>
          <h3 class="card-title">My Profile</h3>
          <p class="card-description">Customize your profile and manage settings</p>
        </div>
      </div>
    </div>
  </div>

  <!-- MODES -->
  <div class="screen" id="modesScreen">
    <div class="page-content">
      <div class="modes-header">
        <h2 class="section-title">Choose Your Mode</h2>
        <p class="section-subtitle">Each mode has unique rules. Select one to begin!</p>
      </div>
      <div class="card-grid" id="modesGrid"></div>
    </div>
  </div>

  <!-- CATEGORIES -->
  <div class="screen" id="categoriesScreen">
    <div class="page-content">
      <div class="modes-header">
        <h2 class="section-title">Categories</h2>
        <p class="section-subtitle">Explore different trivia categories</p>
      </div>
      <div class="categories-grid" id="categoriesGrid"></div>
    </div>
  </div>

  <!-- STATS -->
  <div class="screen" id="statsScreen">
    <div class="page-content">
      <div class="modes-header">
        <h2 class="section-title">Stats & Rankings</h2>
        <p class="section-subtitle">Track your progress and achievements</p>
      </div>
      <div class="stats-grid mb-xl">
        <div class="stat-card card"><div class="stat-value-lg" id="totalGamesStat">0</div><div class="stat-label">Games Played</div></div>
        <div class="stat-card card"><div class="stat-value-lg" id="accuracyStat">0%</div><div class="stat-label">Accuracy</div></div>
        <div class="stat-card card"><div class="stat-value-lg" id="winStreakStat">0</div><div class="stat-label">Win Streak</div></div>
        <div class="stat-card card"><div class="stat-value-lg" id="totalPointsStat">0</div><div class="stat-label">Total Points</div></div>
      </div>
      <div class="card mb-xl">
        <h3 class="card-title mb-lg">Achievements</h3>
        <div id="achievementsList"></div>
      </div>
      <div class="card">
        <h3 class="card-title mb-lg">Global Leaderboard</h3>
        <div class="leaderboard" id="leaderboard"></div>
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="screen" id="profileScreen">
    <div class="page-content">
      <div class="profile-header">
        <div class="profile-pic" id="profilePic" onclick="openModal('avatarModal')">
          <div class="profile-upload"><i class="fas fa-camera"></i></div>
        </div>
        <div class="profile-info">
          <h1 class="profile-name" id="profileName" onclick="openModal('nameModal')">Player</h1>
          <p class="text-gray-400">Trivia Enthusiast</p>
          <div class="mt-sm"><span class="badge badge-yellow"><i class="fas fa-star" style="margin-right:6px"></i><span id="profileTotalScore">0</span> pts</span></div>
        </div>
      </div>
      <div class="settings-section">
        <h3 class="card-title mb-lg">Account Settings</h3>
        <div class="card">
          <div class="settings-item" onclick="openModal('nameModal')">
            <span><i class="fas fa-user text-yellow mr-md"></i> Change Username</span>
            <i class="fas fa-chevron-right text-gray-400"></i>
          </div>
          <div class="settings-item" onclick="openModal('avatarModal')">
            <span><i class="fas fa-image text-yellow mr-md"></i> Change Profile Picture</span>
            <i class="fas fa-chevron-right text-gray-400"></i>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <h3 class="card-title mb-lg">Appearance</h3>
        <div class="card">
          <div class="settings-item">
            <span><i class="fas fa-moon text-yellow mr-md"></i> Dark Mode</span>
            <label class="toggle-switch" onclick="event.stopPropagation()">
              <input type="checkbox" id="darkModeToggle" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="settings-item" onclick="openModal('themeModal')">
            <span><i class="fas fa-palette text-yellow mr-md"></i> Theme Color</span>
            <div style="display:flex;align-items:center;gap:8px">
              <div id="currentThemePreview" style="width:20px;height:20px;border-radius:50%;background:var(--yellow)"></div>
              <i class="fas fa-chevron-right text-gray-400"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <h3 class="card-title mb-lg">Game Settings</h3>
        <div class="card">
          <div class="settings-item" onclick="openModal('soundModal')">
            <span><i class="fas fa-volume-up text-yellow mr-md"></i> Sound Effects</span>
            <i class="fas fa-chevron-right text-gray-400"></i>
          </div>
          <div class="settings-item" onclick="confirmResetStats()">
            <span><i class="fas fa-trash mr-md" style="color:var(--red)"></i> Reset All Stats</span>
            <i class="fas fa-chevron-right text-gray-400"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PLAY SETUP -->
  <div class="screen" id="playScreen">
    <div class="page-content">
      <div class="modes-header">
        <h2 class="section-title" id="setupModeTitle">Game Setup</h2>
        <p class="section-subtitle" id="setupModeDescription">Configure your game settings</p>
      </div>
      <div class="setup-stepper">
        <div class="step active" data-step="1"><div class="step-circle">1</div><div class="step-label">Players</div></div>
        <div class="step" data-step="2"><div class="step-circle">2</div><div class="step-label">Settings</div></div>
        <div class="step" data-step="3"><div class="step-circle">3</div><div class="step-label">Start</div></div>
      </div>
      <div class="setup-content">
        <!-- Step 1 -->
        <div class="setup-section active" data-step="1">
          <h3 class="text-center mb-sm">Add Players</h3>
          <p class="text-center text-gray-400 mb-lg" style="font-size:14px">Add at least 1 player to start</p>
          <div class="players-list" id="playersList"></div>
          <div class="flex gap-sm mt-md">
            <input type="text" id="playerNameInput" class="form-input w-full" placeholder="Enter player name" maxlength="20"/>
            <button id="addPlayerBtn" class="btn btn-primary">Add</button>
          </div>
          <button class="btn btn-primary btn-full mt-lg" id="nextStepBtn">Continue to Settings <i class="fas fa-arrow-right"></i></button>
        </div>
        <!-- Step 2 -->
        <div class="setup-section" data-step="2">
          <h3 class="text-center mb-lg">Game Settings</h3>
          <div class="form-group">
            <label class="form-label">Number of Questions</label>
            <div class="number-input-group">
              <button class="number-input-btn" id="questionDecrease">‚àí</button>
              <input type="number" class="form-input number-input" id="questionCount" value="10" min="5" max="50">
              <button class="number-input-btn" id="questionIncrease">+</button>
            </div>
            <div class="form-hint">Choose between 5 and 50 questions</div>
          </div>
          <div class="form-group">
            <label class="form-label">Category</label>
            <select class="select-dropdown" id="categorySelect"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Difficulty</label>
            <select class="select-dropdown" id="difficultySelect">
              <option value="easy">Easy</option>
              <option value="medium" selected>Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
          <div class="flex gap-sm mt-lg">
            <button class="btn btn-outline flex-1" id="prevStepBtn"><i class="fas fa-arrow-left"></i> Back</button>
            <button class="btn btn-primary flex-1" id="nextStepBtn2">Continue <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>
        <!-- Step 3 -->
        <div class="setup-section" data-step="3">
          <h3 class="text-center mb-lg">Ready to Play!</h3>
          <div class="card mb-lg">
            <div class="text-center mb-md">
              <div class="text-yellow text-xl font-bold" id="selectedModeName">Classic Mode</div>
              <div class="text-sm text-gray-400 mt-sm" id="selectedModeDescription">Traditional question/answer format</div>
            </div>
            <div class="divider"></div>
            <div class="mt-md text-center text-gray-400 flex flex-col gap-sm">
              <div><i class="fas fa-users text-yellow mr-md"></i> <strong id="settingsPlayerCount" style="color:var(--white)">1</strong> Player(s)</div>
              <div><i class="fas fa-question-circle text-yellow mr-md"></i> <strong id="settingsQuestionCount" style="color:var(--white)">10</strong> Questions</div>
              <div><i class="fas fa-tag text-yellow mr-md"></i> <strong id="settingsCategory" style="color:var(--white)">General Knowledge</strong></div>
              <div><i class="fas fa-chart-line text-yellow mr-md"></i> <strong id="settingsDifficulty" style="color:var(--white)">Medium</strong> Difficulty</div>
            </div>
            <div class="divider"></div>
            <div id="finalPlayersList"></div>
          </div>
          <div class="flex gap-sm">
            <button class="btn btn-outline flex-1" id="prevStepBtn2"><i class="fas fa-arrow-left"></i> Back</button>
            <button class="btn btn-primary flex-1" id="startGameBtn"><i class="fas fa-play"></i> Start Game!</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ONLINE -->
  <div class="screen" id="onlineScreen">
    <div class="page-content">
      <div class="modes-header">
        <h2 class="section-title">Online Play</h2>
        <p class="section-subtitle">Play with friends or random players worldwide</p>
      </div>
      <div class="online-actions">
        <button class="btn btn-primary btn-lg" id="createRoomBtn"><i class="fas fa-plus-circle"></i> Create Room</button>
        <button class="btn btn-outline btn-lg" id="joinRoomBtn"><i class="fas fa-sign-in-alt"></i> Join Room</button>
      </div>
      <div class="lobby-container card">
        <div class="flex justify-between items-center mb-lg">
          <h3 class="card-title" style="margin-bottom:0">Available Rooms</h3>
          <button class="btn btn-outline btn-sm" id="refreshRoomsBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
        <div class="room-list" id="roomList"><div class="player-empty">Loading rooms...</div></div>
      </div>
    </div>
  </div>

  <!-- WAITING ROOM -->
  <div class="screen" id="waitingScreen">
    <div class="page-content">
      <div class="waiting-room">
        <h2 class="section-title">Waiting Room</h2>
        <p class="section-subtitle">Share the code with other players</p>
        <div class="room-code" id="roomCodeDisplay" title="Click to copy">ABC123</div>
        <div class="room-code-hint"><i class="fas fa-copy"></i> Tap code to copy</div>
        <div class="card mb-lg">
          <h3 class="card-title mb-md">Connected Players <span id="playerCountBadge" class="badge badge-green" style="font-size:11px;margin-left:8px">0/4</span></h3>
          <div class="players-list" id="onlinePlayersList"></div>
        </div>
        <div class="card mb-lg" style="text-align:left">
          <h3 class="card-title mb-md">Room Settings</h3>
          <div class="flex flex-col gap-sm text-gray-400">
            <div><i class="fas fa-gamepad text-yellow mr-md"></i> Mode: <strong style="color:var(--white)" id="roomMode">Classic</strong></div>
            <div><i class="fas fa-question-circle text-yellow mr-md"></i> Questions: <strong style="color:var(--white)" id="roomQuestions">10</strong></div>
            <div><i class="fas fa-tag text-yellow mr-md"></i> Category: <strong style="color:var(--white)" id="roomCategory">General</strong></div>
          </div>
        </div>
        <div class="flex gap-sm">
          <button class="btn btn-outline flex-1" id="leaveRoomBtn"><i class="fas fa-sign-out-alt"></i> Leave</button>
          <button class="btn btn-primary flex-1" id="startOnlineGameBtn" disabled><i class="fas fa-play"></i> Start Game</button>
        </div>
        <p class="text-gray-400 text-sm mt-md" id="startGameHint">Waiting for players...</p>
      </div>
    </div>
  </div>

  <!-- GAME -->
  <div class="screen" id="gameScreen">
    <div class="page-content">
      <div class="game-header">
        <div class="game-stats">
          <div class="stat-item"><div class="stat-value" id="playerScore">0</div><div class="stat-label">Score</div></div>
          <div class="stat-item"><div class="stat-value" id="currentQuestionNum">1/10</div><div class="stat-label">Question</div></div>
          <div class="stat-item"><div class="stat-value" id="playerLives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div><div class="stat-label">Lives</div></div>
          <div class="stat-item"><div class="stat-value" id="timeBonus">0</div><div class="stat-label">Bonus</div></div>
        </div>
        <div class="game-info">
          <div class="game-mode-badge" id="currentGameMode"><i class="fas fa-gamepad"></i> <span id="modeName">Classic</span></div>
          <div class="timer-display"><i class="fas fa-clock text-yellow"></i><span class="font-bold" id="gameTimer">30s</span></div>
        </div>
      </div>

      <div class="question-card">
        <div class="question-header">
          <div class="question-progress">
            <span class="text-yellow font-semibold">Question <span id="currentQuestion">1</span> of <span id="totalQuestionsDisplay">10</span></span>
            <span class="text-sm text-gray-400" id="difficultyLabel">Medium</span>
          </div>
          <div class="question-category"><i class="fas fa-tag"></i><span id="questionCategory">General Knowledge</span></div>
        </div>
        <div class="question-text" id="questionText">Loading question...</div>
        <div class="answers-grid" id="answersContainer"></div>
      </div>

      <!-- Buzzer Mode -->
      <div id="buzzerContainer" class="hidden">
        <div class="buzzer-status">
          <h3>Buzzer Mode</h3>
          <p id="buzzerInstruction">Wait for the question to be read, then buzz in!</p>
          <div class="player-buzzed" id="playerBuzzed"></div>
        </div>
        <div class="buzzer-container">
          <button class="buzzer-button buzzer-ready" id="buzzerButton"><i class="fas fa-bolt"></i><span>BUZZ IN!</span></button>
        </div>
      </div>

      <div class="game-controls" id="gameControls">
        <button class="btn btn-outline" id="hintBtn"><i class="fas fa-lightbulb"></i> Hint (<span id="hintCount">2</span> left)</button>
        <button class="btn btn-outline" id="pauseBtn"><i class="fas fa-pause"></i> Pause</button>
        <button class="btn btn-primary" id="nextQuestionBtn" disabled>Next <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>
  </div>
</main>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="nav-item active" onclick="updateNavigation('home')"><i class="nav-icon fas fa-home"></i><span>Home</span></button>
  <button class="nav-item" onclick="updateNavigation('modes')"><i class="nav-icon fas fa-gamepad"></i><span>Modes</span></button>
  <button class="nav-item" onclick="updateNavigation('categories')"><i class="nav-icon fas fa-layer-group"></i><span>Categories</span></button>
  <button class="nav-item" onclick="updateNavigation('stats')"><i class="nav-icon fas fa-chart-line"></i><span>Stats</span></button>
  <button class="nav-item" onclick="updateNavigation('profile')"><i class="nav-icon fas fa-user"></i><span>Profile</span></button>
</div>

<!-- ===== MODALS ===== -->

<!-- Game Complete -->
<div class="modal-overlay" id="gameCompleteModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">üèÜ Game Complete!</h2>
      <p class="modal-subtitle">Great game! Here are your results</p>
    </div>
    <div class="modal-body">
      <div class="text-center">
        <div style="font-size:64px;font-weight:900;color:var(--yellow)" id="finalScore">0</div>
        <div class="text-lg mb-lg" style="color:var(--gray-400)">Final Score</div>
        <div class="card mb-lg">
          <div class="flex justify-around mb-md">
            <div class="text-center"><div class="text-xl font-bold text-green" id="correctAnswersModal">0</div><div class="text-sm text-gray-400">Correct</div></div>
            <div class="text-center"><div class="text-xl font-bold text-yellow" id="timePlayed">0s</div><div class="text-sm text-gray-400">Time</div></div>
            <div class="text-center"><div class="text-xl font-bold" id="bonusEarned">0</div><div class="text-sm text-gray-400">Bonus</div></div>
          </div>
          <div class="divider"></div>
          <div class="text-sm text-gray-400 text-center mt-md" id="performanceSummary"></div>
        </div>
        <div id="winnerSection" class="card" style="background:rgba(255,222,33,.08);border-color:rgba(255,222,33,.2)">
          <div class="text-yellow font-semibold mb-sm">üéâ Winner</div>
          <div style="font-size:24px;font-weight:800" id="winnerName">Player 1</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="backToMenuBtn">Main Menu</button>
      <button class="btn btn-primary" id="playAgainBtn">Play Again</button>
    </div>
  </div>
</div>

<!-- Create Room -->
<div class="modal-overlay" id="createRoomModal">
  <div class="modal">
    <div class="modal-header">
      <button class="modal-close" onclick="closeModal('createRoomModal')">√ó</button>
      <h2 class="modal-title">Create Room</h2>
      <p class="modal-subtitle">Set up your online game room</p>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Room Name</label><input type="text" class="form-input" id="roomName" placeholder="Enter room name" maxlength="30"></div>
      <div class="form-group"><label class="form-label">Game Mode</label><select class="select-dropdown" id="onlineModeSelect"></select></div>
      <div class="form-group"><label class="form-label">Number of Questions</label><div class="number-input-group"><button class="number-input-btn" id="onlineQuestionDecrease">‚àí</button><input type="number" class="form-input number-input" id="onlineQuestionCount" value="10" min="5" max="50"><button class="number-input-btn" id="onlineQuestionIncrease">+</button></div></div>
      <div class="form-group"><label class="form-label">Category</label><select class="select-dropdown" id="onlineCategorySelect"></select></div>
      <div class="form-group"><label class="form-label">Difficulty</label><select class="select-dropdown" id="onlineDifficultySelect"><option value="easy">Easy</option><option value="medium" selected>Medium</option><option value="hard">Hard</option></select></div>
      <div class="form-group"><label class="form-label">Max Players</label><select class="select-dropdown" id="maxPlayers"><option value="2">2 Players</option><option value="4" selected>4 Players</option><option value="6">6 Players</option><option value="8">8 Players</option></select></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('createRoomModal')">Cancel</button>
      <button class="btn btn-primary" id="createRoomConfirmBtn"><i class="fas fa-plus"></i> Create</button>
    </div>
  </div>
</div>

<!-- Join Room -->
<div class="modal-overlay" id="joinRoomModal">
  <div class="modal">
    <div class="modal-header">
      <button class="modal-close" onclick="closeModal('joinRoomModal')">√ó</button>
      <h2 class="modal-title">Join Room</h2>
      <p class="modal-subtitle">Enter a room code to join</p>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Room Code</label>
        <input type="text" class="form-input" id="joinRoomCode" placeholder="Enter 6-character code" maxlength="6" autocomplete="off" style="text-align:center;font-size:24px;font-weight:700;letter-spacing:4px;text-transform:uppercase">
        <div class="form-hint">Ask the room host for their 6-character code</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('joinRoomModal')">Cancel</button>
      <button class="btn btn-primary" id="joinRoomConfirmBtn"><i class="fas fa-sign-in-alt"></i> Join</button>
    </div>
  </div>
</div>

<!-- Mode Details -->
<div class="modal-overlay" id="modeDetailsModal">
  <div class="modal">
    <div class="modal-header">
      <button class="modal-close" onclick="closeModal('modeDetailsModal')">√ó</button>
      <h2 class="modal-title" id="modeDetailsTitle">Classic Mode</h2>
      <p class="modal-subtitle" id="modeDetailsSubtitle">Traditional trivia gameplay</p>
    </div>
    <div class="modal-body">
      <div class="card mb-lg"><h3 class="card-title mb-md">Rules</h3><div id="modeRules"></div></div>
      <div class="card"><h3 class="card-title mb-md">How to Play</h3><div id="modeInstructions"></div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modeDetailsModal')">Close</button>
      <button class="btn btn-primary" id="playThisModeBtn"><i class="fas fa-play"></i> Play This Mode</button>
    </div>
  </div>
</div>

<!-- Name Change -->
<div class="modal-overlay" id="nameModal">
  <div class="modal">
    <div class="modal-header">
      <button class="modal-close" onclick="closeModal('nameModal')">√ó</button>
      <h2 class="modal-title">Change Username</h2>
      <p class="modal-subtitle">Enter your new display name</p>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">New Username</label>
        <input type="text" class="form-input" id="newUsername" placeholder="Enter username (max 20 chars)" maxlength="20">
        <div class="form-hint">This will update everywhere including the HUD</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('nameModal')">Cancel</button>
      <button class="btn btn-primary" id="saveUsernameBtn">Save Changes</button>
    </div>
  </div>
</div>

<!-- Avatar -->
<div class="modal-overlay" id="avatarModal">
  <div class="modal">
    <div class="modal-header">
      <button class="modal-close" onclick="closeModal('avatarModal')">√ó</button>
      <h2 class="modal-title">Profile Picture</h2>
      <p class="modal-subtitle">Upload a photo to personalise your profile</p>
    </div>
    <div class="modal-body">
      <div id="avatarCurrentContainer" class="text-center mb-lg">
        <div id="avatarCurrentDisplay" style="width:100px;height:100px;border-radius:50%;background:var(--gray-700);border:3px solid var(--gray-600);display:flex;align-items:center;justify-content:center;margin:0 auto 12px">
          <i class="fas fa-user" style="font-size:40px;color:var(--gray-500)"></i>
        </div>
        <div class="text-sm text-gray-400">Current picture</div>
      </div>
      <div class="form-group">
        <label class="form-label">Upload a photo</label>
        <input type="file" class="form-input" id="avatarUpload" accept="image/*" style="padding:10px">
        <div class="form-hint">JPG, PNG or GIF. Max 5MB.</div>
      </div>
      <div id="avatarPreviewContainer" class="hidden text-center mb-lg">
        <img id="avatarPreview" alt="Preview" style="height:100px;width:100px;border-radius:50%;object-fit:cover;margin:0 auto;display:block;border:3px solid var(--yellow)">
        <div class="text-sm text-gray-400 mt-sm">New picture preview</div>
      </div>
      <div id="avatarRemoveContainer" class="hidden">
        <button class="btn btn-full" id="removeAvatarBtn" style="background:rgba(255,118,117,.15);color:var(--red);border:1.5px solid rgba(255,118,117,.3)">
          <i class="fas fa-trash"></i> Remove Photo
        </button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('avatarModal')">Cancel</button>
      <button class="btn btn-primary" id="saveAvatarBtn">Save</button>
    </div>
  </div>
</div>

<!-- Theme -->
<div class="modal-overlay" id="themeModal">
  <div class="modal">
    <div class="modal-header">
      <button class="modal-close" onclick="closeModal('themeModal')">√ó</button>
      <h2 class="modal-title">Theme Color</h2>
      <p class="modal-subtitle">Choose your accent color</p>
    </div>
    <div class="modal-body"><div class="theme-grid" id="themeColors"></div></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('themeModal')">Cancel</button>
      <button class="btn btn-primary" id="saveThemeBtn">Apply Theme</button>
    </div>
  </div>
</div>

<!-- Sound -->
<div class="modal-overlay" id="soundModal">
  <div class="modal">
    <div class="modal-header">
      <button class="modal-close" onclick="closeModal('soundModal')">√ó</button>
      <h2 class="modal-title">Sound Settings</h2>
    </div>
    <div class="modal-body">
      <div class="settings-item"><span>Sound Effects</span><label class="toggle-switch" onclick="event.stopPropagation()"><input type="checkbox" id="soundEffectsToggle" checked><span class="toggle-slider"></span></label></div>
      <div class="settings-item"><span>Background Music</span><label class="toggle-switch" onclick="event.stopPropagation()"><input type="checkbox" id="musicToggle"><span class="toggle-slider"></span></label></div>
    </div>
    <div class="modal-footer"><button class="btn btn-primary" onclick="closeModal('soundModal')">Done</button></div>
  </div>
</div>

<!-- Pause -->
<div class="modal-overlay" id="pauseModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">‚è∏Ô∏è Game Paused</h2>
      <p class="modal-subtitle">Your progress is saved</p>
    </div>
    <div class="modal-body text-center">
      <p style="font-size:16px;color:var(--gray-400)">Timer is stopped while paused.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="resumeGameBtn"><i class="fas fa-play"></i> Resume</button>
      <button class="btn btn-outline" id="quitGameBtn"><i class="fas fa-times"></i> Quit Game</button>
    </div>
  </div>
</div>

<script>
// ===== SUPABASE CONFIG =====
const SUPABASE_CONFIG = {
  URL:'https://emwnshsfhrdcojzaxkjd.supabase.co',
  ANON_KEY:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVtd25zaHNmaHJkY29qemF4a2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjU4ODQsImV4cCI6MjA4MTkwMTg4NH0.Q_43zqq0eTZiUVUdDrfYtYr-F8ZjTjQVKs3VIJPTap4'
};
let supabaseClient = null;
let realtimeChannel = null;

// ===== GAME DATA =====
const gs = {
  playerName:'Player', playerProfilePic:null,
  totalGames:0, lifetimeCorrect:0, lifetimeTotal:0, highestStreak:0, winStreak:0, totalScore:0,
  currentScreen:'home',
  players:[], playerScores:{}, currentPlayerIndex:0,
  gameModes:[
    { id:'classic', name:'Classic', icon:'crown', color:'#6C5CE7',
      description:'Traditional question/answer with progressive difficulty',
      rules:['Each player takes turns','30 seconds per question','3 lives per player','100 pts base per correct answer','Wrong answer loses a life','Difficulty increases every 3 questions'],
      instructions:['Players take turns in order','Correct answer earns points','Wrong answer loses a life','Highest score after all questions wins'],
      minPlayers:1, maxPlayers:8, timePerQuestion:30, lives:3 },
    { id:'countdown', name:'Countdown', icon:'hourglass-half', color:'#FF7675',
      description:'Speed bonus for quick answers! Race the clock.',
      rules:['15 seconds per question','3 lives per player','Base 100 pts + time bonus','Faster answers = more points','Wrong answer loses a life'],
      instructions:['Answer as quickly as possible','Bonus points for speed','Wrong answers cost a life','Highest score wins'],
      minPlayers:1, maxPlayers:6, timePerQuestion:15, lives:3 },
    { id:'ladder', name:'Ladder', icon:'arrow-up-short-wide', color:'#FDCB6E',
      description:'Climb levels with correct answers. Wrong = drop down!',
      rules:['25 seconds per question','Unlimited lives','Points = 100 √ó current level','Correct: climb one level','Wrong: drop back to level 1'],
      instructions:['Start at level 1','Correct = level up, Wrong = drop to level 1','Level determines your score multiplier','All questions must be answered'],
      minPlayers:1, maxPlayers:4, timePerQuestion:25, lives:99 },
    { id:'battle', name:'Battle', icon:'hand-fist', color:'#FD79A8',
      description:'Elimination mode! One wrong answer and you\'re out.',
      rules:['20 seconds per question','1 life per player','Wrong answer = eliminated','Last player standing wins'],
      instructions:['Players take turns','Correct = stay in game','Wrong = eliminated','Last survivor wins'],
      minPlayers:2, maxPlayers:8, timePerQuestion:20, lives:1 },
    { id:'buzzer', name:'Buzzer', icon:'bolt', color:'#00B894',
      description:'First to buzz in gets to answer! Fastest finger wins.',
      rules:['First to buzz gets to answer','Correct = points','Wrong = other players get a chance','Most points wins'],
      instructions:['Tap BUZZ IN as soon as you know the answer','Correct earns points','Think fast!'],
      minPlayers:2, maxPlayers:8, timePerQuestion:0, lives:99 },
    { id:'solo', name:'Solo Challenge', icon:'user', color:'#00CEC9',
      description:'Beat your own high score in this single player mode.',
      rules:['30 seconds per question','3 lives','Accuracy bonus for perfect rounds','Beat your high score!'],
      instructions:['Answer questions within time limit','Aim for accuracy and speed','Perfect rounds earn a bonus'],
      minPlayers:1, maxPlayers:1, timePerQuestion:30, lives:3 }
  ],
  categories:[
    {id:'general',       name:'General Knowledge', icon:'brain',        color:'#6C5CE7', description:'A mix of everything from science to pop culture'},
    {id:'science',       name:'Science',           icon:'flask',        color:'#FF7675', description:'Biology, chemistry, physics, and astronomy'},
    {id:'history',       name:'History',           icon:'landmark',     color:'#FDCB6E', description:'World history, famous events, historical figures'},
    {id:'entertainment', name:'Entertainment',     icon:'film',         color:'#FD79A8', description:'Movies, TV shows, music, celebrities'},
    {id:'sports',        name:'Sports',            icon:'person-running',color:'#00B894', description:'Teams, players, and sporting events'},
    {id:'geography',     name:'Geography',         icon:'globe',        color:'#00CEC9', description:'Countries, capitals, landmarks'},
    {id:'arts',          name:'Arts & Literature', icon:'paint-brush',  color:'#9B59B6', description:'Books, authors, paintings, artists'},
    {id:'technology',    name:'Technology',        icon:'microchip',    color:'#3498DB', description:'Computers, internet, tech innovations'}
  ],
  isGameActive:false, isOnlineGame:false, currentGameMode:null,
  currentQuestionIndex:0, numQuestions:10, score:0, lives:3,
  timeBonus:0, timer:30, timerInterval:null, timerPaused:false,
  gameStartTime:null, correctAnswers:0,
  selectedCategory:'general', selectedDifficulty:'medium',
  currentStreak:0, maxStreak:0,
  currentQuestion:null, hintCount:2,
  isBuzzerActive:false, hasBuzzed:false,
  answeredThisQuestion:false,
  roomCode:null, roomId:null, isHost:false, onlinePlayers:[], maxRoomPlayers:4,
  achievements:[
    {id:'first_game',       name:'First Timer',      description:'Complete your first game',           icon:'star',          unlocked:false},
    {id:'perfect_game',     name:'Perfectionist',    description:'Get all questions correct in a game',icon:'check-double',  unlocked:false},
    {id:'streak_10',        name:'Hot Streak',       description:'Answer 10 questions in a row',       icon:'fire',          unlocked:false},
    {id:'speed_demon',      name:'Speed Demon',      description:'Answer with 80%+ time remaining',    icon:'bolt',          unlocked:false},
    {id:'trivia_champion',  name:'Trivia Champion',  description:'Reach a win streak of 5',            icon:'trophy',        unlocked:false},
    {id:'centurion',        name:'Centurion',        description:'Play 100 total games',               icon:'medal',         unlocked:false},
    {id:'high_scorer',      name:'High Scorer',      description:'Score 1000+ points in a single game',icon:'coins',         unlocked:false}
  ],
  settings:{darkMode:true, soundEffects:true, music:false, themeColor:'#FFDE21', achievementNotifications:true},
  pendingProfilePic:null, pendingRemovePhoto:false, pendingThemeColor:null
};

const API_CONFIG = {
  BASE_URL:'https://the-trivia-api.com/v2',
  CATEGORIES:{
    general:'general_knowledge', science:'science', history:'history',
    entertainment:'film_and_tv', sports:'sport_and_leisure',
    geography:'geography', arts:'arts_and_literature', technology:'science'
  }
};

let questionCache = [];
let questionStartTime = null;

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  loadSavedData();
  initializeSettings();
  populateGameModes();
  populateCategoryDropdowns();
  populateCategoriesScreen();
  populateOnlineSelectors();
  updateHUD();
  updateProfileDisplay();
  setupEventListeners();
  simulateLoading();
  if(gs.players.length === 0) gs.players.push(gs.playerName);
  updatePlayersList();
  window.addEventListener('beforeunload', saveGameState);
});

// ===== PERSISTENCE =====
function loadSavedData() {
  try {
    const p = JSON.parse(localStorage.getItem('tttGameState') || '{}');
    if(p.playerName) gs.playerName = p.playerName;
    if(p.playerProfilePic) gs.playerProfilePic = p.playerProfilePic;
    if(p.totalGames) gs.totalGames = p.totalGames;
    if(p.lifetimeCorrect) gs.lifetimeCorrect = p.lifetimeCorrect;
    if(p.lifetimeTotal) gs.lifetimeTotal = p.lifetimeTotal;
    if(p.highestStreak) gs.highestStreak = p.highestStreak;
    if(p.winStreak) gs.winStreak = p.winStreak;
    if(p.totalScore) gs.totalScore = p.totalScore;
    if(p.achievements) gs.achievements = p.achievements;
    if(p.settings) gs.settings = {...gs.settings, ...p.settings};
  } catch(e){}
}

function saveGameState() {
  try {
    localStorage.setItem('tttGameState', JSON.stringify({
      playerName:gs.playerName, playerProfilePic:gs.playerProfilePic,
      totalGames:gs.totalGames, lifetimeCorrect:gs.lifetimeCorrect, lifetimeTotal:gs.lifetimeTotal,
      highestStreak:gs.highestStreak, winStreak:gs.winStreak, totalScore:gs.totalScore,
      achievements:gs.achievements, settings:gs.settings
    }));
  } catch(e){}
}

// ===== SETTINGS =====
function initializeSettings() {
  document.getElementById('darkModeToggle').checked = gs.settings.darkMode;
  document.getElementById('soundEffectsToggle').checked = gs.settings.soundEffects;
  document.getElementById('musicToggle').checked = gs.settings.music;
  applyDarkMode(gs.settings.darkMode);
  applyThemeColor(gs.settings.themeColor);
}

function applyDarkMode(isDark) {
  document.documentElement.classList.toggle('light-mode', !isDark);
  document.body.classList.toggle('light-mode', !isDark);
}

function applyThemeColor(color) {
  document.documentElement.style.setProperty('--yellow', color);
  document.documentElement.style.setProperty('--yellow-dark', darkenColor(color, 15));
  const preview = document.getElementById('currentThemePreview');
  if(preview) preview.style.background = color;
}

function darkenColor(hex, pct) {
  const num = parseInt(hex.replace('#',''), 16);
  const amt = Math.round(2.55*pct);
  const R = Math.max(0,(num>>16)-amt);
  const G = Math.max(0,(num>>8&0x00FF)-amt);
  const B = Math.max(0,(num&0x0000FF)-amt);
  return '#'+(0x1000000+R*0x10000+G*0x100+B).toString(16).slice(1);
}

function hexToRgb(hex) {
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return `${r},${g},${b}`;
}

// ===== LOADING =====
function simulateLoading() {
  const bar = document.getElementById('loadingProgress');
  const txt = document.getElementById('loadingText');
  const msgs = ['Loading assets...','Preparing questions...','Setting up multiplayer...','Almost ready!'];
  let p = 0;
  const iv = setInterval(() => {
    p += 25; bar.style.width = p+'%';
    txt.textContent = msgs[Math.min(Math.floor(p/25)-1, 3)];
    if(p >= 100) {
      clearInterval(iv);
      setTimeout(() => {
        const ls = document.getElementById('loadingScreen');
        ls.style.opacity = '0';
        setTimeout(() => ls.style.display = 'none', 500);
      }, 300);
    }
  }, 200);
}

// ===== NAVIGATION =====
function updateNavigation(screenId) {
  if(gs.currentScreen === 'game' && screenId !== 'game' && gs.isGameActive) stopTimer();
  gs.currentScreen = screenId;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const t = document.getElementById(screenId+'Screen');
  if(t) t.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(item => {
    const fn = item.getAttribute('onclick') || '';
    item.classList.toggle('active', fn.includes(`'${screenId}'`));
  });
  if(screenId === 'stats') { populateStats(); populateAchievements(); populateLeaderboard(); }
  else if(screenId === 'profile') updateProfileDisplay();
  else if(screenId === 'categories') populateCategoriesScreen();
  else if(screenId === 'online') refreshOnlineRooms();
  if(screenId !== 'game') {
    document.getElementById('currentPlayerIndicator').classList.add('hidden');
    if(gs.isGameActive && screenId !== 'game') gs.isGameActive = false;
  }
}

// ===== BUILD UI =====
function populateGameModes() {
  const grid = document.getElementById('modesGrid');
  if(!grid) return;
  grid.innerHTML = gs.gameModes.map(mode => `
    <div class="card" style="display:flex;flex-direction:column">
      <div class="card-icon" style="background:rgba(${hexToRgb(mode.color)},.2);color:${mode.color}">
        <i class="fas fa-${mode.icon}"></i>
      </div>
      <h3 class="card-title">${mode.name}</h3>
      <p class="card-description" style="flex:1">${mode.description}</p>
      <div class="flex justify-between items-center mt-md">
        <span class="text-sm text-gray-400"><i class="fas fa-users" style="margin-right:4px"></i>${mode.minPlayers}‚Äì${mode.maxPlayers} players</span>
        <div class="flex gap-sm">
          <button class="btn btn-outline btn-sm view-mode-btn" data-mode="${mode.id}" title="View rules"><i class="fas fa-info-circle"></i></button>
          <button class="btn btn-primary btn-sm play-mode-btn" data-mode="${mode.id}">Play</button>
        </div>
      </div>
    </div>`).join('');
}

function populateCategoryDropdowns() {
  const cs = document.getElementById('categorySelect');
  const oc = document.getElementById('onlineCategorySelect');
  const opts = gs.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  if(cs) cs.innerHTML = opts;
  if(oc) oc.innerHTML = opts;
}

function populateCategoriesScreen() {
  const grid = document.getElementById('categoriesGrid');
  if(!grid) return;
  grid.innerHTML = gs.categories.map(c => `
    <div class="card">
      <div class="card-icon" style="background:rgba(${hexToRgb(c.color)},.2);color:${c.color}"><i class="fas fa-${c.icon}"></i></div>
      <h3 class="card-title">${c.name}</h3>
      <p class="card-description">${c.description}</p>
      <div class="category-progress">
        <button class="btn btn-primary btn-sm play-category-btn" data-category="${c.id}"><i class="fas fa-play"></i> Play</button>
      </div>
    </div>`).join('');
}

function populateOnlineSelectors() {
  const ms = document.getElementById('onlineModeSelect');
  if(ms) ms.innerHTML = gs.gameModes.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
}

function populateStats() {
  const acc = gs.lifetimeTotal > 0 ? Math.round((gs.lifetimeCorrect/gs.lifetimeTotal)*100) : 0;
  document.getElementById('totalGamesStat').textContent = gs.totalGames;
  document.getElementById('accuracyStat').textContent = acc+'%';
  document.getElementById('winStreakStat').textContent = gs.winStreak;
  document.getElementById('totalPointsStat').textContent = gs.totalScore.toLocaleString();
}

function populateAchievements() {
  const el = document.getElementById('achievementsList');
  if(!el) return;
  el.innerHTML = gs.achievements.map(a => `
    <div class="player-item ${a.unlocked ? '' : 'opacity-50'}">
      <div class="flex items-center gap-md">
        <div style="width:36px;height:36px;background:${a.unlocked?'rgba(255,222,33,.2)':'var(--gray-700)'};border-radius:50%;display:flex;align-items:center;justify-content:center">
          <i class="fas fa-${a.icon||'trophy'}" style="color:${a.unlocked?'var(--yellow)':'var(--gray-400)'}"></i>
        </div>
        <div>
          <div class="player-name">${a.name} ${a.unlocked?'‚úì':''}</div>
          <div class="text-xs text-gray-400">${a.description}</div>
        </div>
      </div>
      ${a.unlocked ? '<span class="badge badge-yellow">Unlocked</span>' : ''}
    </div>`).join('');
}

function populateLeaderboard() {
  const el = document.getElementById('leaderboard');
  if(!el) return;
  const data = [
    {name:'Trivia Master', score:12500, games:42},
    {name:'Quiz Whiz', score:9800, games:35},
    {name:'Brainiac', score:8750, games:28},
    {name:'Knowledge King', score:7200, games:25},
    {name:gs.playerName, score:gs.totalScore, games:gs.totalGames}
  ].sort((a,b) => b.score-a.score);
  const medals = ['ü•á','ü•à','ü•â'];
  el.innerHTML = data.map((p,i) => {
    const isMe = p.name === gs.playerName && p.score === gs.totalScore;
    return `
      <div class="leaderboard-item" style="${isMe?'background:rgba(255,222,33,.05);border-radius:8px':''}">
        <div class="flex items-center gap-md">
          <div class="leaderboard-rank" style="${i<3?'background:rgba(255,222,33,.2);color:var(--yellow)':''}">${i<3?medals[i]:i+1}</div>
          <div>
            <div class="player-name ${isMe?'text-yellow':''}">${p.name} ${isMe?'(You)':''}</div>
            <div class="text-xs text-gray-400">${p.games} games</div>
          </div>
        </div>
        <div class="font-bold">${p.score.toLocaleString()}</div>
      </div>`;
  }).join('');
}

// ===== PLAYERS =====
function addPlayer(name) {
  if(!name.trim()) return;
  const n = name.trim().substring(0,20);
  if(gs.players.includes(n)) { showNotification(`"${n}" already added`, 'warning'); return; }
  gs.players.push(n);
  gs.playerScores[n] = 0;
  updatePlayersList();
  document.getElementById('playerNameInput').value = '';
  document.getElementById('playerNameInput').focus();
}

function removePlayer(name) {
  if(gs.players.length <= 1) { showNotification('Need at least 1 player', 'warning'); return; }
  gs.players = gs.players.filter(p => p !== name);
  delete gs.playerScores[name];
  updatePlayersList();
}

function updatePlayersList() {
  const el = document.getElementById('playersList');
  if(!el) return;
  if(gs.players.length === 0) { el.innerHTML='<div class="player-empty">No players yet.</div>'; return; }
  el.innerHTML = gs.players.map((p,i) => `
    <div class="player-item">
      <div class="flex items-center gap-md">
        <div style="width:32px;height:32px;background:var(--gray-700);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0">${i+1}</div>
        <span class="player-name">${esc(p)}</span>
        ${p===gs.playerName?'<span class="badge badge-yellow" style="font-size:10px">You</span>':''}
      </div>
      ${gs.players.length>1?`<button class="btn btn-sm btn-danger" onclick="removePlayer('${esc(p)}');event.stopPropagation()"><i class="fas fa-times"></i></button>`:''}
    </div>`).join('');
}

// ===== STEPPER =====
function navigateToStep(n) {
  document.querySelectorAll('.step').forEach((s,i) => {
    s.classList.remove('active','completed');
    if(i+1===n) s.classList.add('active');
    if(i+1<n) s.classList.add('completed');
    const c = s.querySelector('.step-circle');
    if(c) c.innerHTML = i+1<n ? '<i class="fas fa-check" style="font-size:14px"></i>' : (i+1);
  });
  document.querySelectorAll('.setup-section').forEach((s,i) => s.classList.toggle('active', i+1===n));
  if(n===3) updateStep3Summary();
}

function updateStep3Summary() {
  const mode = gs.gameModes.find(m => m.id===gs.currentGameMode);
  document.getElementById('selectedModeName').textContent = mode ? mode.name : 'Classic';
  document.getElementById('selectedModeDescription').textContent = mode ? mode.description : '';
  document.getElementById('settingsPlayerCount').textContent = gs.players.length;
  document.getElementById('settingsQuestionCount').textContent = document.getElementById('questionCount').value;
  const catSel = document.getElementById('categorySelect');
  document.getElementById('settingsCategory').textContent = catSel.options[catSel.selectedIndex]?.text || 'General Knowledge';
  const difSel = document.getElementById('difficultySelect');
  document.getElementById('settingsDifficulty').textContent = difSel.options[difSel.selectedIndex]?.text || 'Medium';
  const fl = document.getElementById('finalPlayersList');
  fl.innerHTML = gs.players.map((p,i) => `
    <div class="player-item">
      <div class="flex items-center gap-md">
        <div style="width:28px;height:28px;background:var(--gray-700);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700">${i+1}</div>
        <span>${esc(p)}</span>
        ${p===gs.playerName?'<span class="badge badge-yellow" style="font-size:10px">You</span>':''}
      </div>
      <span class="badge badge-green" style="font-size:10px">Ready</span>
    </div>`).join('');
}

// ===== QUESTIONS =====
async function fetchQuestions(category, difficulty, limit) {
  try {
    const apiCat = API_CONFIG.CATEGORIES[category] || 'general_knowledge';
    const url = `${API_CONFIG.BASE_URL}/questions?limit=${limit}&categories=${apiCat}&difficulties=${difficulty}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('API '+res.status);
    const data = await res.json();
    return data.map(q => ({
      question: q.question.text,
      answers: [{text:q.correctAnswer,correct:true},...q.incorrectAnswers.map(a=>({text:a,correct:false}))].sort(()=>Math.random()-.5),
      category, difficulty: q.difficulty || difficulty
    }));
  } catch(e) { return getLocalQuestions(category, limit); }
}

function getLocalQuestions(category, limit) {
  const bank = {
    general:[
      {question:"Capital of France?", answers:[{text:"London",correct:false},{text:"Paris",correct:true},{text:"Berlin",correct:false},{text:"Rome",correct:false}], difficulty:"easy"},
      {question:"How many continents are there?", answers:[{text:"5",correct:false},{text:"6",correct:false},{text:"7",correct:true},{text:"8",correct:false}], difficulty:"easy"},
      {question:"Largest planet in our solar system?", answers:[{text:"Earth",correct:false},{text:"Jupiter",correct:true},{text:"Saturn",correct:false},{text:"Mars",correct:false}], difficulty:"easy"},
      {question:"Who wrote Romeo and Juliet?", answers:[{text:"Dickens",correct:false},{text:"Shakespeare",correct:true},{text:"Austen",correct:false},{text:"Twain",correct:false}], difficulty:"medium"},
      {question:"Chemical symbol for gold?", answers:[{text:"Go",correct:false},{text:"Gd",correct:false},{text:"Au",correct:true},{text:"Ag",correct:false}], difficulty:"medium"},
      {question:"How many sides does a hexagon have?", answers:[{text:"5",correct:false},{text:"6",correct:true},{text:"7",correct:false},{text:"8",correct:false}], difficulty:"easy"},
      {question:"Year WWII ended?", answers:[{text:"1943",correct:false},{text:"1944",correct:false},{text:"1945",correct:true},{text:"1946",correct:false}], difficulty:"medium"},
      {question:"Closest planet to the Sun?", answers:[{text:"Venus",correct:false},{text:"Mercury",correct:true},{text:"Earth",correct:false},{text:"Mars",correct:false}], difficulty:"easy"},
      {question:"Tallest mountain on Earth?", answers:[{text:"K2",correct:false},{text:"Everest",correct:true},{text:"Kangchenjunga",correct:false},{text:"Lhotse",correct:false}], difficulty:"easy"},
      {question:"Speed of light (approx km/s)?", answers:[{text:"299,792",correct:true},{text:"150,000",correct:false},{text:"500,000",correct:false},{text:"199,792",correct:false}], difficulty:"hard"}
    ],
    science:[
      {question:"Chemical symbol for water?", answers:[{text:"H2O",correct:true},{text:"CO2",correct:false},{text:"O2",correct:false},{text:"NaCl",correct:false}], difficulty:"easy"},
      {question:"Powerhouse of the cell?", answers:[{text:"Nucleus",correct:false},{text:"Mitochondria",correct:true},{text:"Ribosome",correct:false},{text:"Vacuole",correct:false}], difficulty:"easy"},
      {question:"Atomic number of carbon?", answers:[{text:"4",correct:false},{text:"6",correct:true},{text:"8",correct:false},{text:"12",correct:false}], difficulty:"medium"},
      {question:"Bones in adult human body?", answers:[{text:"196",correct:false},{text:"206",correct:true},{text:"216",correct:false},{text:"186",correct:false}], difficulty:"medium"},
      {question:"Red Planet?", answers:[{text:"Venus",correct:false},{text:"Mars",correct:true},{text:"Jupiter",correct:false},{text:"Saturn",correct:false}], difficulty:"easy"}
    ]
  };
  const pool = bank[category] || bank.general;
  return [...pool].sort(()=>Math.random()-.5).slice(0,limit);
}

// ===== START GAME =====
async function startGame() {
  if(!gs.currentGameMode) { showNotification('Please select a game mode first','warning'); return; }
  const mode = gs.gameModes.find(m => m.id===gs.currentGameMode);
  if(gs.players.length < mode.minPlayers) {
    showNotification(`${mode.name} needs at least ${mode.minPlayers} player${mode.minPlayers>1?'s':''}`, 'warning'); return;
  }
  if(gs.players.length > mode.maxPlayers) {
    showNotification(`${mode.name} supports max ${mode.maxPlayers} players`, 'warning'); return;
  }
  if(!gs.isOnlineGame) {
    gs.numQuestions = parseInt(document.getElementById('questionCount').value) || 10;
    gs.selectedCategory = document.getElementById('categorySelect').value;
    gs.selectedDifficulty = document.getElementById('difficultySelect').value;
  }
  gs.isGameActive = true;
  gs.currentQuestionIndex = 0;
  gs.currentPlayerIndex = 0;
  gs.score = 0;
  gs.lives = mode.lives;
  gs.timeBonus = 0;
  gs.timer = mode.timePerQuestion;
  gs.correctAnswers = 0;
  gs.currentStreak = 0;
  gs.maxStreak = 0;
  gs.hintCount = 2;
  gs.isBuzzerActive = false;
  gs.hasBuzzed = false;
  gs.answeredThisQuestion = false;
  gs.gameStartTime = Date.now();
  questionStartTime = null;
  gs.players.forEach(p => gs.playerScores[p] = 0);

  const btn = document.getElementById('startGameBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
  showNotification('Loading questions‚Ä¶','info');

  questionCache = await fetchQuestions(gs.selectedCategory, gs.selectedDifficulty, gs.numQuestions);
  if(!questionCache.length) {
    showNotification('Could not load questions. Try again.','error');
    gs.isGameActive = false;
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-play"></i> Start Game!';
    return;
  }
  btn.disabled = false;
  btn.innerHTML = '<i class="fas fa-play"></i> Start Game!';

  document.getElementById('modeName').textContent = mode.name;
  document.getElementById('currentGameMode').innerHTML = `<i class="fas fa-${mode.icon}"></i> <span>${mode.name}</span>`;
  document.getElementById('totalQuestionsDisplay').textContent = gs.numQuestions;
  document.getElementById('hintCount').textContent = gs.hintCount;
  updateLivesDisplay();
  updateScoreDisplay();

  if(gs.currentGameMode === 'buzzer') {
    document.getElementById('buzzerContainer').classList.remove('hidden');
  } else {
    document.getElementById('buzzerContainer').classList.add('hidden');
  }
  updateNavigation('game');
  loadQuestion();
  if(!['solo','countdown'].includes(gs.currentGameMode)) updateCurrentPlayerIndicator();
}

function updateLivesDisplay() {
  const el = document.getElementById('playerLives');
  if(!el) return;
  if(gs.currentGameMode==='ladder') { el.textContent=`Lvl ${gs.currentStreak}`; return; }
  if(gs.currentGameMode==='buzzer') { el.textContent='‚àû'; return; }
  if(gs.lives>5) el.textContent=gs.lives+'√ó‚ù§Ô∏è';
  else if(gs.lives>0) el.textContent='‚ù§Ô∏è'.repeat(gs.lives);
  else el.textContent='üíÄ';
}

function updateScoreDisplay() {
  document.getElementById('playerScore').textContent = gs.score;
  document.getElementById('playerScoreHud').textContent = gs.totalScore + gs.score;
  document.getElementById('timeBonus').textContent = gs.timeBonus;
}

function updateCurrentPlayerIndicator() {
  const el = document.getElementById('currentPlayerIndicator');
  if(gs.players.length > 1) {
    el.textContent = `üéØ ${gs.players[gs.currentPlayerIndex]}'s turn`;
    el.classList.remove('hidden');
  } else {
    el.classList.add('hidden');
  }
}

function loadQuestion() {
  if(gs.currentQuestionIndex >= gs.numQuestions || gs.currentQuestionIndex >= questionCache.length) { endGame(); return; }
  const q = questionCache[gs.currentQuestionIndex];
  if(!q) { endGame(); return; }
  gs.currentQuestion = q;
  gs.answeredThisQuestion = false;

  document.getElementById('currentQuestion').textContent = gs.currentQuestionIndex+1;
  document.getElementById('currentQuestionNum').textContent = `${gs.currentQuestionIndex+1}/${gs.numQuestions}`;
  const cat = gs.categories.find(c => c.id===gs.selectedCategory);
  document.getElementById('questionCategory').textContent = cat ? cat.name : 'General';
  document.getElementById('difficultyLabel').textContent = (q.difficulty||gs.selectedDifficulty).charAt(0).toUpperCase()+(q.difficulty||gs.selectedDifficulty).slice(1);
  document.getElementById('questionText').textContent = q.question;

  const container = document.getElementById('answersContainer');
  container.innerHTML = '';
  const letters = ['A','B','C','D'];
  let answers = [...q.answers];
  while(answers.length<4) answers.push({text:'No answer',correct:false});
  answers.slice(0,4).forEach((ans,i) => {
    const el = document.createElement('div');
    el.className = 'answer-option';
    el.innerHTML = `<div class="answer-letter">${letters[i]}</div><div class="flex-1">${esc(ans.text)}</div>`;
    el.addEventListener('click', () => handleAnswer(ans.correct, el, q.difficulty||gs.selectedDifficulty));
    container.appendChild(el);
  });

  document.getElementById('nextQuestionBtn').disabled = true;
  document.getElementById('hintBtn').disabled = gs.hintCount === 0;
  document.getElementById('hintCount').textContent = gs.hintCount;
  document.getElementById('gameTimer').style.color = 'var(--yellow)';

  if(gs.currentGameMode==='buzzer') {
    resetBuzzerState();
  } else if(gs.timer > 0) {
    startTimer();
  }
}

function handleAnswer(isCorrect, element, difficulty) {
  if(!gs.isGameActive || gs.answeredThisQuestion) return;
  if(gs.currentGameMode==='buzzer' && !gs.hasBuzzed) { showNotification('Buzz in first!','warning'); return; }

  gs.answeredThisQuestion = true;
  stopTimer();

  document.querySelectorAll('.answer-option').forEach(el => el.classList.add('answered'));

  if(isCorrect) {
    element.classList.add('correct');
    const pts = calculatePoints(difficulty);
    gs.currentStreak++;
    gs.maxStreak = Math.max(gs.maxStreak, gs.currentStreak);
    gs.score += pts;
    gs.playerScores[gs.players[gs.currentPlayerIndex]] = (gs.playerScores[gs.players[gs.currentPlayerIndex]]||0) + pts;
    gs.correctAnswers++;
    updateScoreDisplay();
    if(gs.currentGameMode==='ladder') showFeedback(`+${pts} pts! Level ${gs.currentStreak}`, 'correct');
    else showFeedback(`+${pts} pts!`, 'correct');
    checkSpeedAchievement();
    updateLivesDisplay();
  } else {
    element.classList.add('incorrect');
    document.querySelectorAll('.answer-option').forEach(el => {
      const txt = el.querySelector('.flex-1').textContent;
      if(gs.currentQuestion.answers.find(a => a.text===txt && a.correct)) el.classList.add('reveal-correct');
    });
    gs.currentStreak = 0;
    if(gs.currentGameMode==='battle') {
      showFeedback('Eliminated!','incorrect');
      document.getElementById('nextQuestionBtn').disabled = false;
      setTimeout(() => eliminatePlayer(), 1400);
      return;
    } else if(gs.currentGameMode==='ladder') {
      showFeedback('Wrong! Back to Level 1','incorrect');
      updateLivesDisplay();
    } else if(gs.currentGameMode==='buzzer') {
      showFeedback('Wrong!','incorrect');
      gs.hasBuzzed = false; gs.isBuzzerActive = true;
    } else {
      gs.lives--;
      updateLivesDisplay();
      showFeedback('Wrong! -1 life','incorrect');
    }
  }

  document.getElementById('nextQuestionBtn').disabled = false;
  if(gs.lives<=0 && !['ladder','battle','buzzer'].includes(gs.currentGameMode)) {
    setTimeout(() => endGame(), 1500);
  }
}

function startTimer() {
  questionStartTime = Date.now();
  stopTimer();
  let timeLeft = gs.timer;
  document.getElementById('gameTimer').textContent = timeLeft+'s';
  gs.timerInterval = setInterval(() => {
    if(gs.timerPaused) return;
    timeLeft--;
    const el = document.getElementById('gameTimer');
    el.textContent = timeLeft+'s';
    el.style.color = timeLeft<=5 ? 'var(--red)' : timeLeft<=10 ? 'var(--orange)' : 'var(--yellow)';
    if(timeLeft<=0) { stopTimer(); timeUp(); }
  }, 1000);
}

function stopTimer() { clearInterval(gs.timerInterval); gs.timerInterval = null; }

function timeUp() {
  if(gs.answeredThisQuestion) return;
  gs.answeredThisQuestion = true;
  gs.currentStreak = 0;
  document.querySelectorAll('.answer-option').forEach(el => {
    el.classList.add('answered');
    const txt = el.querySelector('.flex-1').textContent;
    if(gs.currentQuestion.answers.find(a => a.text===txt && a.correct)) el.classList.add('reveal-correct');
  });
  showFeedback("‚è∞ Time's up!", 'incorrect');
  if(!['ladder','buzzer'].includes(gs.currentGameMode)) { gs.lives--; updateLivesDisplay(); }
  document.getElementById('nextQuestionBtn').disabled = false;
  if(gs.lives<=0 && !['ladder','battle','buzzer'].includes(gs.currentGameMode)) {
    setTimeout(() => endGame(), 1500);
  }
}

function calculatePoints(difficulty) {
  let base = difficulty==='hard' ? 200 : difficulty==='medium' ? 150 : 100;
  switch(gs.currentGameMode) {
    case 'countdown': {
      const elapsed = questionStartTime ? Math.max(0,(Date.now()-questionStartTime)/1000) : 0;
      const remaining = Math.max(0, gs.timer-elapsed);
      const bonus = Math.round((remaining/gs.timer)*100);
      gs.timeBonus += bonus;
      document.getElementById('timeBonus').textContent = gs.timeBonus;
      return base + bonus;
    }
    case 'ladder': return base * (gs.currentStreak + 1);
    case 'battle': return base + (gs.players.length * 25);
    case 'buzzer': return base + 50;
    case 'solo': return base + Math.round((gs.correctAnswers/gs.numQuestions)*50);
    default: return base + Math.floor(gs.currentQuestionIndex/3)*25;
  }
}

function checkSpeedAchievement() {
  if(questionStartTime && gs.timer > 0) {
    const elapsed = (Date.now()-questionStartTime)/1000;
    if(1-(elapsed/gs.timer) >= 0.8) unlockAchievement('speed_demon');
  }
}

function nextQuestion() {
  if(!['buzzer','countdown'].includes(gs.currentGameMode)) {
    gs.currentPlayerIndex = (gs.currentPlayerIndex+1) % gs.players.length;
    if(gs.players.length > 1) updateCurrentPlayerIndicator();
  }
  gs.currentQuestionIndex++;
  if(gs.currentQuestionIndex >= gs.numQuestions) { endGame(); return; }
  loadQuestion();
}

function eliminatePlayer() {
  const eliminated = gs.players[gs.currentPlayerIndex];
  gs.players = gs.players.filter(p => p!==eliminated);
  showNotification(`${eliminated} has been eliminated!`, 'error');
  if(gs.players.length <= 1) { setTimeout(() => endGame(), 1000); return; }
  gs.currentPlayerIndex = gs.currentPlayerIndex % gs.players.length;
  updateCurrentPlayerIndicator();
  gs.currentQuestionIndex++;
  loadQuestion();
}

function resetBuzzerState() {
  gs.isBuzzerActive = true; gs.hasBuzzed = false;
  const btn = document.getElementById('buzzerButton');
  btn.className = 'buzzer-button buzzer-ready';
  btn.disabled = false;
  document.getElementById('buzzerInstruction').textContent = 'Wait for question, then buzz in!';
  document.getElementById('playerBuzzed').textContent = '';
  document.querySelectorAll('.answer-option').forEach(el => el.classList.add('answered'));
}

function buzzIn() {
  if(!gs.isBuzzerActive || gs.hasBuzzed) return;
  gs.hasBuzzed = true; gs.isBuzzerActive = false;
  const btn = document.getElementById('buzzerButton');
  btn.className = 'buzzer-button buzzer-buzzed'; btn.disabled = true;
  document.getElementById('buzzerInstruction').textContent = 'You buzzed in! Select your answer:';
  document.getElementById('playerBuzzed').textContent = `${gs.players[gs.currentPlayerIndex]} has the floor!`;
  document.querySelectorAll('.answer-option').forEach(el => el.classList.remove('answered'));
}

function showHint() {
  if(gs.hintCount<=0 || !gs.currentQuestion) return;
  gs.hintCount--;
  document.getElementById('hintCount').textContent = gs.hintCount;
  document.getElementById('hintBtn').disabled = gs.hintCount===0;
  const wrongOptions = Array.from(document.querySelectorAll('.answer-option')).filter(el => {
    const txt = el.querySelector('.flex-1').textContent;
    return gs.currentQuestion.answers.find(a => a.text===txt && !a.correct);
  });
  if(wrongOptions.length > 0) {
    const toHide = wrongOptions[Math.floor(Math.random()*wrongOptions.length)];
    toHide.style.opacity = '0.3'; toHide.style.pointerEvents = 'none'; toHide.classList.add('answered');
    showNotification(`Eliminated one wrong answer! (${gs.hintCount} hint${gs.hintCount===1?'':'s'} left)`,'info');
  }
}

function pauseGame() {
  if(!gs.isGameActive) return;
  gs.timerPaused = true; openModal('pauseModal');
}

function resumeGame() { gs.timerPaused = false; closeModal('pauseModal'); }

// ===== END GAME =====
function endGame() {
  gs.isGameActive = false; stopTimer();
  document.getElementById('currentPlayerIndicator').classList.add('hidden');

  const timePlayed = Math.floor((Date.now()-gs.gameStartTime)/1000);
  const accuracy = gs.numQuestions>0 ? Math.round((gs.correctAnswers/gs.numQuestions)*100) : 0;

  let winner = gs.playerName, highScore = -1;
  Object.entries(gs.playerScores).forEach(([p,s]) => { if(s>highScore){highScore=s;winner=p;} });
  if(gs.players.length===0) winner = gs.playerName;

  gs.totalGames++; gs.lifetimeCorrect += gs.correctAnswers; gs.lifetimeTotal += gs.numQuestions;
  gs.totalScore += gs.score;
  if(gs.maxStreak > gs.highestStreak) gs.highestStreak = gs.maxStreak;
  if(winner===gs.playerName || gs.players.length<=1) gs.winStreak++; else gs.winStreak=0;

  checkAchievements(); saveGameState(); updateHUD();

  document.getElementById('finalScore').textContent = gs.score.toLocaleString();
  document.getElementById('correctAnswersModal').textContent = `${gs.correctAnswers}/${gs.numQuestions}`;
  document.getElementById('timePlayed').textContent = `${timePlayed}s`;
  document.getElementById('bonusEarned').textContent = gs.timeBonus;
  document.getElementById('winnerName').textContent = winner;
  document.getElementById('performanceSummary').textContent = `Accuracy: ${accuracy}% | Best streak: ${gs.maxStreak}`;
  document.getElementById('winnerSection').style.display = gs.players.length > 1 ? '' : 'none';

  openModal('gameCompleteModal');
}

// ===== ACHIEVEMENTS =====
function checkAchievements() {
  if(gs.totalGames>=1) unlockAchievement('first_game');
  if(gs.correctAnswers===gs.numQuestions && gs.numQuestions>=5) unlockAchievement('perfect_game');
  if(gs.maxStreak>=10) unlockAchievement('streak_10');
  if(gs.winStreak>=5) unlockAchievement('trivia_champion');
  if(gs.totalGames>=100) unlockAchievement('centurion');
  if(gs.score>=1000) unlockAchievement('high_scorer');
}

function unlockAchievement(id) {
  const a = gs.achievements.find(x => x.id===id);
  if(a && !a.unlocked) {
    a.unlocked = true;
    if(gs.settings.achievementNotifications) showNotification(`üèÜ Achievement: ${a.name}!`, 'achievement');
    saveGameState();
  }
}

// ===== PROFILE =====
function updateHUD() {
  document.getElementById('playerName').textContent = gs.playerName;
  document.getElementById('playerScoreHud').textContent = gs.totalScore.toLocaleString();
  const hudPic = document.getElementById('profilePicHud');
  if(gs.playerProfilePic) {
    hudPic.innerHTML = `<img src="${gs.playerProfilePic}" alt="" style="width:100%;height:100%;object-fit:cover">`;
  } else {
    hudPic.innerHTML = `<i class="fas fa-user hud-silhouette"></i>`;
  }
}

function updateProfileDisplay() {
  document.getElementById('profileName').textContent = gs.playerName;
  document.getElementById('profileTotalScore').textContent = gs.totalScore.toLocaleString();
  const pic = document.getElementById('profilePic');
  if(gs.playerProfilePic) {
    pic.innerHTML = `<img src="${gs.playerProfilePic}" alt="${esc(gs.playerName)}" style="width:100%;height:100%;object-fit:cover"><div class="profile-upload"><i class="fas fa-camera"></i></div>`;
  } else {
    pic.innerHTML = `<i class="fas fa-user" style="font-size:40px;color:var(--gray-500)"></i><div class="profile-upload"><i class="fas fa-camera"></i></div>`;
  }
}

// ===== MODALS =====
function openModal(id) {
  const m = document.getElementById(id);
  if(!m) return;
  if(id==='pauseModal') gs.timerPaused = true;
  if(id==='nameModal') document.getElementById('newUsername').value = gs.playerName;
  if(id==='avatarModal') setupAvatarModal();
  if(id==='themeModal') setupThemeModal();
  m.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal(id) {
  const m = document.getElementById(id);
  if(!m) return;
  m.classList.remove('active');
  if(!document.querySelector('.modal-overlay.active')) document.body.style.overflow = '';
  if(id==='pauseModal' && gs.isGameActive) gs.timerPaused = false;
}

function setupAvatarModal() {
  const currentDisplay = document.getElementById('avatarCurrentDisplay');
  if(gs.playerProfilePic) {
    currentDisplay.innerHTML = `<img src="${gs.playerProfilePic}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    document.getElementById('avatarRemoveContainer').classList.remove('hidden');
  } else {
    currentDisplay.innerHTML = `<i class="fas fa-user" style="font-size:40px;color:var(--gray-500)"></i>`;
    document.getElementById('avatarRemoveContainer').classList.add('hidden');
  }
  document.getElementById('avatarPreviewContainer').classList.add('hidden');
  gs.pendingProfilePic = null; gs.pendingRemovePhoto = false;
  const upload = document.getElementById('avatarUpload');
  upload.value = '';
  upload.onchange = function() {
    const file = this.files[0]; if(!file) return;
    if(file.size > 5*1024*1024) { showNotification('Image too large. Max 5MB.','warning'); return; }
    const reader = new FileReader();
    reader.onload = e => {
      gs.pendingProfilePic = e.target.result; gs.pendingRemovePhoto = false;
      document.getElementById('avatarPreview').src = e.target.result;
      document.getElementById('avatarPreviewContainer').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  };
  const removeBtn = document.getElementById('removeAvatarBtn');
  if(removeBtn) {
    removeBtn.onclick = () => {
      gs.pendingRemovePhoto = true; gs.pendingProfilePic = null;
      currentDisplay.innerHTML = `<i class="fas fa-user" style="font-size:40px;color:var(--gray-500)"></i>`;
      document.getElementById('avatarPreviewContainer').classList.add('hidden');
      document.getElementById('avatarRemoveContainer').classList.add('hidden');
      showNotification('Photo will be removed on save','info');
    };
  }
}

function setupThemeModal() {
  const colors = [
    {name:'Yellow',value:'#FFDE21'},{name:'Purple',value:'#6C5CE7'},
    {name:'Red',value:'#FF7675'},{name:'Green',value:'#00B894'},
    {name:'Blue',value:'#3498DB'},{name:'Pink',value:'#FD79A8'},
    {name:'Orange',value:'#FDCB6E'},{name:'Cyan',value:'#00CEC9'}
  ];
  gs.pendingThemeColor = gs.settings.themeColor;
  document.getElementById('themeColors').innerHTML = colors.map(c => `
    <div class="theme-option ${gs.settings.themeColor===c.value?'selected':''}" data-color="${c.value}">
      <div class="theme-color" style="background:${c.value}"></div>
      <div class="theme-name">${c.name}</div>
    </div>`).join('');
  document.getElementById('themeColors').querySelectorAll('.theme-option').forEach(el => {
    el.addEventListener('click', () => {
      document.getElementById('themeColors').querySelectorAll('.theme-option').forEach(x => x.classList.remove('selected'));
      el.classList.add('selected');
      gs.pendingThemeColor = el.dataset.color;
    });
  });
}

// ===== FEEDBACK & NOTIFICATIONS =====
function showFeedback(msg, type) {
  const el = document.createElement('div');
  el.className = `feedback-message feedback-${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1600);
}

let notifQueue = 0;
function showNotification(msg, type='info') {
  const el = document.createElement('div');
  el.className = 'notification';
  const icons = {info:'fa-info-circle',achievement:'fa-trophy',warning:'fa-exclamation-triangle',error:'fa-times-circle'};
  const colors = {info:'var(--yellow)',achievement:'var(--yellow)',warning:'var(--orange)',error:'var(--red)'};
  el.style.borderLeftColor = colors[type]||'var(--yellow)';
  el.style.top = (80+notifQueue*70)+'px';
  el.innerHTML = `<div class="flex items-center gap-sm"><i class="fas ${icons[type]||'fa-info-circle'}" style="color:${colors[type]||'var(--yellow)'}"></i><div class="flex-1 text-sm">${esc(msg)}</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--gray-400);cursor:pointer;font-size:16px">√ó</button></div>`;
  document.body.appendChild(el);
  notifQueue++;
  setTimeout(() => {
    el.style.animation='slideOutRight .3s ease forwards';
    setTimeout(() => { el.remove(); notifQueue--; }, 300);
  }, 3000);
}

// ===== ONLINE =====
async function initSupabase() {
  try {
    if(!window.supabase) return false;
    supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
    return true;
  } catch(e) { return false; }
}

async function refreshOnlineRooms() {
  const el = document.getElementById('roomList');
  if(!supabaseClient) await initSupabase();
  if(!supabaseClient) { el.innerHTML='<div class="player-empty">Could not connect to server</div>'; return; }
  try {
    const { data, error } = await supabaseClient.from('rooms').select('*').eq('status','waiting').order('created_at',{ascending:false}).limit(20);
    if(error) throw error;
    if(!data || data.length===0) {
      el.innerHTML = '<div class="player-empty">No open rooms. Create one!</div>';
    } else {
      el.innerHTML = data.map(r => {
        const mode = gs.gameModes.find(m => m.id===r.game_mode);
        return `
          <div class="room-item">
            <div>
              <div class="font-bold">${esc(r.name||'Untitled Room')}</div>
              <div class="text-sm text-gray-400">${mode?`<i class="fas fa-${mode.icon}" style="color:${mode.color};margin-right:4px"></i>${mode.name}`:r.game_mode} ‚Ä¢ ${r.max_players} max</div>
            </div>
            <div class="flex items-center gap-sm">
              <span class="text-yellow font-bold">${r.code}</span>
              <button class="btn btn-primary btn-sm" onclick="quickJoinRoom('${r.code}')">Join</button>
            </div>
          </div>`;
      }).join('');
    }
  } catch(e) { el.innerHTML='<div class="player-empty">Error loading rooms</div>'; }
}

function quickJoinRoom(code) {
  document.getElementById('joinRoomCode').value = code;
  openModal('joinRoomModal');
}

async function createOnlineRoom() {
  const roomName = document.getElementById('roomName').value.trim() || `${gs.playerName}'s Room`;
  const modeId = document.getElementById('onlineModeSelect').value;
  const category = document.getElementById('onlineCategorySelect').value;
  const questions = document.getElementById('onlineQuestionCount').value;
  const maxP = document.getElementById('maxPlayers').value;
  const difficulty = document.getElementById('onlineDifficultySelect').value || 'medium';

  if(!supabaseClient) await initSupabase();
  if(supabaseClient) {
    const code = Array.from({length:6},()=>'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random()*32)]).join('');
    try {
      const { data, error } = await supabaseClient.from('rooms').insert([{
        code, name:roomName, game_mode:modeId, category, difficulty,
        question_count:parseInt(questions), max_players:parseInt(maxP),
        player_count:1, host_name:gs.playerName, status:'waiting', created_at:new Date().toISOString()
      }]).select().single();
      if(error) throw error;
      setupWaitingRoom(code, data.id, modeId, questions, category, difficulty, parseInt(maxP), true);
      subscribeToRoom(code);
    } catch(e) { showNotification('Failed to create room: '+e.message,'error'); return; }
  } else {
    const code = Array.from({length:6},()=>'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random()*32)]).join('');
    setupWaitingRoom(code, null, modeId, questions, category, difficulty, parseInt(maxP), true);
  }
  closeModal('createRoomModal');
}

async function joinOnlineRoom() {
  const code = document.getElementById('joinRoomCode').value.trim().toUpperCase();
  if(!code || code.length<4) { showNotification('Enter a valid room code','warning'); return; }
  if(!supabaseClient) await initSupabase();
  if(supabaseClient) {
    try {
      const { data:room, error } = await supabaseClient.from('rooms').select('*').eq('code',code).single();
      if(error || !room) throw new Error('Room not found');
      if(room.status !== 'waiting') throw new Error('Game already in progress');
      await supabaseClient.from('rooms').update({player_count:(room.player_count||1)+1}).eq('id',room.id);
      setupWaitingRoom(code, room.id, room.game_mode, room.question_count, room.category, room.difficulty||'medium', room.max_players, false);
      subscribeToRoom(code);
      broadcastPresence('join');
    } catch(e) { showNotification('Could not join: '+e.message,'error'); return; }
  } else {
    setupWaitingRoom(code, null, 'classic', 10, 'general', 'medium', 4, false);
  }
  closeModal('joinRoomModal');
}

function setupWaitingRoom(code, roomId, modeId, questions, category, difficulty, maxP, isHost) {
  gs.roomCode = code; gs.roomId = roomId; gs.isHost = isHost;
  gs.isOnlineGame = true; gs.currentGameMode = modeId;
  gs.numQuestions = parseInt(questions); gs.selectedCategory = category||'general';
  gs.selectedDifficulty = difficulty||'medium'; gs.maxRoomPlayers = maxP;
  gs.onlinePlayers = [{name:gs.playerName, isHost, isReady:true}];

  document.getElementById('roomCodeDisplay').textContent = code;
  const mode = gs.gameModes.find(m => m.id===modeId);
  const cat = gs.categories.find(c => c.id===category);
  document.getElementById('roomMode').textContent = mode ? mode.name : modeId;
  document.getElementById('roomQuestions').textContent = questions;
  document.getElementById('roomCategory').textContent = cat ? cat.name : category;

  updateOnlinePlayersList();
  updateNavigation('waiting');
}

function subscribeToRoom(code) {
  if(realtimeChannel && supabaseClient) { supabaseClient.removeChannel(realtimeChannel); realtimeChannel = null; }
  if(!supabaseClient) return;
  realtimeChannel = supabaseClient.channel(`room:${code}`, {config:{broadcast:{self:false}}});
  realtimeChannel
    .on('broadcast', {event:'presence'}, ({payload}) => handlePresence(payload))
    .on('broadcast', {event:'start_game'}, ({payload}) => {
      if(!gs.isHost) {
        questionCache = payload.questions;
        gs.onlinePlayers = payload.players;
        gs.players = gs.onlinePlayers.map(p => p.name);
        gs.players.forEach(p => gs.playerScores[p] = 0);
        startOnlineFromBroadcast();
      }
    })
    .on('broadcast', {event:'leave'}, ({payload}) => {
      gs.onlinePlayers = gs.onlinePlayers.filter(p => p.name!==payload.name);
      updateOnlinePlayersList();
      showNotification(`${payload.name} left the room`,'warning');
    })
    .subscribe();
}

function broadcastPresence(type) {
  if(!realtimeChannel) return;
  realtimeChannel.send({type:'broadcast', event:'presence', payload:{type, name:gs.playerName}});
}

function handlePresence(payload) {
  if(payload.type==='join') {
    if(!gs.onlinePlayers.find(p => p.name===payload.name)) {
      gs.onlinePlayers.push({name:payload.name, isHost:false, isReady:true});
      updateOnlinePlayersList();
      showNotification(`${payload.name} joined!`,'achievement');
    }
    if(gs.isHost) {
      realtimeChannel.send({type:'broadcast', event:'presence', payload:{type:'roster', players:gs.onlinePlayers}});
    }
  } else if(payload.type==='roster') {
    gs.onlinePlayers = payload.players;
    if(!gs.onlinePlayers.find(p => p.name===gs.playerName)) {
      gs.onlinePlayers.push({name:gs.playerName, isHost:false, isReady:true});
    }
    updateOnlinePlayersList();
  }
}

function startOnlineFromBroadcast() {
  gs.isGameActive = true; gs.currentQuestionIndex = 0; gs.currentPlayerIndex = 0;
  gs.score = 0; gs.timeBonus = 0; gs.correctAnswers = 0;
  gs.currentStreak = 0; gs.maxStreak = 0; gs.hintCount = 2;
  gs.answeredThisQuestion = false; gs.gameStartTime = Date.now();
  const mode = gs.gameModes.find(m => m.id===gs.currentGameMode);
  gs.lives = mode ? mode.lives : 3;
  gs.timer = mode ? mode.timePerQuestion : 30;
  document.getElementById('modeName').textContent = mode ? mode.name : gs.currentGameMode;
  document.getElementById('currentGameMode').innerHTML = `<i class="fas fa-${mode?.icon||'gamepad'}"></i> <span>${mode?.name||gs.currentGameMode}</span>`;
  document.getElementById('totalQuestionsDisplay').textContent = gs.numQuestions;
  document.getElementById('hintCount').textContent = gs.hintCount;
  updateLivesDisplay(); updateScoreDisplay();
  if(gs.currentGameMode==='buzzer') document.getElementById('buzzerContainer').classList.remove('hidden');
  else document.getElementById('buzzerContainer').classList.add('hidden');
  updateNavigation('game');
  loadQuestion();
}

function updateOnlinePlayersList() {
  const list = document.getElementById('onlinePlayersList');
  const badge = document.getElementById('playerCountBadge');
  const hint = document.getElementById('startGameHint');
  const count = gs.onlinePlayers.length;
  const max = gs.maxRoomPlayers;
  if(badge) badge.textContent = `${count}/${max}`;
  if(count===0) { list.innerHTML='<div class="player-empty">No players yet</div>'; }
  else {
    list.innerHTML = gs.onlinePlayers.map(p => `
      <div class="player-item">
        <div class="flex items-center gap-md">
          <div style="width:32px;height:32px;background:var(--gray-700);border-radius:50%;display:flex;align-items:center;justify-content:center"><i class="fas fa-user" style="font-size:14px"></i></div>
          <div><div class="player-name">${esc(p.name)} ${p.name===gs.playerName?'(You)':''}</div><div class="text-xs text-gray-400">${p.isHost?'Host':'Player'}</div></div>
        </div>
        ${p.isHost ? '<i class="fas fa-crown text-yellow"></i>' : '<span class="badge badge-green" style="font-size:10px">Ready</span>'}
      </div>`).join('');
  }
  const mode = gs.gameModes.find(m => m.id===gs.currentGameMode);
  const minP = mode ? mode.minPlayers : 2;
  const canStart = gs.isHost && count >= minP;
  document.getElementById('startOnlineGameBtn').disabled = !canStart;
  if(hint) hint.textContent = canStart ? 'Ready to start!' : `Waiting for ${Math.max(0,minP-count)} more player${minP-count===1?'':'s'}...`;
}

// ===== SETTINGS =====
function confirmResetStats() {
  if(!confirm('Reset all stats and achievements? This cannot be undone.')) return;
  gs.totalGames=0; gs.lifetimeCorrect=0; gs.lifetimeTotal=0;
  gs.highestStreak=0; gs.winStreak=0; gs.totalScore=0;
  gs.achievements.forEach(a => a.unlocked=false);
  saveGameState(); updateHUD(); updateProfileDisplay();
  showNotification('Stats reset!','info');
}

// ===== UTILITIES =====
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ===== EVENT LISTENERS =====
function setupEventListeners() {
  // Add player
  document.getElementById('addPlayerBtn').addEventListener('click', () => addPlayer(document.getElementById('playerNameInput').value));
  document.getElementById('playerNameInput').addEventListener('keydown', e => { if(e.key==='Enter') addPlayer(e.target.value); });

  // Stepper
  document.getElementById('nextStepBtn').addEventListener('click', () => {
    if(!gs.currentGameMode) { showNotification('Select a game mode first','warning'); updateNavigation('modes'); return; }
    if(gs.players.length<1) { showNotification('Add at least 1 player','warning'); return; }
    navigateToStep(2);
  });
  document.getElementById('prevStepBtn').addEventListener('click', () => navigateToStep(1));
  document.getElementById('nextStepBtn2').addEventListener('click', () => navigateToStep(3));
  document.getElementById('prevStepBtn2').addEventListener('click', () => navigateToStep(2));
  document.getElementById('startGameBtn').addEventListener('click', startGame);

  // Number inputs
  function setupNum(decId, incId, inputId, min, max) {
    document.getElementById(decId).addEventListener('click', () => {
      const v = parseInt(document.getElementById(inputId).value);
      if(v>min) document.getElementById(inputId).value = v-1;
    });
    document.getElementById(incId).addEventListener('click', () => {
      const v = parseInt(document.getElementById(inputId).value);
      if(v<max) document.getElementById(inputId).value = v+1;
    });
    document.getElementById(inputId).addEventListener('change', function() {
      this.value = Math.min(max, Math.max(min, parseInt(this.value)||min));
    });
  }
  setupNum('questionDecrease','questionIncrease','questionCount',5,50);
  setupNum('onlineQuestionDecrease','onlineQuestionIncrease','onlineQuestionCount',5,50);

  // Game controls
  document.getElementById('nextQuestionBtn').addEventListener('click', nextQuestion);
  document.getElementById('hintBtn').addEventListener('click', showHint);
  document.getElementById('pauseBtn').addEventListener('click', pauseGame);
  document.getElementById('buzzerButton').addEventListener('click', buzzIn);
  document.getElementById('resumeGameBtn').addEventListener('click', resumeGame);
  document.getElementById('quitGameBtn').addEventListener('click', () => {
    if(!confirm('Quit current game?')) return;
    closeModal('pauseModal');
    gs.isGameActive = false; stopTimer();
    updateNavigation('home');
  });

  // Game complete modal
  document.getElementById('backToMenuBtn').addEventListener('click', () => {
    closeModal('gameCompleteModal');
    gs.isOnlineGame = false;
    updateNavigation('home');
  });
  document.getElementById('playAgainBtn').addEventListener('click', () => {
    closeModal('gameCompleteModal');
    if(gs.isOnlineGame) updateNavigation('waiting');
    else { updateNavigation('play'); navigateToStep(1); }
  });

  // Online
  document.getElementById('createRoomBtn').addEventListener('click', () => openModal('createRoomModal'));
  document.getElementById('joinRoomBtn').addEventListener('click', () => openModal('joinRoomModal'));
  document.getElementById('refreshRoomsBtn').addEventListener('click', refreshOnlineRooms);
  document.getElementById('createRoomConfirmBtn').addEventListener('click', createOnlineRoom);
  document.getElementById('joinRoomConfirmBtn').addEventListener('click', joinOnlineRoom);
  document.getElementById('joinRoomCode').addEventListener('input', function() { this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g,''); });
  document.getElementById('roomCodeDisplay').addEventListener('click', () => {
    if(gs.roomCode) navigator.clipboard.writeText(gs.roomCode).then(()=>showNotification('Room code copied!','info')).catch(()=>showNotification('Code: '+gs.roomCode,'info'));
  });
  document.getElementById('leaveRoomBtn').addEventListener('click', () => {
    if(!confirm('Leave this room?')) return;
    if(realtimeChannel && supabaseClient) { broadcastPresence('leave'); supabaseClient.removeChannel(realtimeChannel); realtimeChannel=null; }
    gs.isOnlineGame = false; gs.onlinePlayers = [];
    updateNavigation('online');
  });
  document.getElementById('startOnlineGameBtn').addEventListener('click', async () => {
    if(!gs.isHost) return;
    showNotification('Fetching questions‚Ä¶','info');
    const qs = await fetchQuestions(gs.selectedCategory, gs.selectedDifficulty, gs.numQuestions);
    if(!qs.length) { showNotification('Could not load questions','error'); return; }
    if(supabaseClient && gs.roomId) await supabaseClient.from('rooms').update({status:'playing'}).eq('id',gs.roomId);
    if(realtimeChannel) {
      realtimeChannel.send({type:'broadcast', event:'start_game', payload:{
        questions:qs, players:gs.onlinePlayers
      }});
    }
    questionCache = qs;
    gs.players = gs.onlinePlayers.map(p => p.name);
    gs.players.forEach(p => gs.playerScores[p] = 0);
    startOnlineFromBroadcast();
  });

  // Modes (delegated)
  document.addEventListener('click', e => {
    const playBtn = e.target.closest('.play-mode-btn');
    if(playBtn) {
      e.stopPropagation();
      gs.currentGameMode = playBtn.dataset.mode;
      gs.players = [gs.playerName]; gs.playerScores = {};
      updatePlayersList(); updateNavigation('play'); navigateToStep(1);
      const mode = gs.gameModes.find(m => m.id===gs.currentGameMode);
      if(mode) { document.getElementById('setupModeTitle').textContent=`${mode.name} Setup`; document.getElementById('setupModeDescription').textContent=mode.description; }
    }
    const viewBtn = e.target.closest('.view-mode-btn');
    if(viewBtn) {
      e.stopPropagation();
      const mode = gs.gameModes.find(m => m.id===viewBtn.dataset.mode);
      if(!mode) return;
      document.getElementById('modeDetailsTitle').textContent = mode.name;
      document.getElementById('modeDetailsSubtitle').textContent = mode.description;
      document.getElementById('modeRules').innerHTML = mode.rules.map(r=>`<div class="flex gap-sm mb-sm" style="align-items:flex-start"><i class="fas fa-check text-green" style="margin-top:3px;flex-shrink:0"></i><span>${r}</span></div>`).join('');
      document.getElementById('modeInstructions').innerHTML = mode.instructions.map((r,i)=>`<div class="flex gap-sm mb-sm" style="align-items:flex-start"><span class="badge badge-yellow" style="flex-shrink:0;min-width:24px;justify-content:center">${i+1}</span><span>${r}</span></div>`).join('');
      document.getElementById('playThisModeBtn').onclick = () => {
        gs.currentGameMode = mode.id; gs.players=[gs.playerName]; gs.playerScores={};
        updatePlayersList(); closeModal('modeDetailsModal'); updateNavigation('play'); navigateToStep(1);
        document.getElementById('setupModeTitle').textContent=`${mode.name} Setup`;
        document.getElementById('setupModeDescription').textContent=mode.description;
      };
      openModal('modeDetailsModal');
    }
    const catBtn = e.target.closest('.play-category-btn');
    if(catBtn) {
      e.stopPropagation();
      gs.currentGameMode = gs.currentGameMode || 'classic';
      gs.players = [gs.playerName]; gs.playerScores = {};
      updatePlayersList(); updateNavigation('play'); navigateToStep(1);
      setTimeout(() => { const cs=document.getElementById('categorySelect'); if(cs) cs.value=catBtn.dataset.category; }, 50);
    }
  });

  // Profile
  document.getElementById('saveUsernameBtn').addEventListener('click', () => {
    const val = document.getElementById('newUsername').value.trim();
    if(!val) { showNotification('Username cannot be empty','warning'); return; }
    const idx = gs.players.indexOf(gs.playerName);
    if(idx !== -1) gs.players[idx] = val;
    gs.playerName = val;
    updateHUD(); updateProfileDisplay(); updatePlayersList(); saveGameState();
    closeModal('nameModal'); showNotification('Username updated!','info');
  });
  document.getElementById('newUsername').addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('saveUsernameBtn').click(); });

  document.getElementById('saveAvatarBtn').addEventListener('click', () => {
    if(gs.pendingRemovePhoto) gs.playerProfilePic = null;
    else if(gs.pendingProfilePic) gs.playerProfilePic = gs.pendingProfilePic;
    gs.pendingProfilePic = null; gs.pendingRemovePhoto = false;
    updateHUD(); updateProfileDisplay(); saveGameState();
    closeModal('avatarModal'); showNotification('Profile picture updated!','info');
  });

  document.getElementById('saveThemeBtn').addEventListener('click', () => {
    if(gs.pendingThemeColor) { gs.settings.themeColor=gs.pendingThemeColor; applyThemeColor(gs.pendingThemeColor); saveGameState(); }
    closeModal('themeModal'); showNotification('Theme saved!','info');
  });

  document.getElementById('darkModeToggle').addEventListener('change', function() {
    gs.settings.darkMode = this.checked; applyDarkMode(this.checked); saveGameState();
  });
  document.getElementById('soundEffectsToggle').addEventListener('change', function() { gs.settings.soundEffects=this.checked; saveGameState(); });
  document.getElementById('musicToggle').addEventListener('change', function() { gs.settings.music=this.checked; saveGameState(); });

  // Modal close handlers
  document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => { if(e.target===m) closeModal(m.id); });
  });
  document.querySelectorAll('.modal').forEach(m => { m.addEventListener('click', e => e.stopPropagation()); });
  document.addEventListener('keydown', e => {
    if(e.key==='Escape') { const active=document.querySelector('.modal-overlay.active'); if(active) closeModal(active.id); }
  });
  window.addEventListener('blur', () => { if(gs.isGameActive && !document.querySelector('.modal-overlay.active')) pauseGame(); });
}

// Expose globals
window.openModal = openModal;
window.closeModal = closeModal;
window.removePlayer = removePlayer;
window.quickJoinRoom = quickJoinRoom;
window.confirmResetStats = confirmResetStats;
window.updateNavigation = updateNavigation;
</script>
</body>
</html>
